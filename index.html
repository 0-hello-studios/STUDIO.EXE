<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BEAT.EXE â€” Step Sequencer</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&family=Syne:wght@400;700;800&display=swap');
:root{--bg:#0b0b0e;--surface:#121216;--surface2:#1a1a20;--border:#2a2a33;--border-light:#3a3a44;--text:#c8c8d0;--text-dim:#55555e;--accent:#e8364f;--accent-glow:rgba(232,54,79,0.25);--kick:#e8364f;--snare:#f59e0b;--hihat:#22d3ee;--clap:#a855f7;--tom:#f97316;--perc:#06b6d4;--bass:#10b981;--synth:#ec4899}
*{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;overflow-x:hidden;user-select:none;-webkit-user-select:none}body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:1000}
.header{padding:20px 28px 0;display:flex;align-items:center;gap:16px;flex-wrap:wrap}.header h1{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;color:#fff;letter-spacing:-0.5px}.header h1 span{color:var(--accent)}.header .tag{font-size:10px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;border:1px solid var(--border);padding:3px 10px;border-radius:3px}
.transport{padding:14px 28px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}.tbtn{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:16px;width:38px;height:34px;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}.tbtn:hover{border-color:var(--accent);background:var(--surface2)}.tbtn.playing{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 16px var(--accent-glow)}.sep{width:1px;height:24px;background:var(--border);margin:0 3px;flex-shrink:0}.kg{display:flex;align-items:center;gap:5px}.kg label{font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;white-space:nowrap}.kg input[type="range"]{-webkit-appearance:none;appearance:none;width:70px;height:3px;background:var(--border);border-radius:2px;outline:none}.kg input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 6px var(--accent-glow)}.kv{font-size:10px;color:var(--accent);font-weight:700;min-width:26px;text-align:right}.pbtn{background:var(--surface);border:1px solid var(--border);color:var(--text-dim);font-family:inherit;font-size:10px;font-weight:500;padding:5px 10px;border-radius:3px;cursor:pointer;transition:all .15s;letter-spacing:.3px;white-space:nowrap}.pbtn:hover{border-color:var(--accent);color:var(--text)}.export-btn{background:var(--surface);border:1px solid #10b981;color:#10b981;font-family:inherit;font-size:10px;font-weight:700;padding:5px 12px;border-radius:3px;cursor:pointer;transition:all .15s;letter-spacing:.5px;white-space:nowrap}.export-btn:hover{background:#10b981;color:#fff;box-shadow:0 0 16px rgba(16,185,129,0.3)}
.grid-wrap{padding:0 28px;overflow-x:auto}.grid{display:flex;flex-direction:column;gap:2px;min-width:fit-content}.channel-row{display:flex;align-items:center;gap:2px;height:38px}.ch-label{width:200px;min-width:200px;display:flex;align-items:center;gap:4px;padding-right:6px;flex-shrink:0}.ch-name{font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;width:40px;text-align:right}.ch-mute,.ch-solo{width:15px;height:15px;border-radius:2px;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:7px;color:var(--text-dim);transition:all .1s;flex-shrink:0}.ch-mute.muted{background:#ef4444;border-color:#ef4444;color:#fff}.ch-solo.soloed{background:#f59e0b;border-color:#f59e0b;color:#fff}.ch-knob{-webkit-appearance:none;appearance:none;width:40px;height:2px;background:var(--border);border-radius:1px;outline:none;flex-shrink:0}.ch-knob::-webkit-slider-thumb{-webkit-appearance:none;width:7px;height:7px;border-radius:50%;background:var(--text-dim);cursor:pointer}.ch-key{font-size:8px;color:var(--text-dim);width:12px;text-align:center;flex-shrink:0;border:1px solid var(--border);border-radius:2px;padding:1px 0;line-height:1}.ch-key.flash{background:var(--accent);border-color:var(--accent);color:#fff}
.step{width:40px;min-width:40px;height:38px;background:var(--surface);border:1px solid var(--border);border-radius:3px;cursor:pointer;transition:background .06s,border-color .06s,box-shadow .06s}.step:hover{background:#1e1e28;border-color:var(--border-light)}.step.on{border-color:var(--ch-color,var(--accent));background:var(--ch-color,var(--accent));opacity:.85;box-shadow:0 0 6px var(--ch-glow,var(--accent-glow))}.step.on:hover{opacity:1}.step.current{box-shadow:inset 0 -3px 0 var(--accent),0 0 10px rgba(232,54,79,0.15)}.step.beat-marker{border-top:2px solid var(--border-light)}.step-numbers{display:flex;align-items:center;gap:2px;height:16px;margin-bottom:2px}.step-numbers .spacer{width:140px;min-width:140px;flex-shrink:0}.step-num{width:40px;min-width:40px;text-align:center;font-size:8px;color:var(--text-dim)}.step-num.beat{color:var(--text);font-weight:700}
.fx-rack{padding:12px 28px;display:flex;gap:10px;flex-wrap:wrap}.fx-module{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:10px 14px;display:flex;flex-direction:column;gap:6px;min-width:140px;transition:border-color .15s}.fx-module.active{border-color:var(--accent)}.fx-header{display:flex;align-items:center;justify-content:space-between;gap:8px}.fx-title{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim)}.fx-toggle{width:28px;height:14px;background:var(--border);border-radius:7px;position:relative;cursor:pointer;transition:background .2s;border:none}.fx-toggle::after{content:'';position:absolute;top:2px;left:2px;width:10px;height:10px;border-radius:50%;background:var(--text-dim);transition:all .2s}.fx-toggle.on{background:var(--accent)}.fx-toggle.on::after{left:16px;background:#fff}.fx-knob-row{display:flex;gap:10px}.fx-knob{display:flex;flex-direction:column;align-items:center;gap:3px}.fx-knob label{font-size:8px;color:var(--text-dim);letter-spacing:.5px;text-transform:uppercase}.fx-knob input[type="range"]{-webkit-appearance:none;appearance:none;width:50px;height:3px;background:var(--border);border-radius:2px;outline:none}.fx-knob input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;border-radius:50%;background:var(--text-dim);cursor:pointer}.fx-module.active .fx-knob input[type="range"]::-webkit-slider-thumb{background:var(--accent)}
.viz-section{padding:10px 28px;display:flex;gap:10px;flex-wrap:wrap}.viz-box{flex:1;min-width:180px;background:var(--surface);border:1px solid var(--border);border-radius:5px;height:70px;position:relative;overflow:hidden}.viz-box canvas{width:100%;height:100%}.viz-box::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.01) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.01) 1px,transparent 1px);background-size:20px 20px;pointer-events:none}.viz-label{position:absolute;top:5px;left:8px;font-size:8px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;pointer-events:none}
.bottom-bar{padding:8px 28px 16px;display:flex;gap:16px;flex-wrap:wrap;align-items:center}.stat{display:flex;align-items:baseline;gap:5px}.stat-label{font-size:8px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase}.stat-value{font-size:13px;font-weight:700;color:#fff;font-variant-numeric:tabular-nums}.spacer{flex:1}.key-hint{font-size:9px;color:var(--text-dim)}.key-hint kbd{color:var(--accent);font-weight:700;border:1px solid var(--border);padding:1px 4px;border-radius:2px;font-size:8px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:500}.modal-overlay.show{display:flex}.modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;max-width:380px;width:90%}.modal h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#fff;margin-bottom:16px}.modal-row{display:flex;align-items:center;gap:8px;margin-bottom:12px}.modal-row label{font-size:10px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;min-width:60px}.modal-row select,.modal-row input{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11px;padding:5px 8px;border-radius:3px;outline:none;flex:1}.modal-actions{display:flex;gap:8px;margin-top:16px}.modal-actions button{font-family:inherit;font-size:11px;font-weight:700;padding:8px 16px;border-radius:4px;cursor:pointer;border:1px solid var(--border);transition:all .15s}.modal-export{background:#10b981!important;border-color:#10b981!important;color:#fff;box-shadow:0 0 12px rgba(16,185,129,0.3)}.modal-export:hover{box-shadow:0 0 20px rgba(16,185,129,0.4)}.modal-export:disabled{opacity:.5;cursor:not-allowed}.modal-cancel{background:var(--surface2);color:var(--text-dim)}.modal-cancel:hover{color:var(--text)}.export-progress{margin-top:12px;height:4px;background:var(--border);border-radius:2px;overflow:hidden;display:none}.export-progress .bar{height:100%;background:#10b981;border-radius:2px;width:0%;transition:width .1s}
.step-toggle{display:flex;border:1px solid var(--border);border-radius:3px;overflow:hidden}.step-toggle button{background:var(--surface);border:none;color:var(--text-dim);font-family:inherit;font-size:9px;font-weight:700;padding:4px 10px;cursor:pointer;transition:all .15s}.step-toggle button.active{background:var(--accent);color:#fff}.step-toggle button:first-child{border-right:1px solid var(--border)}
.ch-sound{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:2px 3px;border-radius:2px;outline:none;width:60px;min-width:60px;flex-shrink:0;cursor:pointer}.ch-sound:focus{border-color:var(--accent)}
.steps-container{display:flex;gap:2px;flex:1;min-width:0}
.step{width:auto;min-width:0;flex:1 1 0}
.grid.compact .channel-row{height:24px}
.grid.compact .step{height:24px}
.grid.compact .ch-name{font-size:7px}
.grid.compact .ch-mute,.grid.compact .ch-solo{width:12px;height:12px;font-size:5px}
.grid.compact .ch-knob{width:24px}
.grid.compact .ch-sound{font-size:6px;width:52px;min-width:52px;padding:1px 2px}
.grid.compact .ch-label{width:170px;min-width:170px;gap:2px}
.grid.compact .ch-key{font-size:6px;width:9px}
.step-num{flex:1 1 0;width:auto;min-width:0}
.step-numbers .spacer{width:140px;min-width:140px}
@media(max-width:768px){.header,.transport,.grid-wrap,.fx-rack,.viz-section,.bottom-bar{padding-left:12px;padding-right:12px}.step{width:30px;min-width:30px;height:30px}.step-num{width:30px;min-width:30px}.ch-label{width:100px;min-width:100px}}
</style>
</head>
<body>
<div class="header"><h1>BEAT<span>.EXE</span></h1><div class="tag">Step Sequencer</div></div>
<div class="transport">
<button class="tbtn" id="playBtn" title="Play/Pause">&#9654;</button>
<button class="tbtn" id="stopBtn" title="Stop">&#9632;</button>
<div class="sep"></div>
<div class="kg"><label>BPM</label><input type="range" id="bpmSlider" min="40" max="220" value="120"><span class="kv" id="bpmVal">120</span></div>
<div class="kg"><label>Swing</label><input type="range" id="swingSlider" min="0" max="80" value="0"><span class="kv" id="swingVal">0%</span></div>
<div class="kg"><label>Vol</label><input type="range" id="masterVol" min="0" max="100" value="75"><span class="kv" id="masterVolVal">75</span></div>
<div class="sep"></div>
<button class="pbtn" id="clearBtn">Clear</button>
<div class="sep"></div>
<button class="pbtn" onclick="loadPreset('hiphop')">Hip-Hop</button>
<button class="pbtn" onclick="loadPreset('house')">House</button>
<button class="pbtn" onclick="loadPreset('trap')">Trap</button>
<button class="pbtn" onclick="loadPreset('dnb')">DnB</button>
<button class="pbtn" onclick="loadPreset('lofi')">Lo-Fi</button>
<div class="sep"></div>
<div class="step-toggle" id="chToggle"><button class="active" data-ch="8">8 CH</button><button data-ch="16">16 CH</button></div><div class="sep"></div><div class="step-toggle" id="stepToggle"><button class="active" data-steps="16">16</button><button data-steps="32">32</button></div>
<div class="sep"></div>
<button class="export-btn" id="exportBtn">&#8595; Export WAV</button>
</div>
<div class="grid-wrap"><div class="grid" id="grid"></div></div>
<div class="fx-rack" id="fxRack"></div>
<div class="viz-section">
<div class="viz-box"><span class="viz-label">Waveform</span><canvas id="waveCanvas"></canvas></div>
<div class="viz-box" style="max-width:260px"><span class="viz-label">Spectrum</span><canvas id="specCanvas"></canvas></div>
</div>
<div class="bottom-bar">
<div class="stat"><span class="stat-label">Step</span><span class="stat-value" id="stepDisplay">&mdash;</span></div>
<div class="stat"><span class="stat-label">Bar</span><span class="stat-value" id="barDisplay">&mdash;</span></div>
<div class="stat"><span class="stat-label">Time</span><span class="stat-value" id="timeDisplay">0:00</span></div>
<div class="spacer"></div>
<span class="key-hint"><kbd>Space</kbd> Play <kbd>Esc</kbd> Stop <kbd>Q W E R T Y U I</kbd> Live Trigger</span>
</div>
<div class="modal-overlay" id="exportModal"><div class="modal"><h3>Export WAV</h3>
<div class="modal-row"><label>Loops</label><select id="exportLoops"><option value="1">1 loop</option><option value="2">2 loops</option><option value="4" selected>4 loops</option><option value="8">8 loops</option><option value="16">16 loops</option></select></div>
<div class="modal-row"><label>Quality</label><select id="exportQuality"><option value="44100" selected>44.1 kHz</option><option value="48000">48 kHz</option></select></div>
<div class="modal-row"><label>Filename</label><input type="text" id="exportFilename" value="beat-exe-export" spellcheck="false"></div>
<div class="export-progress" id="exportProgress"><div class="bar" id="exportBar"></div></div>
<div class="modal-actions"><button class="modal-export" id="doExportBtn">&#8595; Render &amp; Download</button><button class="modal-cancel" id="cancelExportBtn">Cancel</button></div>
</div></div>
<script>
// === SOUND LIBRARY ===
const SL={
kick:{
'Kick 808':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(160,t);o.frequency.exponentialRampToValueAtTime(40,t+.12);g.gain.setValueAtTime(v*1.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4);let o2=c.createOscillator(),g2=c.createGain();o2.connect(g2);g2.connect(d);o2.type='square';o2.frequency.setValueAtTime(800,t);o2.frequency.exponentialRampToValueAtTime(100,t+.02);g2.gain.setValueAtTime(v*.4,t);g2.gain.exponentialRampToValueAtTime(.001,t+.03);o2.start(t);o2.stop(t+.03)},
'Kick Punchy':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(50,t+.06);g.gain.setValueAtTime(v*1.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},
'Kick Deep':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(30,t+.2);g.gain.setValueAtTime(v*1.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.6);o.start(t);o.stop(t+.6)},
'Kick Tight':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='triangle';o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(60,t+.04);g.gain.setValueAtTime(v*1.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)},
},
snare:{
'Snare Crack':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.15,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=1000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);n.start(t);n.stop(t+.15);let o=c.createOscillator(),g2=c.createGain();o.connect(g2);g2.connect(d);o.type='triangle';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(100,t+.05);g2.gain.setValueAtTime(v*.6,t);g2.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08)},
'Snare Tight':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.08,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=3000;f.Q.value=2;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);n.start(t);n.stop(t+.08)},
'Snare Lo-Fi':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.12,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/a.length,.5);let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='lowpass';f.frequency.value=4000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);n.start(t);n.stop(t+.12)},
},
hihat:{
'HH Closed':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.06,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=7000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.06);n.start(t);n.stop(t+.06)},
'HH Open':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.25,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=6000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);n.start(t);n.stop(t+.25)},
'HH Crispy':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.04,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=9000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);n.start(t);n.stop(t+.04)},
},
clap:{
'Clap Tight':(t,v,c,d)=>{for(let i=0;i<3;i++){let tt=t+i*.008,b=c.createBuffer(1,c.sampleRate*.03,c.sampleRate),a=b.getChannelData(0);for(let j=0;j<a.length;j++)a[j]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=2500;f.Q.value=3;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.5,tt);g.gain.exponentialRampToValueAtTime(.001,tt+.08);n.start(tt);n.stop(tt+.08)}},
'Clap Snap':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.02,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=4000;f.Q.value=5;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);n.start(t);n.stop(t+.04)},
},
tom:{
'Tom High':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(120,t+.15);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},
'Tom Mid':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(80,t+.2);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)},
'Tom Floor':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(130,t);o.frequency.exponentialRampToValueAtTime(50,t+.25);g.gain.setValueAtTime(v*.9,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35)},
},
perc:{
'Perc Click':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='triangle';o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(300,t+.05);g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08)},
'Perc Rim':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='square';o.frequency.setValueAtTime(1200,t);o.frequency.exponentialRampToValueAtTime(400,t+.02);g.gain.setValueAtTime(v*.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);o.start(t);o.stop(t+.04)},
'Perc Cowbell':(t,v,c,d)=>{let o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain();o.connect(g);o2.connect(g);g.connect(d);o.type='square';o2.type='square';o.frequency.value=587;o2.frequency.value=845;g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12);o2.start(t);o2.stop(t+.12)},
},
bass:{
'Bass Sub':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)},
'Bass Saw':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+.1);o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.7,t);g.gain.setValueAtTime(v*.7,t+.08);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},
'Bass Square':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='square';f.type='lowpass';f.frequency.setValueAtTime(600,t);f.frequency.exponentialRampToValueAtTime(150,t+.08);o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.18);o.start(t);o.stop(t+.18)},
'Bass Pluck':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(2000,t);f.frequency.exponentialRampToValueAtTime(100,t+.05);o.frequency.setValueAtTime(82,t);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)},
},
synth:{
'Synth Stab':(t,v,c,d)=>{let o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);o2.connect(f);f.connect(g);g.connect(d);o.type='square';o2.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(2000,t);f.frequency.exponentialRampToValueAtTime(300,t+.15);o.frequency.setValueAtTime(220,t);o2.frequency.setValueAtTime(221.5,t);g.gain.setValueAtTime(v*.25,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);o2.start(t);o2.stop(t+.2)},
'Synth Pluck':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(4000,t);f.frequency.exponentialRampToValueAtTime(200,t+.06);o.frequency.setValueAtTime(330,t);g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)},
'Synth Chord':(t,v,c,d)=>{[220,277,330].forEach(fr=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(1500,t);f.frequency.exponentialRampToValueAtTime(400,t+.2);o.frequency.setValueAtTime(fr,t);g.gain.setValueAtTime(v*.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.3);o.start(t);o.stop(t+.3)})},
'Synth Zap':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sawtooth';o.frequency.setValueAtTime(1200,t);o.frequency.exponentialRampToValueAtTime(100,t+.08);g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);o.start(t);o.stop(t+.1)},
},
};

let audioCtx=null,masterGain=null,analyser=null,analyserFreq=null,fxReverbGain=null,fxReverbConv=null,fxDelayNode=null,fxDelayGain=null,fxDelayFeedback=null,fxDistortion=null,fxFilter=null,dryGain=null,fxChorusDelay=null,fxChorusGain=null,fxChorusLFO=null,fxChorusLFOGain=null,fxPhaserFilters=[],fxPhaserGain=null,fxPhaserLFO=null,fxPhaserLFOGain=null,fxCompressor=null,fxCrushNode=null;
const fxState={reverb:{on:false,mix:.3,decay:.8},delay:{on:false,time:.25,feedback:.35,mix:.25},distortion:{on:false,amount:.4},filter:{on:false,freq:2000,type:'lowpass'},chorus:{on:false,rate:.8,depth:.4},phaser:{on:false,rate:.5,depth:.6},comp:{on:false,thresh:.5,ratio:.6},bitcrush:{on:false,bits:.5,rate:.4}};
function initAudio(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();masterGain=audioCtx.createGain();masterGain.gain.value=.75;analyser=audioCtx.createAnalyser();analyser.fftSize=2048;analyserFreq=audioCtx.createAnalyser();analyserFreq.fftSize=256;dryGain=audioCtx.createGain();fxReverbConv=audioCtx.createConvolver();fxReverbGain=audioCtx.createGain();fxReverbGain.gain.value=0;buildIR(.8);fxDelayNode=audioCtx.createDelay(2);fxDelayNode.delayTime.value=.25;fxDelayGain=audioCtx.createGain();fxDelayGain.gain.value=0;fxDelayFeedback=audioCtx.createGain();fxDelayFeedback.gain.value=.35;fxDistortion=audioCtx.createWaveShaper();fxFilter=audioCtx.createBiquadFilter();fxFilter.type='lowpass';fxFilter.frequency.value=20000;masterGain.connect(fxDistortion);fxDistortion.connect(fxFilter);fxFilter.connect(dryGain);dryGain.connect(analyser);fxFilter.connect(fxReverbConv);fxReverbConv.connect(fxReverbGain);fxReverbGain.connect(analyser);fxFilter.connect(fxDelayNode);fxDelayNode.connect(fxDelayGain);fxDelayGain.connect(analyser);fxDelayNode.connect(fxDelayFeedback);fxDelayFeedback.connect(fxDelayNode);// Chorus - modulated short delay
fxChorusDelay=audioCtx.createDelay(.05);fxChorusDelay.delayTime.value=.015;
fxChorusGain=audioCtx.createGain();fxChorusGain.gain.value=0;
fxChorusLFO=audioCtx.createOscillator();fxChorusLFOGain=audioCtx.createGain();
fxChorusLFO.type='sine';fxChorusLFO.frequency.value=.8;fxChorusLFOGain.gain.value=0;
fxChorusLFO.connect(fxChorusLFOGain);fxChorusLFOGain.connect(fxChorusDelay.delayTime);fxChorusLFO.start();
fxFilter.connect(fxChorusDelay);fxChorusDelay.connect(fxChorusGain);fxChorusGain.connect(analyser);
// Phaser - cascade of allpass filters
fxPhaserGain=audioCtx.createGain();fxPhaserGain.gain.value=0;
fxPhaserLFO=audioCtx.createOscillator();fxPhaserLFOGain=audioCtx.createGain();
fxPhaserLFO.type='sine';fxPhaserLFO.frequency.value=.5;fxPhaserLFOGain.gain.value=0;fxPhaserLFO.start();
let phaserInput=fxFilter;
for(let i=0;i<4;i++){const ap=audioCtx.createBiquadFilter();ap.type='allpass';ap.frequency.value=1000+i*500;ap.Q.value=.5;fxPhaserLFOGain.connect(ap.frequency);phaserInput.connect(ap);phaserInput=ap;fxPhaserFilters.push(ap)}
fxPhaserLFO.connect(fxPhaserLFOGain);phaserInput.connect(fxPhaserGain);fxPhaserGain.connect(analyser);
// Compressor
fxCompressor=audioCtx.createDynamicsCompressor();fxCompressor.threshold.value=-24;fxCompressor.knee.value=12;fxCompressor.ratio.value=4;fxCompressor.attack.value=.003;fxCompressor.release.value=.15;
// Bitcrusher via script processor (connect in chain before analyser)
analyser.connect(analyserFreq);analyserFreq.connect(fxCompressor);fxCompressor.connect(audioCtx.destination)}
function buildIR(d){if(!audioCtx)return;const r=audioCtx.sampleRate,l=r*Math.max(.1,d*2.5),b=audioCtx.createBuffer(2,l,r);for(let c=0;c<2;c++){const a=b.getChannelData(c);for(let i=0;i<l;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/l,d*3+1)}try{fxReverbConv.buffer=b}catch(e){}}
function setDist(a){const k=a*400,n=44100,c=new Float32Array(n);for(let i=0;i<n;i++){const x=(i*2)/n-1;c[i]=((3+k)*x*20*(Math.PI/180))/(Math.PI+k*Math.abs(x))}fxDistortion.curve=a>.01?c:null}
function updateFX(){if(!audioCtx)return;fxReverbGain.gain.value=fxState.reverb.on?fxState.reverb.mix:0;fxDelayGain.gain.value=fxState.delay.on?fxState.delay.mix:0;fxDelayNode.delayTime.value=fxState.delay.time;fxDelayFeedback.gain.value=fxState.delay.on?fxState.delay.feedback:0;fxState.distortion.on?setDist(fxState.distortion.amount):fxDistortion.curve=null;fxFilter.frequency.value=fxState.filter.on?fxState.filter.freq:20000;fxFilter.type=fxState.filter.type;
// Chorus
fxChorusGain.gain.value=fxState.chorus.on?fxState.chorus.depth*.5:0;
fxChorusLFOGain.gain.value=fxState.chorus.on?fxState.chorus.depth*.003:0;
fxChorusLFO.frequency.value=fxState.chorus.rate*4+.1;
// Phaser
fxPhaserGain.gain.value=fxState.phaser.on?fxState.phaser.depth*.6:0;
fxPhaserLFOGain.gain.value=fxState.phaser.on?fxState.phaser.depth*2000:0;
fxPhaserLFO.frequency.value=fxState.phaser.rate*3+.1;
// Compressor
if(fxState.comp.on){fxCompressor.threshold.value=-50+fxState.comp.thresh*40;fxCompressor.ratio.value=1+fxState.comp.ratio*19}else{fxCompressor.threshold.value=0;fxCompressor.ratio.value=1}
}

const STEPS=16,KEYS=['q','w','e','r','t','y','u','i'];
let totalSteps=16;
function GS(ch){return SL[ch.type][ch.sound]}
const channels=[{name:'Kick',type:'kick',sound:'Kick 808',key:'kick',color:'var(--kick)',glow:'rgba(232,54,79,0.3)',vol:.9,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'Snare',type:'snare',sound:'Snare Crack',key:'snare',color:'var(--snare)',glow:'rgba(245,158,11,0.3)',vol:.8,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'HiHat',type:'hihat',sound:'HH Closed',key:'hihat',color:'var(--hihat)',glow:'rgba(34,211,238,0.3)',vol:.7,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'Clap',type:'clap',sound:'Clap Tight',key:'clap',color:'var(--clap)',glow:'rgba(168,85,247,0.3)',vol:.75,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'Tom',type:'tom',sound:'Tom Mid',key:'tom',color:'var(--tom)',glow:'rgba(249,115,22,0.3)',vol:.7,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'Perc',type:'perc',sound:'Perc Click',key:'perc',color:'var(--perc)',glow:'rgba(6,182,212,0.3)',vol:.6,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'Bass',type:'bass',sound:'Bass Saw',key:'bass',color:'var(--bass)',glow:'rgba(16,185,129,0.3)',vol:.8,muted:false,solo:false,steps:new Array(32).fill(false)},{name:'Synth',type:'synth',sound:'Synth Stab',key:'synth',color:'var(--synth)',glow:'rgba(236,72,153,0.3)',vol:.5,muted:false,solo:false,steps:new Array(32).fill(false)}];
let playing=false,currentStep=-1,nextStepTime=0,timerID=null,startTimestamp=0,stepElements=[],dragState=null;
function isAudible(ci){const any=channels.some(c=>c.solo);return any?channels[ci].solo&&!channels[ci].muted:!channels[ci].muted}
function buildGrid(){const grid=document.getElementById('grid');grid.innerHTML='';stepElements=[];if(channels.length>8)grid.classList.add('compact');else grid.classList.remove('compact');const nr=document.createElement('div');nr.className='step-numbers';const sp=document.createElement('div');sp.className='spacer';sp.style.cssText=channels.length>8?'width:170px;min-width:170px':'width:200px;min-width:200px';nr.appendChild(sp);for(let s=0;s<totalSteps;s++){const n=document.createElement('div');n.className='step-num'+(s%4===0?' beat':'');n.textContent=s+1;nr.appendChild(n)}grid.appendChild(nr);channels.forEach((ch,ci)=>{const row=document.createElement('div');row.className='channel-row';const lab=document.createElement('div');lab.className='ch-label';const nm=document.createElement('span');nm.className='ch-name';nm.style.color=ch.color;nm.textContent=ch.name;const mt=document.createElement('div');mt.className='ch-mute';mt.textContent='M';mt.addEventListener('click',()=>{ch.muted=!ch.muted;mt.classList.toggle('muted',ch.muted)});const sl=document.createElement('div');sl.className='ch-solo';sl.textContent='S';sl.addEventListener('click',()=>{ch.solo=!ch.solo;sl.classList.toggle('soloed',ch.solo)});const vl=document.createElement('input');vl.type='range';vl.className='ch-knob';vl.min=0;vl.max=100;vl.value=ch.vol*100;vl.addEventListener('input',()=>{ch.vol=vl.value/100});const kh=document.createElement('div');kh.className='ch-key';kh.id='chkey-'+ci;kh.textContent=ci<KEYS.length?KEYS[ci].toUpperCase():'-';const sel=document.createElement('select');sel.className='ch-sound';Object.keys(SL[ch.type]).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if(ch.sound===s)o.selected=true;sel.appendChild(o)});sel.addEventListener('change',()=>{ch.sound=sel.value});
lab.appendChild(nm);lab.appendChild(mt);lab.appendChild(sl);lab.appendChild(vl);lab.appendChild(kh);lab.appendChild(sel);row.appendChild(lab);const sc=document.createElement('div');sc.className='steps-container';const sr=[];for(let s=0;s<totalSteps;s++){const st=document.createElement('div');st.className='step'+(s%4===0?' beat-marker':'');st.style.setProperty('--ch-color',ch.color);st.style.setProperty('--ch-glow',ch.glow);st.addEventListener('mousedown',e=>{e.preventDefault();ch.steps[s]=!ch.steps[s];st.classList.toggle('on',ch.steps[s]);if(ch.steps[s]&&isAudible(ci)){initAudio();GS(ch)(audioCtx.currentTime,ch.vol*masterGain.gain.value,audioCtx,masterGain)}dragState={value:ch.steps[s],ci}});st.addEventListener('mouseenter',()=>{if(dragState&&dragState.ci===ci){ch.steps[s]=dragState.value;st.classList.toggle('on',ch.steps[s])}});if(ch.steps[s])st.classList.add('on');sc.appendChild(st);sr.push(st)}row.appendChild(sc);stepElements.push(sr);grid.appendChild(row)})}
window.addEventListener('mouseup',()=>{dragState=null});
function buildFXRack(){const r=document.getElementById('fxRack');r.innerHTML='';r.appendChild(mkFX('Reverb','reverb',[{l:'Mix',k:'mix',mn:0,mx:100,v:30},{l:'Decay',k:'decay',mn:10,mx:100,v:80}]));r.appendChild(mkFX('Delay','delay',[{l:'Time',k:'time',mn:5,mx:100,v:50},{l:'Feed',k:'feedback',mn:0,mx:90,v:35},{l:'Mix',k:'mix',mn:0,mx:100,v:25}]));r.appendChild(mkFX('Distort','distortion',[{l:'Drive',k:'amount',mn:0,mx:100,v:40}]));r.appendChild(mkFX('Filter','filter',[{l:'Freq',k:'freq',mn:100,mx:18000,v:2000}],true));
r.appendChild(mkFX('Chorus','chorus',[{l:'Rate',k:'rate',mn:0,mx:100,v:40},{l:'Depth',k:'depth',mn:0,mx:100,v:40}]));
r.appendChild(mkFX('Phaser','phaser',[{l:'Rate',k:'rate',mn:0,mx:100,v:25},{l:'Depth',k:'depth',mn:0,mx:100,v:60}]));
r.appendChild(mkFX('Compress','comp',[{l:'Thresh',k:'thresh',mn:0,mx:100,v:50},{l:'Ratio',k:'ratio',mn:0,mx:100,v:60}]));
}
function mkFX(title,fk,knobs,hasType){const m=document.createElement('div');m.className='fx-module'+(fxState[fk].on?' active':'');const h=document.createElement('div');h.className='fx-header';const t=document.createElement('span');t.className='fx-title';t.textContent=title;const tg=document.createElement('button');tg.className='fx-toggle'+(fxState[fk].on?' on':'');tg.addEventListener('click',()=>{fxState[fk].on=!fxState[fk].on;tg.classList.toggle('on',fxState[fk].on);m.classList.toggle('active',fxState[fk].on);updateFX()});h.appendChild(t);h.appendChild(tg);m.appendChild(h);if(hasType){const tr=document.createElement('div');tr.className='fx-knob-row';const sel=document.createElement('select');sel.style.cssText='background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:9px;padding:2px 4px;border-radius:2px;outline:none';['lowpass','highpass','bandpass'].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v.toUpperCase();if(fxState.filter.type===v)o.selected=true;sel.appendChild(o)});sel.addEventListener('change',()=>{fxState.filter.type=sel.value;updateFX()});tr.appendChild(sel);m.appendChild(tr)}const kr=document.createElement('div');kr.className='fx-knob-row';knobs.forEach(k=>{const w=document.createElement('div');w.className='fx-knob';const lb=document.createElement('label');lb.textContent=k.l;const inp=document.createElement('input');inp.type='range';inp.min=k.mn;inp.max=k.mx;inp.value=k.v;inp.addEventListener('input',()=>{if(fk==='reverb'){if(k.k==='mix')fxState.reverb.mix=inp.value/100;if(k.k==='decay'){fxState.reverb.decay=inp.value/100;buildIR(fxState.reverb.decay)}}else if(fk==='delay'){if(k.k==='time')fxState.delay.time=inp.value/200;if(k.k==='feedback')fxState.delay.feedback=inp.value/100;if(k.k==='mix')fxState.delay.mix=inp.value/100}else if(fk==='distortion')fxState.distortion.amount=inp.value/100;else if(fk==='filter')fxState.filter.freq=parseInt(inp.value);else if(fk==='chorus'){if(k.k==='rate')fxState.chorus.rate=inp.value/100;if(k.k==='depth')fxState.chorus.depth=inp.value/100}else if(fk==='phaser'){if(k.k==='rate')fxState.phaser.rate=inp.value/100;if(k.k==='depth')fxState.phaser.depth=inp.value/100}else if(fk==='comp'){if(k.k==='thresh')fxState.comp.thresh=inp.value/100;if(k.k==='ratio')fxState.comp.ratio=inp.value/100}updateFX()});w.appendChild(lb);w.appendChild(inp);kr.appendChild(w)});m.appendChild(kr);return m}
function scheduler(){const bpm=parseInt(document.getElementById('bpmSlider').value),sw=parseInt(document.getElementById('swingSlider').value)/100,sd=(60/bpm)/4;while(nextStepTime<audioCtx.currentTime+.1){const step=(currentStep+1)%totalSteps;currentStep=step;let t=nextStepTime;if(step%2===1)t+=sd*sw*.5;channels.forEach((ch,ci)=>{if(ch.steps[step]&&isAudible(ci))GS(ch)(t,ch.vol*masterGain.gain.value,audioCtx,masterGain)});const s=step;setTimeout(()=>updatePH(s),(t-audioCtx.currentTime)*1000);nextStepTime+=sd}timerID=setTimeout(scheduler,25)}
function updatePH(step){stepElements.forEach(row=>{row.forEach((el,si)=>el.classList.toggle('current',si===step))});document.getElementById('stepDisplay').textContent=step+1;document.getElementById('barDisplay').textContent=Math.floor(step/4)+1+'.'+(step%4+1);const e=Math.floor(audioCtx.currentTime-startTimestamp);document.getElementById('timeDisplay').textContent=Math.floor(e/60)+':'+String(e%60).padStart(2,'0')}
function startPlay(){initAudio();if(audioCtx.state==='suspended')audioCtx.resume();if(playing)return;playing=true;currentStep=-1;nextStepTime=audioCtx.currentTime;startTimestamp=audioCtx.currentTime;document.getElementById('playBtn').classList.add('playing');document.getElementById('playBtn').innerHTML='&#10074;&#10074;';scheduler()}
function stopPlay(){playing=false;currentStep=-1;clearTimeout(timerID);document.getElementById('playBtn').classList.remove('playing');document.getElementById('playBtn').innerHTML='&#9654;';stepElements.forEach(r=>r.forEach(e=>e.classList.remove('current')));document.getElementById('stepDisplay').innerHTML='&mdash;';document.getElementById('barDisplay').innerHTML='&mdash;'}
function toggle(){playing?stopPlay():startPlay()}
document.getElementById('playBtn').addEventListener('click',toggle);
document.getElementById('stopBtn').addEventListener('click',stopPlay);
document.getElementById('clearBtn').addEventListener('click',()=>{channels.forEach(c=>c.steps.fill(false));stepElements.forEach(r=>r.forEach(e=>e.classList.remove('on')))});
document.getElementById('bpmSlider').addEventListener('input',function(){document.getElementById('bpmVal').textContent=this.value});
document.getElementById('swingSlider').addEventListener('input',function(){document.getElementById('swingVal').textContent=this.value+'%'});
document.getElementById('masterVol').addEventListener('input',function(){document.getElementById('masterVolVal').textContent=this.value;if(masterGain)masterGain.gain.value=this.value/100});
window.addEventListener('keydown',e=>{if(e.repeat)return;if(e.code==='Space'){e.preventDefault();toggle();return}if(e.code==='Escape'){stopPlay();return}const ki=KEYS.indexOf(e.key.toLowerCase());if(ki>=0&&ki<Math.min(8,channels.length)){initAudio();if(isAudible(ki))soundMap[channels[ki].key](audioCtx.currentTime,channels[ki].vol*(masterGain?masterGain.gain.value:.75));const ke=document.getElementById('chkey-'+ki);if(ke){ke.classList.add('flash');setTimeout(()=>ke.classList.remove('flash'),120)}}});
const presets={hiphop:{bpm:90,s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]]},house:{bpm:128,s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]]},trap:{bpm:140,s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]]},dnb:{bpm:174,s:[[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0],[1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0]]},lofi:{bpm:80,s:[[1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0]]}};
function loadPreset(n){const p=presets[n];if(!p)return;document.getElementById('bpmSlider').value=p.bpm;document.getElementById('bpmVal').textContent=p.bpm;channels.forEach((ch,ci)=>{ch.steps.fill(false);for(let s=0;s<Math.min(16,totalSteps);s++){ch.steps[s]=!!p.s[ci][s];if(stepElements[ci]&&stepElements[ci][s])stepElements[ci][s].classList.toggle('on',ch.steps[s])}});buildGrid()}
document.getElementById('exportBtn').addEventListener('click',()=>document.getElementById('exportModal').classList.add('show'));
document.getElementById('cancelExportBtn').addEventListener('click',()=>document.getElementById('exportModal').classList.remove('show'));
document.getElementById('doExportBtn').addEventListener('click',async()=>{const btn=document.getElementById('doExportBtn');btn.disabled=true;btn.textContent='Rendering...';const pb=document.getElementById('exportProgress'),bar=document.getElementById('exportBar');pb.style.display='block';bar.style.width='0%';const loops=parseInt(document.getElementById('exportLoops').value),sr=parseInt(document.getElementById('exportQuality').value),fn=document.getElementById('exportFilename').value||'beat',bpm=parseInt(document.getElementById('bpmSlider').value),sw=parseInt(document.getElementById('swingSlider').value)/100,sd=(60/bpm)/4,pd=sd*totalSteps,td=pd*loops+.5;const oc=new OfflineAudioContext(2,Math.ceil(td*sr),sr),og=oc.createGain();og.gain.value=masterGain?masterGain.gain.value:.75;og.connect(oc.destination);for(let lp=0;lp<loops;lp++){for(let st=0;st<totalSteps;st++){let t=lp*pd+st*sd;if(st%2===1)t+=sd*sw*.5;channels.forEach((ch,ci)=>{if(ch.steps[st]&&isAudible(ci))GS(ch)(t,ch.vol*og.gain.value,oc,og)})}bar.style.width=((lp+1)/loops*50)+'%'}bar.style.width='60%';const rb=await oc.startRendering();bar.style.width='80%';const wb=encWAV(rb);bar.style.width='100%';const url=URL.createObjectURL(wb),a=document.createElement('a');a.href=url;a.download=fn+'.wav';a.click();URL.revokeObjectURL(url);setTimeout(()=>{btn.disabled=false;btn.textContent='\u2193 Render & Download';pb.style.display='none';document.getElementById('exportModal').classList.remove('show')},500)});
function encWAV(buf){const nc=buf.numberOfChannels,sr=buf.sampleRate,bps=2,ba=nc*bps,dl=buf.length*ba,hl=44,tl=hl+dl,w=new ArrayBuffer(tl),v=new DataView(w);function ws(o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))}ws(0,'RIFF');v.setUint32(4,tl-8,true);ws(8,'WAVE');ws(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nc,true);v.setUint32(24,sr,true);v.setUint32(28,sr*ba,true);v.setUint16(32,ba,true);v.setUint16(34,16,true);ws(36,'data');v.setUint32(40,dl,true);const cd=[];for(let c=0;c<nc;c++)cd.push(buf.getChannelData(c));let o=44;for(let i=0;i<buf.length;i++)for(let c=0;c<nc;c++){let s=Math.max(-1,Math.min(1,cd[c][i]));v.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2}return new Blob([w],{type:'audio/wav'})}
const wC=document.getElementById('waveCanvas'),wX=wC.getContext('2d'),sC=document.getElementById('specCanvas'),sX=sC.getContext('2d');
function rC(){wC.width=wC.parentElement.clientWidth;wC.height=wC.parentElement.clientHeight;sC.width=sC.parentElement.clientWidth;sC.height=sC.parentElement.clientHeight}window.addEventListener('resize',rC);rC();
function dV(){requestAnimationFrame(dV);const wW=wC.width,wH=wC.height,sW=sC.width,sH=sC.height;wX.clearRect(0,0,wW,wH);if(analyser&&playing){const b=new Uint8Array(analyser.frequencyBinCount);analyser.getByteTimeDomainData(b);wX.beginPath();wX.strokeStyle='rgba(232,54,79,0.8)';wX.lineWidth=1.5;const sl=wW/b.length;let x=0;for(let i=0;i<b.length;i++){const y=(b[i]/128)*wH/2;i===0?wX.moveTo(x,y):wX.lineTo(x,y);x+=sl}wX.stroke()}else{wX.beginPath();wX.strokeStyle='rgba(255,255,255,0.04)';wX.moveTo(0,wH/2);wX.lineTo(wW,wH/2);wX.stroke()}sX.clearRect(0,0,sW,sH);if(analyserFreq&&playing){const b=new Uint8Array(analyserFreq.frequencyBinCount);analyserFreq.getByteFrequencyData(b);const bw=sW/b.length;for(let i=0;i<b.length;i++){const v=b[i]/255;sX.fillStyle='hsla('+(i/b.length*40+340)+',70%,55%,'+(0.3+v*0.7)+')';sX.fillRect(i*bw,sH-v*sH,bw+.5,v*sH)}}}dV();

document.getElementById('stepToggle').addEventListener('click',e=>{if(!e.target.dataset.steps)return;const n=parseInt(e.target.dataset.steps);if(n===totalSteps)return;totalSteps=n;document.querySelectorAll('#stepToggle button').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.steps)===n));if(playing)stopPlay();buildGrid()});

// === 16 CHANNEL MODE ===
let channelMode=8;
const baseChannels=[
  {name:'Kick',type:'kick',sound:'Kick 808',color:'var(--kick)',glow:'rgba(232,54,79,0.3)',vol:.9},
  {name:'Snare',type:'snare',sound:'Snare Crack',color:'var(--snare)',glow:'rgba(245,158,11,0.3)',vol:.8},
  {name:'HiHat',type:'hihat',sound:'HH Closed',color:'var(--hihat)',glow:'rgba(34,211,238,0.3)',vol:.7},
  {name:'Clap',type:'clap',sound:'Clap Tight',color:'var(--clap)',glow:'rgba(168,85,247,0.3)',vol:.75},
  {name:'Tom',type:'tom',sound:'Tom Mid',color:'var(--tom)',glow:'rgba(249,115,22,0.3)',vol:.7},
  {name:'Perc',type:'perc',sound:'Perc Click',color:'var(--perc)',glow:'rgba(6,182,212,0.3)',vol:.6},
  {name:'Bass',type:'bass',sound:'Bass Saw',color:'var(--bass)',glow:'rgba(16,185,129,0.3)',vol:.8},
  {name:'Synth',type:'synth',sound:'Synth Stab',color:'var(--synth)',glow:'rgba(236,72,153,0.3)',vol:.5},
];
const extraDefaults={
  kick:{sound:'Kick Punchy',vol:.85},snare:{sound:'Snare Tight',vol:.75},
  hihat:{sound:'HH Open',vol:.6},clap:{sound:'Clap Snap',vol:.7},
  tom:{sound:'Tom Floor',vol:.65},perc:{sound:'Perc Rim',vol:.55},
  bass:{sound:'Bass Sub',vol:.7},synth:{sound:'Synth Chord',vol:.45},
};
function rebuildChannels(mode){
  channelMode=mode;
  // Save existing step data
  const saved=channels.map(ch=>({type:ch.type,sound:ch.sound,steps:[...ch.steps],vol:ch.vol,muted:ch.muted,solo:ch.solo}));
  channels.length=0;
  baseChannels.forEach((bc,i)=>{
    // Find saved data for this slot
    const s=saved[i]||(saved.find(x=>x.type===bc.type));
    channels.push({name:bc.name,type:bc.type,key:bc.type,sound:s&&s.type===bc.type?s.sound:bc.sound,color:bc.color,glow:bc.glow,vol:s&&s.type===bc.type?s.vol:bc.vol,muted:s&&s.type===bc.type?s.muted:false,solo:s&&s.type===bc.type?s.solo:false,steps:s&&s.type===bc.type?s.steps:new Array(32).fill(false)});
    if(mode===16){
      const ex=extraDefaults[bc.type];
      const si=saved[i+8];
      channels.push({name:bc.name+'2',type:bc.type,key:bc.type,sound:si&&si.type===bc.type?si.sound:ex.sound,color:bc.color,glow:bc.glow,vol:si&&si.type===bc.type?si.vol:ex.vol,muted:si&&si.type===bc.type?si.muted:false,solo:si&&si.type===bc.type?si.solo:false,steps:si&&si.type===bc.type?si.steps:new Array(32).fill(false)});
    }
  });
  buildGrid();
}
document.getElementById('chToggle').addEventListener('click',e=>{if(!e.target.dataset.ch)return;const n=parseInt(e.target.dataset.ch);if(n===channelMode)return;document.querySelectorAll('#chToggle button').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.ch)===n));rebuildChannels(n)});

buildGrid();buildFXRack();
</script>
</body>
</html>
