<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>STUDIO.EXE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&family=Syne:wght@400;700;800&display=swap');
:root{--bg:#08080b;--surface:#111115;--s2:#18181e;--s3:#1f1f27;--border:#252530;--bl:#35354a;--text:#c8c8d0;--dim:#4a4a58;--accent:#e8364f;--ag:rgba(232,54,79,.25);--a2:#22d3ee;--a2g:rgba(34,211,238,.25);--green:#10b981;--purple:#a855f7;--orange:#f59e0b;--kick:#e8364f;--snare:#f59e0b;--hihat:#22d3ee;--clap:#a855f7;--tom:#f97316;--perc:#06b6d4;--bass:#10b981;--synth:#ec4899;--ch1:#e8364f;--ch2:#22d3ee;--ch3:#a855f7;--ch4:#10b981}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;height:100vh;overflow:hidden;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;display:flex;flex-direction:column}
.workspace{flex:1;position:relative;overflow:auto;background:var(--bg)}
.ws-inner{position:relative;min-width:3000px;min-height:2000px;background-image:radial-gradient(circle,rgba(255,255,255,.04) 1px,transparent 1px);background-size:24px 24px}
.topbar{display:flex;align-items:center;height:36px;padding:0 10px;gap:6px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface);z-index:100}
.topbar h1{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;color:#fff;letter-spacing:-.5px}
.topbar h1 span{color:var(--accent)}
.sep{width:1px;height:16px;background:var(--border);margin:0 1px;flex-shrink:0}
.abtn{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:700;padding:2px 7px;border-radius:3px;cursor:pointer;transition:all .15s;letter-spacing:.4px;display:flex;align-items:center;gap:3px;-webkit-touch-callout:none;touch-action:manipulation}
.abtn:hover{border-color:var(--dim);color:var(--text)}
.abtn .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.xbtn{background:var(--s2);border:1px solid var(--green);color:var(--green);font-family:inherit;font-size:7px;font-weight:700;padding:2px 7px;border-radius:3px;cursor:pointer;transition:all .15s}
.xbtn:hover{background:var(--green);color:#fff}
.spacer{flex:1}
.ch-tabs{display:flex;gap:2px}
.chtab{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:7px;font-weight:700;padding:2px 8px;border-radius:3px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:3px}
.chtab .cdot{width:5px;height:5px;border-radius:50%}
.chtab.active{color:#fff;background:var(--s3);border-color:var(--bl)}
.win{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.5);min-width:200px;min-height:80px;z-index:10}
.win.focused{z-index:50;border-color:var(--bl);box-shadow:0 8px 36px rgba(0,0,0,.7)}
.win.hidden{display:none}
.wh{display:flex;align-items:center;padding:0 8px;height:26px;gap:5px;cursor:move;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--s2);border-radius:6px 6px 0 0}
.wc{width:3px;height:12px;border-radius:2px;flex-shrink:0}
.wt{font-family:'Syne',sans-serif;font-weight:800;font-size:10px;color:#fff;letter-spacing:-.3px}.wt span{opacity:.5}
.wtag{font-size:6px;color:var(--dim);letter-spacing:1px;text-transform:uppercase}
.wsel{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:1px 2px;border-radius:2px;outline:none;cursor:pointer}
.wctrls{margin-left:auto;display:flex;gap:2px}
.wb{background:none;border:1px solid var(--border);color:var(--dim);font-size:7px;font-weight:700;width:16px;height:14px;border-radius:2px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;padding:0}
.wb:hover{border-color:var(--dim);color:var(--text)}
.wb.close:hover{border-color:#ef4444;color:#ef4444}
.wb.kb{font-size:9px;width:20px}
.wb.kb.active{border-color:var(--accent);color:var(--accent);background:rgba(232,54,79,.1)}
.wbadge{position:absolute;top:-1px;right:28px;font-size:5px;font-weight:700;padding:1px 4px;border-radius:0 0 3px 3px;color:#fff;letter-spacing:.5px}
.wbody{flex:1;overflow:auto;padding:6px 8px}
.win.collapsed .wbody{display:none}
.win.collapsed{min-height:auto!important;height:auto!important}
.win.collapsed .wh{border-radius:6px;border-bottom:none}
.wresize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:nwse-resize}
.wresize::after{content:'';position:absolute;bottom:3px;right:3px;width:5px;height:5px;border-right:2px solid var(--bl);border-bottom:2px solid var(--bl)}
.bg{display:flex;flex-direction:column;gap:1px}
.br{display:flex;align-items:center;gap:1px;height:24px}
.bl{width:130px;min-width:130px;display:flex;align-items:center;gap:2px;padding-right:2px;flex-shrink:0}
.bn{font-size:6px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;width:28px;text-align:right}
.bm,.bs_btn{width:11px;height:11px;border-radius:2px;border:1px solid var(--border);background:var(--s2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:5px;color:var(--dim);transition:all .1s;flex-shrink:0}
.bm.muted{background:#ef4444;border-color:#ef4444;color:#fff}
.bs_btn.soloed{background:#f59e0b;border-color:#f59e0b;color:#fff}
.bv{-webkit-appearance:none;width:22px;height:2px;background:var(--border);border-radius:1px;outline:none;flex-shrink:0}
.bv::-webkit-slider-thumb{-webkit-appearance:none;width:5px;height:5px;border-radius:50%;background:var(--dim);cursor:pointer}
.bsel{background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:6px;padding:1px 2px;border-radius:2px;outline:none;width:46px;flex-shrink:0;cursor:pointer}
.bsteps{display:flex;gap:1px;flex:1;min-width:0}
.bstep{flex:1 1 0;height:24px;background:var(--s2);border:1px solid var(--border);border-radius:2px;cursor:pointer;transition:background .05s;-webkit-touch-callout:none;touch-action:manipulation}
.bstep:hover{background:var(--s3)}
.bstep.on{opacity:.85}.bstep.on:hover{opacity:1}
.bstep.current{box-shadow:inset 0 -2px 0 var(--accent)}
.bstep.bm4{border-top:2px solid var(--bl)}
.bnums{display:flex;gap:1px;height:10px;padding-left:130px}
.bnum{flex:1 1 0;text-align:center;font-size:5px;color:var(--dim)}
.bnum.bb{color:var(--text);font-weight:700}
.bcfg{display:flex;gap:3px;align-items:center;padding:0 0 4px;flex-wrap:wrap}
.stog{display:flex;border:1px solid var(--border);border-radius:3px;overflow:hidden}
.stog button{background:var(--s2);border:none;color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:2px 6px;cursor:pointer;transition:all .15s}
.stog button.active{background:var(--accent);color:#fff}
.stog button+button{border-left:1px solid var(--border)}
.pbtn{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:500;padding:2px 6px;border-radius:3px;cursor:pointer;transition:all .15s}
.pbtn:hover{border-color:var(--accent);color:var(--text)}
.st{display:flex;gap:6px;flex-wrap:wrap}
.ss{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:5px 7px;display:flex;flex-direction:column;gap:3px;min-width:90px;flex:1}
.sst{font-size:6px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--a2)}
.skr{display:flex;gap:5px;flex-wrap:wrap}
.sk{display:flex;flex-direction:column;align-items:center;gap:1px}
.sk label{font-size:5px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase}
.sk input[type="range"]{-webkit-appearance:none;width:36px;height:2px;background:var(--border);border-radius:2px;outline:none}
.sk input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:7px;height:7px;border-radius:50%;background:var(--a2);cursor:pointer}
.sk .kv{font-size:5px;color:var(--a2);font-weight:700}
.sws{display:flex;gap:2px}
.swb{background:var(--s3);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:2px 5px;border-radius:2px;cursor:pointer;transition:all .12s}
.swb.active{background:var(--a2);border-color:var(--a2);color:#fff}
.skb{display:flex;position:relative;height:60px;margin-top:4px;border-radius:3px;overflow:hidden;border:1px solid var(--border)}
.swk{flex:1;background:#e8e8ec;border-right:1px solid #c0c0c8;cursor:pointer;transition:background .06s;position:relative;z-index:1;border-radius:0 0 2px 2px}
.swk:last-child{border-right:none}.swk:hover{background:#d0d0d8}.swk.active{background:var(--a2)}
.swk .kl{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:5px;color:#888;font-weight:700}
.sbk{position:absolute;top:0;width:7%;height:55%;background:#1a1a22;border:1px solid #000;border-top:none;z-index:2;cursor:pointer;transition:background .06s;border-radius:0 0 2px 2px}
.sbk:hover{background:#333}.sbk.active{background:var(--a2)}
.fxg{display:flex;gap:4px;flex-wrap:wrap}
.fxu{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:5px 6px;display:flex;flex-direction:column;gap:3px;min-width:90px;flex:1;transition:border-color .15s}
.fxu.active{border-color:var(--purple)}
.fxh{display:flex;align-items:center;justify-content:space-between;gap:3px}
.fxn{font-size:6px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--dim)}
.fxu.active .fxn{color:var(--purple)}
.fxsw{width:22px;height:11px;background:var(--border);border-radius:6px;position:relative;cursor:pointer;transition:background .2s;border:none;flex-shrink:0}
.fxsw::after{content:'';position:absolute;top:2px;left:2px;width:7px;height:7px;border-radius:50%;background:var(--dim);transition:all .2s}
.fxsw.on{background:var(--purple)}.fxsw.on::after{left:13px;background:#fff}
.fxks{display:flex;gap:4px}
.fxk{display:flex;flex-direction:column;align-items:center;gap:1px}
.fxk label{font-size:5px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase}
.fxk input[type="range"]{-webkit-appearance:none;width:34px;height:2px;background:var(--border);border-radius:2px;outline:none}
.fxk input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:7px;height:7px;border-radius:50%;background:var(--dim);cursor:pointer}
.fxu.active .fxk input[type="range"]::-webkit-slider-thumb{background:var(--purple)}
/* === PIANO === */
.piano-kb{display:flex;position:relative;height:90px;border:1px solid var(--border);border-radius:3px;overflow-x:auto;overflow-y:hidden;min-width:0}
.pk-w{min-width:22px;flex:1;background:#e8e8ec;border-right:1px solid #c0c0c8;cursor:pointer;transition:background .05s;position:relative;z-index:1;-webkit-touch-callout:none;-webkit-user-select:none;touch-action:manipulation}
.pk-w:last-child{border-right:none}.pk-w:hover{background:#d0d0d8}.pk-w.active{background:#f472b6}
.pk-w .pkl{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:5px;color:#999;font-weight:700}
.pk-b{position:absolute;top:0;width:14px;height:55%;background:#1a1a22;border:1px solid #000;border-top:none;z-index:2;cursor:pointer;border-radius:0 0 2px 2px;-webkit-touch-callout:none;-webkit-user-select:none;touch-action:manipulation}
.pk-b:hover{background:#333}.pk-b.active{background:#f472b6}
.piano-ctrl{display:flex;gap:6px;align-items:center;margin-bottom:4px;flex-wrap:wrap}
.piano-ctrl .sst{color:#f472b6}
/* === NOTE / PIANO ROLL === */
.nr-wrap{position:relative;overflow:auto;border:1px solid var(--border);border-radius:3px;background:var(--s2)}
.nr-grid{display:grid;gap:0}
.nr-label{font-size:5px;color:var(--dim);padding:0 3px;display:flex;align-items:center;border-right:1px solid var(--border);background:var(--s2);position:sticky;left:0;z-index:2;min-width:28px}
.nr-cell{height:14px;border:1px solid rgba(255,255,255,.03);cursor:pointer;transition:background .05s}
.nr-cell:hover{background:rgba(255,255,255,.06)}
.nr-cell.on{border-radius:1px}
.nr-cell.current{box-shadow:inset 0 0 0 1px rgba(232,54,79,.4)}
.nr-cell.bar{border-left:1px solid rgba(255,255,255,.08)}
/* === BASS === */
.bass-ctrl{display:flex;gap:6px;flex-wrap:wrap}
.bass-sec{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:5px 7px;flex:1;min-width:90px}
.bass-sec .sst{color:#818cf8}
/* === SAMPLE === */
.smp-drop{border:2px dashed var(--border);border-radius:4px;padding:12px;text-align:center;font-size:7px;color:var(--dim);cursor:pointer;transition:border-color .2s;min-height:40px;display:flex;align-items:center;justify-content:center}
.smp-drop:hover,.smp-drop.over{border-color:var(--a2);color:var(--text)}
.smp-slots{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.smp-slot{background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:4px 6px;font-size:6px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:3px;min-width:60px}
.smp-slot:hover{border-color:var(--a2)}.smp-slot.playing{border-color:var(--accent);background:rgba(232,54,79,.1)}
.smp-slot .smp-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.smp-slot .smp-x{color:var(--dim);font-weight:700;cursor:pointer}.smp-slot .smp-x:hover{color:#ef4444}
/* === TAPE === */
.tape-viz{height:50px;background:var(--s2);border:1px solid var(--border);border-radius:3px;position:relative;overflow:hidden}
.tape-viz canvas{width:100%;height:100%}
.tape-btns{display:flex;gap:3px;margin-top:6px}
.tape-btn{background:var(--s2);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:8px;font-weight:700;padding:3px 10px;border-radius:3px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:3px}
.tape-btn:hover{border-color:var(--dim);color:var(--text)}
.tape-btn.rec{border-color:#ef4444;color:#ef4444}.tape-btn.rec:hover{background:#ef4444;color:#fff}
.tape-btn.rec.active{background:#ef4444;color:#fff;animation:pulse .8s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.mxchs{display:flex;gap:5px}
.mxch{background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:6px;min-width:140px;flex:1;display:flex;flex-direction:column;gap:4px}
.mxhd{display:flex;align-items:center;gap:4px}
.mxdot{width:7px;height:7px;border-radius:50%}
.mxnm{font-size:7px;font-weight:700;color:#fff}
.mxtr{display:flex;gap:2px}
.mxb{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:10px;width:22px;height:20px;border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.mxb:hover{border-color:var(--accent)}
.mxb.playing{background:var(--accent);border-color:var(--accent);color:#fff}
.mxr{display:flex;align-items:center;gap:3px}
.mxr label{font-size:5px;color:var(--dim);letter-spacing:.8px;text-transform:uppercase;width:20px}
.mxr input[type="range"]{-webkit-appearance:none;flex:1;height:2px;background:var(--border);border-radius:2px;outline:none}
.mxr input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:7px;height:7px;border-radius:50%;cursor:pointer}
.mxv{font-size:6px;font-weight:700;min-width:16px;text-align:right}
.mxms{display:flex;gap:2px;margin-top:2px}
.mxmb{background:var(--s3);border:1px solid var(--border);color:var(--dim);font-family:inherit;font-size:6px;font-weight:700;padding:2px 5px;border-radius:2px;cursor:pointer;transition:all .12s}
.mxmb.muted{background:#ef4444;border-color:#ef4444;color:#fff}
.mxmb.soloed{background:#f59e0b;border-color:#f59e0b;color:#fff}
.vizr{display:flex;gap:4px;margin-top:4px}
.vizb{flex:1;min-width:70px;background:var(--s2);border:1px solid var(--border);border-radius:3px;height:44px;position:relative;overflow:hidden}
.vizb canvas{width:100%;height:100%}
.vizl{position:absolute;top:2px;left:4px;font-size:5px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;pointer-events:none}
.bl{width:210px;min-width:210px;display:flex;align-items:center;gap:2px;padding-right:2px}
.bn{font-size:5px;font-weight:700;letter-spacing:.5px;width:28px;min-width:28px}
.bs_btn{font-family:inherit;font-size:5px;font-weight:700;color:var(--dim);background:var(--s3);border:1px solid var(--border);border-radius:2px;width:12px;height:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .1s}
.bs_btn.soloed{background:#f59e0b!important;color:#000!important;border-color:#f59e0b!important}
.bsel{background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:5px;padding:0 1px;border-radius:2px;width:38px;outline:none}
::-webkit-scrollbar{width:5px;height:7px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bl);border-radius:3px}::-webkit-scrollbar-corner{background:var(--bg)}
/* iOS long-press prevention */
button,select,input,.key,.bkey,.pk-w,.pk-b,.bstep,.wh,.wresize{-webkit-touch-callout:none;-webkit-user-select:none;touch-action:manipulation}
/* Mobile */
@media(max-width:768px){
  .topbar{height:auto;flex-wrap:wrap;padding:4px 6px;gap:3px}
  .topbar h1{font-size:13px}
  .abtn{font-size:6px;padding:3px 6px}
  .xbtn{font-size:6px;padding:3px 6px}
  .chtab{font-size:6px;padding:3px 6px}
  .sep{display:none}
  .spacer{display:none}
  .ch-tabs{flex-wrap:wrap}
  .ws-inner{min-width:1500px;min-height:1200px}
  .win{min-width:160px}
  .wh{height:30px;padding:0 6px}
  .wt{font-size:9px}
  .key,.bkey{min-width:28px!important}
  .bstep{min-width:20px!important;min-height:20px!important}
  .bl{width:160px;min-width:160px}
  input[type="range"]{height:20px}
  .wresize{width:16px;height:16px}
}
@media(max-width:480px){
  .topbar h1{font-size:11px}
  .abtn,.xbtn,.chtab{font-size:5.5px;padding:2px 4px}
  .win{min-width:140px}
  .key,.bkey{min-width:24px!important}
  .bl{width:120px;min-width:120px}
}
</style>
<script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
</head>
<body>
<div class="topbar">
<h1>STUDIO<span>.EXE</span></h1><div class="sep"></div>
<div class="ch-tabs" id="chTabs">
<button class="chtab active" data-ch="all">ALL</button>
<button class="chtab" data-ch="0"><span class="cdot" style="background:var(--ch1)"></span>CH1</button>
<button class="chtab" data-ch="1"><span class="cdot" style="background:var(--ch2)"></span>CH2</button>
<button class="chtab" data-ch="2"><span class="cdot" style="background:var(--ch3)"></span>CH3</button>
<button class="chtab" data-ch="3"><span class="cdot" style="background:var(--ch4)"></span>CH4</button>
</div><div class="sep"></div>
<button class="abtn" id="addBeat"><span class="dot" style="background:var(--accent)"></span>+BEAT</button>
<button class="abtn" id="addSynth"><span class="dot" style="background:var(--a2)"></span>+SYNTH</button>
<button class="abtn" id="addPiano"><span class="dot" style="background:#f472b6"></span>+PIANO</button>
<button class="abtn" id="addBass"><span class="dot" style="background:#818cf8"></span>+BASS</button>
<button class="abtn" id="addNote"><span class="dot" style="background:#fbbf24"></span>+NOTE</button>
<button class="abtn" id="addSample"><span class="dot" style="background:#34d399"></span>+SAMPLE</button>
<button class="abtn" id="addTape"><span class="dot" style="background:#fb923c"></span>+TAPE</button>
<button class="abtn" id="addDrum"><span class="dot" style="background:#f97316"></span>+DRUM</button>
<button class="abtn" id="addChord"><span class="dot" style="background:#14b8a6"></span>+CHORD</button>
<button class="abtn" id="addInst"><span class="dot" style="background:#d946ef"></span>+INST</button>
<button class="abtn" id="addEdit"><span class="dot" style="background:#06b6d4"></span>+EDIT</button>
<button class="abtn" id="addFx"><span class="dot" style="background:var(--purple)"></span>+FX</button>
<button class="abtn" id="addMixer"><span class="dot" style="background:var(--green)"></span>+MIXER</button>
<div class="spacer"></div>
<div id="recInd" style="display:none;align-items:center;gap:4px;font-size:7px;font-weight:700;color:#ef4444;letter-spacing:.5px"><span style="width:6px;height:6px;border-radius:50%;background:#ef4444;animation:pulse .8s infinite"></span>REC <span id="recTime" style="color:var(--dim)">0:00</span></div>
<button class="xbtn" id="recBtn" style="border-color:#ef4444;color:#ef4444">● REC</button>
<button class="xbtn" id="dlBtn" style="display:none">↓ WAV</button>
<button class="abtn" id="addSave"><span class="dot" style="background:#10b981"></span>+SAVE</button>
<button class="xbtn" id="settingsBtn" style="border-color:var(--dim);color:var(--dim)">⚙</button>
<div id="settingsPanel" style="display:none;position:fixed;top:36px;right:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px;z-index:99999;min-width:180px;box-shadow:0 8px 30px rgba(0,0,0,.6)">
<div style="font-family:'Syne',sans-serif;font-size:10px;font-weight:800;color:#fff;margin-bottom:8px;letter-spacing:1px">SETTINGS</div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px">Theme</div>
<div id="themeGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:8px"></div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px">Grid Dots</div>
<div id="dotGrid" style="display:flex;gap:4px;margin-bottom:8px"></div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px">Workspace Color</div>
<div style="display:flex;gap:4px;align-items:center;margin-bottom:8px">
<input type="color" id="wsBgColor" value="#0a0a0f" style="width:28px;height:20px;border:1px solid var(--border);border-radius:3px;background:var(--s2);cursor:pointer;padding:0">
<div id="wsBgPresets" style="display:grid;grid-template-columns:repeat(8,1fr);gap:3px;flex:1"></div>
</div>
<div style="font-size:6px;color:var(--dim);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px">Accent Color</div>
<div id="accentGrid" style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px"></div>
<div style="border-top:1px solid var(--border);margin-top:10px;padding-top:8px">
<button id="resetStudio" style="width:100%;padding:6px;background:#e8364f18;border:1px solid #e8364f40;border-radius:4px;color:#e8364f;font-family:inherit;font-size:7px;font-weight:800;letter-spacing:1px;cursor:pointer;transition:all .15s">⟳ RESET STUDIO</button>
</div>
</div>
</div>
<div class="workspace" id="workspace"><div class="ws-inner" id="wsI"></div></div>
<script>
'use strict';
// === AUDIO ENGINE ===
let ctx=null,mGain=null,anW=null,anF=null;
const CHR=['#e8364f','#22d3ee','#a855f7','#10b981'];
const chs=[{g:null,bpm:120,sw:0,vol:75,on:false,mut:false,solo:false,step:-1,nxt:0,tid:null,ts:0},{g:null,bpm:120,sw:0,vol:75,on:false,mut:false,solo:false,step:-1,nxt:0,tid:null,ts:0},{g:null,bpm:120,sw:0,vol:75,on:false,mut:false,solo:false,step:-1,nxt:0,tid:null,ts:0},{g:null,bpm:120,sw:0,vol:75,on:false,mut:false,solo:false,step:-1,nxt:0,tid:null,ts:0}];
function initA(){if(ctx)return;ctx=new(window.AudioContext||window.webkitAudioContext)();mGain=ctx.createGain();mGain.gain.value=.8;anW=ctx.createAnalyser();anW.fftSize=2048;anF=ctx.createAnalyser();anF.fftSize=256;const cp=ctx.createDynamicsCompressor();cp.threshold.value=-18;cp.ratio.value=4;mGain.connect(anW);anW.connect(anF);anF.connect(cp);cp.connect(ctx.destination);chs.forEach(c=>{c.g=ctx.createGain();c.g.gain.value=c.vol/100;c.g.connect(mGain)})}

// === SOUNDS ===
const SL={
kick:{'Kick 808':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(160,t);o.frequency.exponentialRampToValueAtTime(40,t+.12);g.gain.setValueAtTime(v*1.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4);let o2=c.createOscillator(),g2=c.createGain();o2.connect(g2);g2.connect(d);o2.type='square';o2.frequency.setValueAtTime(800,t);o2.frequency.exponentialRampToValueAtTime(100,t+.02);g2.gain.setValueAtTime(v*.4,t);g2.gain.exponentialRampToValueAtTime(.001,t+.03);o2.start(t);o2.stop(t+.03)},'Kick Punchy':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(50,t+.06);g.gain.setValueAtTime(v*1.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},'Kick Deep':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(30,t+.2);g.gain.setValueAtTime(v*1.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.6);o.start(t);o.stop(t+.6)},'Kick Tight':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='triangle';o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(60,t+.04);g.gain.setValueAtTime(v*1.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}},
snare:{'Snare Crack':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.15,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=1000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);n.start(t);n.stop(t+.15);let o=c.createOscillator(),g2=c.createGain();o.connect(g2);g2.connect(d);o.type='triangle';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(100,t+.05);g2.gain.setValueAtTime(v*.6,t);g2.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08)},'Snare Tight':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.08,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=3000;f.Q.value=2;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);n.start(t);n.stop(t+.08)},'Snare Lo-Fi':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.12,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/a.length,.5);let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='lowpass';f.frequency.value=4000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);n.start(t);n.stop(t+.12)}},
hihat:{'HH Closed':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.06,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=7000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.06);n.start(t);n.stop(t+.06)},'HH Open':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.25,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=6000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);n.start(t);n.stop(t+.25)},'HH Crispy':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.04,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=9000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);n.start(t);n.stop(t+.04)}},
clap:{'Clap Tight':(t,v,c,d)=>{for(let i=0;i<3;i++){let tt=t+i*.008,b=c.createBuffer(1,c.sampleRate*.03,c.sampleRate),a=b.getChannelData(0);for(let j=0;j<a.length;j++)a[j]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=2500;f.Q.value=3;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.5,tt);g.gain.exponentialRampToValueAtTime(.001,tt+.08);n.start(tt);n.stop(tt+.08)}},'Clap Snap':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.02,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=4000;f.Q.value=5;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);n.start(t);n.stop(t+.04)}},
tom:{'Tom High':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(120,t+.15);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},'Tom Mid':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(80,t+.2);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)},'Tom Floor':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(130,t);o.frequency.exponentialRampToValueAtTime(50,t+.25);g.gain.setValueAtTime(v*.9,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35)}},
perc:{'Perc Click':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='triangle';o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(300,t+.05);g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08)},'Perc Rim':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='square';o.frequency.setValueAtTime(1200,t);o.frequency.exponentialRampToValueAtTime(400,t+.02);g.gain.setValueAtTime(v*.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);o.start(t);o.stop(t+.04)},'Perc Cowbell':(t,v,c,d)=>{let o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain();o.connect(g);o2.connect(g);g.connect(d);o.type='square';o2.type='square';o.frequency.value=587;o2.frequency.value=845;g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12);o2.start(t);o2.stop(t+.12)}},
bass:{'Bass Sub':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)},'Bass Saw':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+.1);o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},'Bass Square':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='square';f.type='lowpass';f.frequency.setValueAtTime(600,t);f.frequency.exponentialRampToValueAtTime(150,t+.08);o.frequency.setValueAtTime(55,t);g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.18);o.start(t);o.stop(t+.18)},'Bass Pluck':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(2000,t);f.frequency.exponentialRampToValueAtTime(100,t+.05);o.frequency.setValueAtTime(82,t);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}},
synth:{'Synth Stab':(t,v,c,d)=>{let o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);o2.connect(f);f.connect(g);g.connect(d);o.type='square';o2.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(2000,t);f.frequency.exponentialRampToValueAtTime(300,t+.15);o.frequency.setValueAtTime(220,t);o2.frequency.setValueAtTime(221.5,t);g.gain.setValueAtTime(v*.25,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);o2.start(t);o2.stop(t+.2)},'Synth Pluck':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(4000,t);f.frequency.exponentialRampToValueAtTime(200,t+.06);o.frequency.setValueAtTime(330,t);g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)},'Synth Chord':(t,v,c,d)=>{[220,277,330].forEach(fr=>{let o=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();o.connect(f);f.connect(g);g.connect(d);o.type='sawtooth';f.type='lowpass';f.frequency.setValueAtTime(1500,t);f.frequency.exponentialRampToValueAtTime(400,t+.2);o.frequency.setValueAtTime(fr,t);g.gain.setValueAtTime(v*.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.3);o.start(t);o.stop(t+.3)})},'Synth Zap':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sawtooth';o.frequency.setValueAtTime(1200,t);o.frequency.exponentialRampToValueAtTime(100,t+.08);g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);o.start(t);o.stop(t+.1)}}
};

// === WINDOW MANAGER ===
let mods=[],mid=0,topZ=10,aTab='all',_dr=null,_rs=null,_kb=null;
const ws=document.getElementById('workspace'),wsI=document.getElementById('wsI');
document.addEventListener('mousemove',e=>{
  if(_dr){const d=_dr;const wr=ws.getBoundingClientRect();const mx=e.clientX-wr.left+ws.scrollLeft,my=e.clientY-wr.top+ws.scrollTop;d.w.style.left=Math.max(0,mx-d.ox)+'px';d.w.style.top=Math.max(0,my-d.oy)+'px'}
  if(_rs){const r=_rs;r.w.style.width=Math.max(200,r.sw+(e.clientX-r.sx))+'px';r.w.style.height=Math.max(80,r.sh+(e.clientY-r.sy))+'px'}
});
document.addEventListener('mouseup',()=>{_dr=null;_rs=null});
// Touch equivalents for window drag/resize
document.addEventListener('touchmove',e=>{
  if(_dr||_rs){e.preventDefault();const t=e.touches[0];
    if(_dr){const d=_dr;const wr=ws.getBoundingClientRect();const mx=t.clientX-wr.left+ws.scrollLeft,my=t.clientY-wr.top+ws.scrollTop;d.w.style.left=Math.max(0,mx-d.ox)+'px';d.w.style.top=Math.max(0,my-d.oy)+'px'}
    if(_rs){const r=_rs;r.w.style.width=Math.max(200,r.sw+(t.clientX-r.sx))+'px';r.w.style.height=Math.max(80,r.sh+(t.clientY-r.sy))+'px'}}
},{passive:false});
document.addEventListener('touchend',()=>{_dr=null;_rs=null});
function setKb(id){_kb=_kb===id?null:id;document.querySelectorAll('.wb.kb').forEach(b=>b.classList.toggle('active',+b.dataset.mid===_kb))}
function mkW(title,tag,col,x,y,w,h,ci){
  // center on current viewport
  const ws=document.getElementById('workspace');
  const vx=ws.scrollLeft+ws.clientWidth/2-w/2;
  const vy=ws.scrollTop+ws.clientHeight/2-h/2;
  // slight random offset so stacked windows don't perfectly overlap
  const ox=(Math.random()-.5)*40, oy=(Math.random()-.5)*30;
  const fx=Math.max(0,Math.round(vx+ox)), fy=Math.max(0,Math.round(vy+oy));
  const el=document.createElement('div');el.className='win focused';el.style.cssText=`left:${fx}px;top:${fy}px;width:${w}px;height:${h}px;z-index:${++topZ}`;
  const hd=document.createElement('div');hd.className='wh';
  const sel=document.createElement('select');sel.className='wsel';
  for(let i=0;i<4;i++){const o=document.createElement('option');o.value=i;o.textContent='CH'+(i+1);if(i===ci)o.selected=true;sel.appendChild(o)}
  hd.innerHTML=`<div class="wc" style="background:${col}"></div><span class="wt">${title}</span><span class="wtag">${tag}</span>`;
  hd.appendChild(sel);
  const ct=document.createElement('div');ct.className='wctrls';ct.innerHTML=`<button class="wb min" title="Collapse">—</button><button class="wb close" title="Remove">✕</button>`;
  hd.appendChild(ct);
  const bdg=document.createElement('div');bdg.className='wbadge';bdg.style.background=CHR[ci];bdg.textContent='CH'+(ci+1);
  const bd=document.createElement('div');bd.className='wbody';
  const rsz=document.createElement('div');rsz.className='wresize';
  el.append(bdg,hd,bd,rsz);
  el.addEventListener('mousedown',()=>{document.querySelectorAll('.win').forEach(w=>w.classList.remove('focused'));el.classList.add('focused');el.style.zIndex=++topZ});
  hd.addEventListener('mousedown',e=>{if(e.target.closest('.wb')||e.target.closest('.wsel'))return;e.preventDefault();el.classList.add('focused');el.style.zIndex=++topZ;
    const wr=ws.getBoundingClientRect();
    const elX=el.offsetLeft, elY=el.offsetTop;
    const mouseWsX=e.clientX-wr.left+ws.scrollLeft, mouseWsY=e.clientY-wr.top+ws.scrollTop;
    _dr={w:el,ox:mouseWsX-elX,oy:mouseWsY-elY}});
  hd.addEventListener('touchstart',e=>{if(e.target.closest('.wb')||e.target.closest('.wsel'))return;e.preventDefault();
    el.classList.add('focused');el.style.zIndex=++topZ;
    const t=e.touches[0];const wr=ws.getBoundingClientRect();
    const mouseWsX=t.clientX-wr.left+ws.scrollLeft,mouseWsY=t.clientY-wr.top+ws.scrollTop;
    _dr={w:el,ox:mouseWsX-el.offsetLeft,oy:mouseWsY-el.offsetTop}},{passive:false});
  rsz.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();_rs={w:el,sx:e.clientX,sy:e.clientY,sw:el.offsetWidth,sh:el.offsetHeight}});
  rsz.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();const t=e.touches[0];
    _rs={w:el,sx:t.clientX,sy:t.clientY,sw:el.offsetWidth,sh:el.offsetHeight}},{passive:false});
  ct.querySelector('.min').addEventListener('click',()=>el.classList.toggle('collapsed'));
  return{el,bd,sel,bdg,ct};
}

// === TAB FILTER ===
document.getElementById('chTabs').addEventListener('click',e=>{const t=e.target.closest('.chtab');if(!t)return;aTab=t.dataset.ch;document.querySelectorAll('.chtab').forEach(x=>x.classList.toggle('active',x.dataset.ch===aTab));filt()});
function filt(){mods.forEach(m=>{if(m.ci<0)m.el.classList.remove('hidden');else m.el.classList.toggle('hidden',aTab!=='all'&&String(m.ci)!==aTab)})}

// === PER-CHANNEL TRANSPORT ===
function chMax(ci){let m=16;mods.forEach(x=>{if(x.ci===ci&&x.ts>m)m=x.ts});return m}
function chSched(ci){
  const ch=chs[ci];if(!ch.on)return;
  const bpm=ch.bpm,sw=ch.sw/100,sd=(60/bpm)/4;
  const ms=chMax(ci);
  while(ch.nxt<ctx.currentTime+.1){
    const s=(ch.step+1)%ms;ch.step=s;
    let t=ch.nxt;if(s%2===1)t+=sd*sw*.5;
    mods.forEach(m=>{if(m.ci===ci&&m.onStep)m.onStep(s,t)});
    ch.nxt+=sd;
  }
  if(ch.on)ch.tid=setTimeout(()=>chSched(ci),25);
}
function startCh(ci){initA();if(ctx.state==='suspended')ctx.resume();const ch=chs[ci];if(ch.on)return;ch.on=true;ch.step=-1;ch.nxt=ctx.currentTime;ch.ts=ctx.currentTime;
  mods.forEach(m=>{if(m.ci===ci&&m.initFx)m.initFx()});
  chSched(ci);updMx()}
function stopCh(ci){const ch=chs[ci];ch.on=false;ch.step=-1;clearTimeout(ch.tid);mods.forEach(m=>{if(m.ci===ci&&m.clr)m.clr()});updMx()}
function togCh(ci){chs[ci].on?stopCh(ci):startCh(ci)}

// === BEAT MODULE ===
const BC=[{n:'Kick',t:'kick',s:'Kick 808',c:'var(--kick)',v:.9},{n:'Snare',t:'snare',s:'Snare Crack',c:'var(--snare)',v:.8},{n:'HiHat',t:'hihat',s:'HH Closed',c:'var(--hihat)',v:.7},{n:'Clap',t:'clap',s:'Clap Tight',c:'var(--clap)',v:.75},{n:'Tom',t:'tom',s:'Tom Mid',c:'var(--tom)',v:.7},{n:'Perc',t:'perc',s:'Perc Click',c:'var(--perc)',v:.6},{n:'Bass',t:'bass',s:'Bass Saw',c:'var(--bass)',v:.8},{n:'Synth',t:'synth',s:'Synth Stab',c:'var(--synth)',v:.5}];
const BX={kick:{s:'Kick Punchy',v:.85},snare:{s:'Snare Tight',v:.75},hihat:{s:'HH Open',v:.6},clap:{s:'Clap Snap',v:.7},tom:{s:'Tom Floor',v:.65},perc:{s:'Perc Rim',v:.55},bass:{s:'Bass Sub',v:.7},synth:{s:'Synth Chord',v:.45}};

function addBeat(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('BEAT<span>.EXE</span>','Seq','var(--accent)',20+(mods.length%4)*30,20+(mods.length%4)*20,840,320,ci);
  el.id='m'+id;
  const m={id,type:'beat',el,ci,ts:16,cm:8,se:[],ds:null,ch:[]};
  BC.forEach(b=>m.ch.push({...b,mut:false,solo:false,steps:new Array(32).fill(false)}));
  m.aud=(i)=>{const a=m.ch.some(c=>c.solo);return a?m.ch[i].solo&&!m.ch[i].mut:!m.ch[i].mut};
  m.snd=(c)=>SL[c.t][c.s];
  m.dst=()=>chs[m.ci].g||mGain;
  m.onStep=(s,t)=>{const d=m.dst();m.ch.forEach((c,i)=>{if(c.steps[s]&&m.aud(i))m.snd(c)(t,c.v,ctx,d)});m.se.forEach(r=>r.forEach((e,si)=>e.classList.toggle('current',si===s)))};
  m.clr=()=>m.se.forEach(r=>r.forEach(e=>e.classList.remove('current')));
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // kb
  const kb=document.createElement('button');kb.className='wb kb';kb.title='Q-I';kb.textContent='⌨';kb.dataset.mid=id;
  kb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kb);
  const BK='qwertyui';
  m._kd=e=>{if(e.repeat||_kb!==id)return;const ki=BK.indexOf(e.key.toLowerCase());if(ki>=0&&ki<m.ch.length){initA();const c=m.ch[ki];if(m.aud(ki))m.snd(c)(ctx.currentTime,c.v,ctx,m.dst())}};
  window.addEventListener('keydown',m._kd);
  m.destroy=()=>{window.removeEventListener('keydown',m._kd);if(_kb===id)_kb=null};
  // config
  const cfg=document.createElement('div');cfg.className='bcfg';
  const st=document.createElement('div');st.className='stog';
  [16,32].forEach(n=>{const b=document.createElement('button');b.textContent=n;b.className=n===16?'active':'';b.addEventListener('click',()=>{if(n===m.ts)return;m.ts=n;st.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===n));buildBG(m,bd)});st.appendChild(b)});
  const cst=document.createElement('div');cst.className='stog';
  [8,16].forEach(n=>{const b=document.createElement('button');b.textContent=n+'CH';b.className=n===8?'active':'';b.addEventListener('click',()=>{if(n===m.cm)return;cst.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x.textContent===n+'CH'));rebCh(m,n,bd)});cst.appendChild(b)});
  cfg.append(st,cst);
  const PR={hiphop:{bpm:90,s:[[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],[1,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]]},house:{bpm:128,s:[[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]]},trap:{bpm:140,s:[[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1],[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0]]}};
  ['Hip-Hop','House','Trap','Clear'].forEach(n=>{const b=document.createElement('button');b.className='pbtn';b.textContent=n;b.addEventListener('click',()=>{if(n==='Clear'){m.ch.forEach(c=>c.steps.fill(false));buildBG(m,bd);return}const p=PR[n.toLowerCase().replace('-','')];if(!p)return;chs[m.ci].bpm=p.bpm;updMx();m.ch.forEach((c,i)=>{c.steps.fill(false);if(p.s[i])for(let s=0;s<Math.min(16,m.ts);s++)c.steps[s]=!!p.s[i][s]});buildBG(m,bd)});cfg.appendChild(b)});
  bd.appendChild(cfg);buildBG(m,bd);
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}
function buildBG(m,bd){
  let w=bd.querySelector('.bgw');if(w)w.remove();w=document.createElement('div');w.className='bgw';
  const nm=document.createElement('div');nm.className='bnums';
  for(let s=0;s<m.ts;s++){const n=document.createElement('div');n.className='bnum'+(s%4===0?' bb':'');n.textContent=s+1;nm.appendChild(n)}
  w.appendChild(nm);const g=document.createElement('div');g.className='bg';m.se=[];
  m.ch.forEach((ch,ci)=>{
    const r=document.createElement('div');r.className='br';
    const lb=document.createElement('div');lb.className='bl';
    const nn=document.createElement('span');nn.className='bn';nn.style.color=ch.c;nn.textContent=ch.n;
    const mt=document.createElement('div');mt.className='bm'+(ch.mut?' muted':'');mt.textContent='M';mt.addEventListener('click',()=>{ch.mut=!ch.mut;mt.classList.toggle('muted')});
    const sl=document.createElement('div');sl.className='bs_btn'+(ch.solo?' soloed':'');sl.textContent='S';sl.addEventListener('click',()=>{ch.solo=!ch.solo;sl.classList.toggle('soloed')});
    const vl=document.createElement('input');vl.type='range';vl.className='bv';vl.min=0;vl.max=100;vl.value=ch.v*100;vl.addEventListener('input',()=>{ch.v=vl.value/100});
    const se=document.createElement('select');se.className='bsel';Object.keys(SL[ch.t]).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if(ch.s===s)o.selected=true;se.appendChild(o)});se.addEventListener('change',()=>{ch.s=se.value});
    lb.append(nn,mt,sl,vl,se);r.appendChild(lb);
    const sc=document.createElement('div');sc.className='bsteps';const sr=[];
    for(let s=0;s<m.ts;s++){const st=document.createElement('div');st.className='bstep'+(s%4===0?' bm4':'');
      if(ch.steps[s]){st.classList.add('on');st.style.background=ch.c;st.style.borderColor=ch.c}
      st.addEventListener('mousedown',e=>{e.preventDefault();ch.steps[s]=!ch.steps[s];st.classList.toggle('on');
        if(ch.steps[s]){st.style.background=ch.c;st.style.borderColor=ch.c}else{st.style.background='';st.style.borderColor=''}
        if(ch.steps[s]&&m.aud(ci)){initA();m.snd(ch)(ctx.currentTime,ch.v,ctx,m.dst())}
        m.ds={v:ch.steps[s],ci,c:ch.c}});
      st.addEventListener('touchstart',e=>{e.preventDefault();ch.steps[s]=!ch.steps[s];st.classList.toggle('on');
        if(ch.steps[s]){st.style.background=ch.c;st.style.borderColor=ch.c}else{st.style.background='';st.style.borderColor=''}
        if(ch.steps[s]&&m.aud(ci)){initA();m.snd(ch)(ctx.currentTime,ch.v,ctx,m.dst())}
        m.ds={v:ch.steps[s],ci,c:ch.c}},{passive:false});
      st.addEventListener('mouseenter',()=>{if(m.ds&&m.ds.ci===ci){ch.steps[s]=m.ds.v;st.classList.toggle('on',ch.steps[s]);if(ch.steps[s]){st.style.background=m.ds.c;st.style.borderColor=m.ds.c}else{st.style.background='';st.style.borderColor=''}}});
      sc.appendChild(st);sr.push(st)}
    r.appendChild(sc);m.se.push(sr);g.appendChild(r)});
  w.appendChild(g);bd.appendChild(w);window.addEventListener('mouseup',()=>{m.ds=null});window.addEventListener('touchend',()=>{m.ds=null});
}
function rebCh(m,mode,bd){m.cm=mode;const sv=m.ch.map(c=>({t:c.t,s:c.s,steps:[...c.steps],v:c.v,mut:c.mut,solo:c.solo}));m.ch.length=0;
  BC.forEach((b,i)=>{const s=sv[i];m.ch.push({...b,mut:s?s.mut:false,solo:s?s.solo:false,s:s?s.s:b.s,v:s?s.v:b.v,steps:s?s.steps:new Array(32).fill(false)});
    if(mode===16){const ex=BX[b.t];const si=sv[i+8];m.ch.push({n:b.n+'2',t:b.t,c:b.c,s:si?si.s:ex.s,v:si?si.v:ex.v,mut:si?si.mut:false,solo:si?si.solo:false,steps:si?si.steps:new Array(32).fill(false)})}
  });buildBG(m,bd)}

// === SYNTH MODULE ===
function addSynth(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('SYNTH<span>.EXE</span>','Synth','var(--a2)',880+(mods.length%4)*30,20+(mods.length%4)*20,500,280,ci);
  el.id='m'+id;
  const m={id,type:'synth',el,ci,ts:0,wv:'sawtooth',det:5,a:.01,d:.2,s:.5,r:.3,ff:4000,fr:1,vol:.6,oct:4,an:{},
    nn:['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'],km:{a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12}};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.play=(note,vel=.8)=>{if(!ctx)return;const freq=m.nf(note,m.oct),t=ctx.currentTime,dest=m.dst();
    const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);o2.start(t);m.an[note]={o1,o2,g,f}};
  m.stop=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o1.stop(t+m.r+.05);n.o2.stop(t+m.r+.05);delete m.an[note]};
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const top=document.createElement('div');top.className='st';
  const osc=document.createElement('div');osc.className='ss';osc.innerHTML='<div class="sst">OSC</div>';
  const wr=document.createElement('div');wr.className='sws';
  ['sine','triangle','sawtooth','square'].forEach(w=>{const b=document.createElement('button');b.className='swb'+(m.wv===w?' active':'');b.textContent=w==='sawtooth'?'SAW':w.slice(0,3).toUpperCase();b.addEventListener('click',()=>{m.wv=w;wr.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});wr.appendChild(b)});
  osc.appendChild(wr);const kr=document.createElement('div');kr.className='skr';
  kr.append(mkK('Det',0,50,m.det,v=>{m.det=v}),mkK('Oct',2,6,m.oct,v=>{m.oct=Math.round(v)},1));
  osc.appendChild(kr);top.appendChild(osc);
  const env=document.createElement('div');env.className='ss';env.innerHTML='<div class="sst">ENV</div>';
  const er=document.createElement('div');er.className='skr';
  er.append(mkK('A',0,100,m.a*100,v=>{m.a=v/100}),mkK('D',0,100,m.d*100,v=>{m.d=v/100}),mkK('S',0,100,m.s*100,v=>{m.s=v/100}),mkK('R',0,100,m.r*100,v=>{m.r=v/100}));
  env.appendChild(er);top.appendChild(env);
  const fl=document.createElement('div');fl.className='ss';fl.innerHTML='<div class="sst">FLT</div>';
  const flr=document.createElement('div');flr.className='skr';
  flr.append(mkK('Freq',50,18000,m.ff,v=>{m.ff=v}),mkK('Res',0,20,m.fr,v=>{m.fr=v}),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}));
  fl.appendChild(flr);top.appendChild(fl);bd.appendChild(top);
  const keybd=document.createElement('div');keybd.className='skb';
  const whites=[0,2,4,5,7,9,11,12],bp={1:1,3:2,6:4,8:5,10:6};
  whites.forEach(note=>{const k=document.createElement('div');k.className='swk';k.dataset.note=note;const l=document.createElement('span');l.className='kl';l.textContent=m.nn[note%12];k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(note);k.classList.add('active')});k.addEventListener('mouseup',()=>{m.stop(note);k.classList.remove('active')});k.addEventListener('mouseleave',()=>{m.stop(note);k.classList.remove('active')});keybd.appendChild(k)});
  Object.entries(bp).forEach(([note,pos])=>{const k=document.createElement('div');k.className='sbk';k.dataset.note=note;k.style.left=((pos-1)/whites.length*100+100/whites.length*0.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(+note);k.classList.add('active')});k.addEventListener('mouseup',()=>{m.stop(+note);k.classList.remove('active')});k.addEventListener('mouseleave',()=>{m.stop(+note);k.classList.remove('active')});keybd.appendChild(k)});
  bd.appendChild(keybd);
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='A-K';kbb.textContent='⌨';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const kd=e=>{if(e.repeat||_kb!==id)return;const n=m.km[e.key.toLowerCase()];if(n!==undefined){initA();m.play(n);const k=keybd.querySelector(`[data-note="${n}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const n=m.km[e.key.toLowerCase()];if(n!==undefined){m.stop(n);const k=keybd.querySelector(`[data-note="${n}"]`);if(k)k.classList.remove('active')}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);Object.keys(m.an).forEach(n=>m.stop(+n));if(_kb===id)_kb=null};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}
function mkK(l,mn,mx,v,fn,rnd){const w=document.createElement('div');w.className='sk';const lb=document.createElement('label');lb.textContent=l;const i=document.createElement('input');i.type='range';i.min=mn;i.max=mx;i.value=v;const vd=document.createElement('span');vd.className='kv';vd.textContent=rnd?Math.round(v):v;i.addEventListener('input',()=>{const x=+i.value;fn(x);vd.textContent=rnd?Math.round(x):x});w.append(lb,i,vd);return w}

// === FX MODULE ===
function addFx(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('FX<span>.EXE</span>','FX','var(--purple)',20+(mods.length%4)*30,360+(mods.length%4)*20,540,210,ci);
  el.id='m'+id;
  const st={reverb:{on:false,mix:.3,decay:.8},delay:{on:false,time:.25,fb:.35,mix:.25},dist:{on:false,amt:.4},filter:{on:false,freq:2000},chorus:{on:false,rate:.4,depth:.4},phaser:{on:false,rate:.5,depth:.6},comp:{on:false,thr:.5,rat:.6},crush:{on:false,bits:.5,mix:.4},vinyl:{on:false,crackle:.3,hiss:.2},wobble:{on:false,rate:.25,depth:.3},lofi:{on:false,cut:3000,noise:.15}};
  const nd={};
  function initFx(){
    if(!ctx||nd.ok)return;nd.ok=true;
    const chG=chs[m.ci].g;if(!chG)return;
    // Reverb: convolver with IR → wet gain
    nd.rvC=ctx.createConvolver();nd.rvG=ctx.createGain();nd.rvG.gain.value=0;
    const rl=ctx.sampleRate*2,rb=ctx.createBuffer(2,rl,ctx.sampleRate);
    for(let c=0;c<2;c++){const a=rb.getChannelData(c);for(let i=0;i<rl;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/rl,3.4)}
    nd.rvC.buffer=rb;chG.connect(nd.rvC);nd.rvC.connect(nd.rvG);nd.rvG.connect(mGain);
    // Delay: delay node → wet gain + feedback loop
    nd.dl=ctx.createDelay(2);nd.dl.delayTime.value=.25;
    nd.dlG=ctx.createGain();nd.dlG.gain.value=0;
    nd.dlFb=ctx.createGain();nd.dlFb.gain.value=.35;
    chG.connect(nd.dl);nd.dl.connect(nd.dlG);nd.dlG.connect(mGain);nd.dl.connect(nd.dlFb);nd.dlFb.connect(nd.dl);
    // Distortion: waveshaper inserted into channel
    nd.dist=ctx.createWaveShaper();nd.dist.oversample='4x';
    nd.distAmt=0.4;setDistCurve(nd.dist,nd.distAmt);
    // Filter on channel
    nd.flt=ctx.createBiquadFilter();nd.flt.type='lowpass';nd.flt.frequency.value=20000;nd.flt.Q.value=1;
    // Compressor on channel
    nd.cmp=ctx.createDynamicsCompressor();nd.cmp.threshold.value=0;nd.cmp.ratio.value=1;nd.cmp.knee.value=12;
    // Re-wire channel: chG → dist → filter → lofi_flt → comp → mGain
    chG.disconnect(mGain);
    // Lo-fi filter (separate from main filter)
    nd.loFlt=ctx.createBiquadFilter();nd.loFlt.type='lowpass';nd.loFlt.frequency.value=20000;nd.loFlt.Q.value=0;
    chG.connect(nd.dist);nd.dist.connect(nd.flt);nd.flt.connect(nd.loFlt);nd.loFlt.connect(nd.cmp);nd.cmp.connect(mGain);
    // Vinyl crackle + hiss: noise sources mixed into channel
    nd.vinylG=ctx.createGain();nd.vinylG.gain.value=0;nd.vinylG.connect(mGain);
    nd.hissG=ctx.createGain();nd.hissG.gain.value=0;nd.hissG.connect(mGain);
    // crackle = filtered noise bursts
    nd.crackBuf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
    const cd=nd.crackBuf.getChannelData(0);for(let i=0;i<cd.length;i++)cd[i]=Math.random()>.97?(Math.random()*2-1)*.6:0;
    nd.crackSrc=ctx.createBufferSource();nd.crackSrc.buffer=nd.crackBuf;nd.crackSrc.loop=true;
    const crFlt=ctx.createBiquadFilter();crFlt.type='highpass';crFlt.frequency.value=1000;
    nd.crackSrc.connect(crFlt);crFlt.connect(nd.vinylG);nd.crackSrc.start();
    // hiss = highpass noise
    nd.hissBuf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
    const hd=nd.hissBuf.getChannelData(0);for(let i=0;i<hd.length;i++)hd[i]=(Math.random()*2-1)*.15;
    nd.hissSrc=ctx.createBufferSource();nd.hissSrc.buffer=nd.hissBuf;nd.hissSrc.loop=true;
    const hiFlt=ctx.createBiquadFilter();hiFlt.type='highpass';hiFlt.frequency.value=4000;
    nd.hissSrc.connect(hiFlt);hiFlt.connect(nd.hissG);nd.hissSrc.start();
    // Wow/flutter: LFO modulating a delay line
    nd.wobDl=ctx.createDelay(.05);nd.wobDl.delayTime.value=.01;
    nd.wobLfo=ctx.createOscillator();nd.wobLfo.type='sine';nd.wobLfo.frequency.value=.5;
    nd.wobDepth=ctx.createGain();nd.wobDepth.gain.value=0;
    nd.wobLfo.connect(nd.wobDepth);nd.wobDepth.connect(nd.wobDl.delayTime);nd.wobLfo.start();
    // Lo-fi noise layer
    nd.loNoiseG=ctx.createGain();nd.loNoiseG.gain.value=0;nd.loNoiseG.connect(mGain);
    nd.loNoiseBuf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
    const lnd=nd.loNoiseBuf.getChannelData(0);for(let i=0;i<lnd.length;i++)lnd[i]=(Math.random()*2-1)*.08;
    nd.loNoiseSrc=ctx.createBufferSource();nd.loNoiseSrc.buffer=nd.loNoiseBuf;nd.loNoiseSrc.loop=true;
    const loNFlt=ctx.createBiquadFilter();loNFlt.type='bandpass';loNFlt.frequency.value=2000;loNFlt.Q.value=.5;
    nd.loNoiseSrc.connect(loNFlt);loNFlt.connect(nd.loNoiseG);nd.loNoiseSrc.start();
  }
  function setDistCurve(ws,amt){
    const k=amt*100,n=44100,c=new Float32Array(n);
    for(let i=0;i<n;i++){const x=i*2/n-1;c[i]=(3+k)*x*20*(Math.PI/180)/(Math.PI+k*Math.abs(x))}
    ws.curve=c;
  }
  function updFx(){
    if(!nd.ok)return;
    nd.rvG.gain.value=st.reverb.on?st.reverb.mix:0;
    nd.dlG.gain.value=st.delay.on?st.delay.mix:0;
    nd.dl.delayTime.value=st.delay.time;
    nd.dlFb.gain.value=st.delay.on?st.delay.fb:0;
    if(st.dist.on){nd.distAmt=st.dist.amt;setDistCurve(nd.dist,st.dist.amt)}else{nd.dist.curve=null}
    if(st.filter.on){nd.flt.frequency.value=st.filter.freq}else{nd.flt.frequency.value=20000}
    if(st.comp.on){nd.cmp.threshold.value=-50+st.comp.thr*40;nd.cmp.ratio.value=1+st.comp.rat*19}else{nd.cmp.threshold.value=0;nd.cmp.ratio.value=1}
    // Vinyl
    nd.vinylG.gain.value=st.vinyl.on?st.vinyl.crackle*.3:0;
    nd.hissG.gain.value=st.vinyl.on?st.vinyl.hiss*.15:0;
    // Wow/flutter
    if(st.wobble.on){nd.wobLfo.frequency.value=.2+st.wobble.rate*3;nd.wobDepth.gain.value=st.wobble.depth*.003;
      // insert wobble delay if not already
      if(!nd.wobIn){try{nd.cmp.disconnect(mGain);nd.cmp.connect(nd.wobDl);nd.wobDl.connect(mGain);nd.wobIn=true}catch(e){}}}
    else if(nd.wobIn){try{nd.cmp.disconnect(nd.wobDl);nd.wobDl.disconnect(mGain);nd.cmp.connect(mGain);nd.wobIn=false}catch(e){}}
    // Lo-fi
    if(st.lofi.on){nd.loFlt.frequency.value=st.lofi.cut;nd.loNoiseG.gain.value=st.lofi.noise*.2}
    else{nd.loFlt.frequency.value=20000;nd.loNoiseG.gain.value=0}
  }
  const m={id,type:'fx',el,ci,ts:0,onStep:()=>{},clr:()=>{},initFx};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);nd.ok=false;filt()});
  const rk=document.createElement('div');rk.className='fxg';
  function mkFx(t,k,knobs){
    const u=document.createElement('div');u.className='fxu';const h=document.createElement('div');h.className='fxh';const n=document.createElement('span');n.className='fxn';n.textContent=t;
    const sw=document.createElement('button');sw.className='fxsw';
    sw.addEventListener('click',()=>{st[k].on=!st[k].on;sw.classList.toggle('on');u.classList.toggle('active');initA();initFx();updFx()});
    h.append(n,sw);u.appendChild(h);
    const kr=document.createElement('div');kr.className='fxks';
    knobs.forEach(x=>{const w=document.createElement('div');w.className='fxk';const l=document.createElement('label');l.textContent=x.l;
      const i=document.createElement('input');i.type='range';i.min=x.mn;i.max=x.mx;i.value=x.v;
      i.addEventListener('input',()=>{
        const v=+i.value;
        if(k==='reverb'){if(x.k==='mix')st.reverb.mix=v/100;if(x.k==='dec')st.reverb.decay=v/100}
        else if(k==='delay'){if(x.k==='time')st.delay.time=v/200;if(x.k==='fb')st.delay.fb=v/100;if(x.k==='mix')st.delay.mix=v/100}
        else if(k==='dist')st.dist.amt=v/100;
        else if(k==='filter')st.filter.freq=v;
        else if(k==='chorus'){if(x.k==='rate')st.chorus.rate=v/100;if(x.k==='depth')st.chorus.depth=v/100}
        else if(k==='phaser'){if(x.k==='rate')st.phaser.rate=v/100;if(x.k==='depth')st.phaser.depth=v/100}
        else if(k==='comp'){if(x.k==='thr')st.comp.thr=v/100;if(x.k==='rat')st.comp.rat=v/100}
        else if(k==='crush'){if(x.k==='bits')st.crush.bits=v/100;if(x.k==='mix')st.crush.mix=v/100}
        else if(k==='vinyl'){if(x.k==='crackle')st.vinyl.crackle=v/100;if(x.k==='hiss')st.vinyl.hiss=v/100}
        else if(k==='wobble'){if(x.k==='rate')st.wobble.rate=v/100;if(x.k==='depth')st.wobble.depth=v/100}
        else if(k==='lofi'){if(x.k==='cut')st.lofi.cut=v;if(x.k==='noise')st.lofi.noise=v/100}
        updFx()});
      w.append(l,i);kr.appendChild(w)});
    u.appendChild(kr);return u}
  rk.append(
    mkFx('Reverb','reverb',[{l:'Mix',k:'mix',mn:0,mx:100,v:30},{l:'Decay',k:'dec',mn:10,mx:100,v:80}]),
    mkFx('Delay','delay',[{l:'Time',k:'time',mn:5,mx:100,v:50},{l:'Feed',k:'fb',mn:0,mx:90,v:35},{l:'Mix',k:'mix',mn:0,mx:100,v:25}]),
    mkFx('Distort','dist',[{l:'Drive',k:'amt',mn:0,mx:100,v:40}]),
    mkFx('Filter','filter',[{l:'Freq',k:'freq',mn:100,mx:18000,v:2000}]),
    mkFx('Chorus','chorus',[{l:'Rate',k:'rate',mn:0,mx:100,v:40},{l:'Depth',k:'depth',mn:0,mx:100,v:40}]),
    mkFx('Phaser','phaser',[{l:'Rate',k:'rate',mn:0,mx:100,v:25},{l:'Depth',k:'depth',mn:0,mx:100,v:60}]),
    mkFx('Compress','comp',[{l:'Thr',k:'thr',mn:0,mx:100,v:50},{l:'Ratio',k:'rat',mn:0,mx:100,v:60}]),
    mkFx('Bitcrush','crush',[{l:'Bits',k:'bits',mn:0,mx:100,v:50},{l:'Mix',k:'mix',mn:0,mx:100,v:40}]),
    mkFx('Vinyl','vinyl',[{l:'Crackle',k:'crackle',mn:0,mx:100,v:30},{l:'Hiss',k:'hiss',mn:0,mx:100,v:20}]),
    mkFx('Wow/Flut','wobble',[{l:'Rate',k:'rate',mn:0,mx:100,v:25},{l:'Depth',k:'depth',mn:0,mx:100,v:30}]),
    mkFx('Lo-Fi','lofi',[{l:'Cutoff',k:'cut',mn:200,mx:8000,v:3000},{l:'Noise',k:'noise',mn:0,mx:100,v:15}])
  );
  bd.appendChild(rk);ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === PIANO MODULE ===
function addPiano(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('PIANO<span>.EXE</span>','Keys','#f472b6',40+(mods.length%4)*30,60+(mods.length%4)*20,620,220,ci);
  el.id='m'+id;
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const m={id,type:'piano',el,ci,ts:0,wv:'triangle',det:3,a:.005,d:.15,s:.6,r:.4,ff:6000,fr:.5,vol:.55,oct:3,an:{},sus:false};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.play=(note,vel=.8)=>{if(!ctx)return;if(m.an[note])m.stopN(note);
    const freq=m.nf(note%12,m.oct+Math.floor(note/12)),t=ctx.currentTime,d=m.dst();
    const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type='sine';o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;o1.connect(f);o2.connect(f);f.connect(g);g.connect(d);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);o2.start(t);m.an[note]={o1,o2,g}};
  m.stopN=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o1.stop(t+m.r+.05);n.o2.stop(t+m.r+.05);delete m.an[note]};
  m.relSus=()=>{Object.keys(m.an).forEach(n=>m.stopN(+n));m.an={}};
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{
    // Release all notes before switching channels to prevent orphaned oscillators
    if(m.sus)m.relSus();
    Object.keys(m.an).forEach(n=>m.stopN(+n));
    el.querySelectorAll('.pk-w.active,.pk-b.active').forEach(k=>k.classList.remove('active'));
    m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()
  });
  const ctrl=document.createElement('div');ctrl.className='piano-ctrl';
  const wsel=document.createElement('div');wsel.className='sws';
  ['sine','triangle','sawtooth','square'].forEach(w=>{const b=document.createElement('button');b.className='swb'+(m.wv===w?' active':'');b.textContent=w==='sawtooth'?'SAW':w.slice(0,3).toUpperCase();b.addEventListener('click',()=>{m.wv=w;wsel.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});wsel.appendChild(b)});
  ctrl.appendChild(wsel);
  ctrl.append(mkK('Oct',1,5,m.oct,v=>{m.oct=Math.round(v)},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}),mkK('Atk',0,100,m.a*1000,v=>{m.a=v/1000}),mkK('Rel',0,100,m.r*100,v=>{m.r=v/100}));
  const susBtn=document.createElement('button');susBtn.className='pbtn';susBtn.textContent='SUS';
  susBtn.addEventListener('click',()=>{m.sus=!m.sus;susBtn.style.background=m.sus?'#f472b6':'';susBtn.style.color=m.sus?'#fff':'';if(!m.sus)m.relSus()});
  ctrl.appendChild(susBtn);bd.appendChild(ctrl);
  // 3-octave keyboard
  const kb=document.createElement('div');kb.className='piano-kb';
  const isB=[0,1,0,1,0,0,1,0,1,0,1,0];let wi=0;
  for(let i=0;i<36;i++){if(!isB[i%12]){const k=document.createElement('div');k.className='pk-w';k.dataset.note=i;
    const l=document.createElement('span');l.className='pkl';if(i%12===0)l.textContent='C'+(m.oct+Math.floor(i/12));k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(i);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    k.addEventListener('mouseleave',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    kb.appendChild(k);wi++}}
  wi=0;for(let i=0;i<36;i++){if(!isB[i%12])wi++;else{const k=document.createElement('div');k.className='pk-b';k.dataset.note=i;
    const ww=100/(21);k.style.left=(wi*ww-ww*.3)+'%';k.style.width=(ww*.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(i);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    k.addEventListener('mouseleave',()=>{if(!m.sus){m.stopN(i);k.classList.remove('active')}});
    kb.appendChild(k)}}
  bd.appendChild(kb);
  // keyboard: letters = white keys in order, numbers = black keys in order
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='Letters + Numbers';kbb.textContent='⌨';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const PKEYS={};
  // white keys: C D E F G A B across 3 octaves = 21 white keys + top C = 22
  const WK='abcdefghijklmnopqrstuv';
  // black keys: C# D# F# G# A# across 3 octaves = 15 black keys
  const BKS='1234567890qwert';
  // map note indices: build from chromatic scale, separating white vs black
  const isBlk=[0,1,0,1,0,0,1,0,1,0,1,0];
  let wki=0,bki=0;
  for(let i=0;i<36;i++){
    if(isBlk[i%12]){if(bki<BKS.length){PKEYS[BKS[bki]]=i;bki++}}
    else{if(wki<WK.length){PKEYS[WK[wki]]=i;wki++}}
  }
  const kd=e=>{if(e.repeat||_kb!==id)return;const ki=PKEYS[e.key.toLowerCase()];if(ki!==undefined){initA();m.play(ki);const k=kb.querySelector(`[data-note="${ki}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const ki=PKEYS[e.key.toLowerCase()];if(ki!==undefined){if(!m.sus){m.stopN(ki);const k=kb.querySelector(`[data-note="${ki}"]`);if(k)k.classList.remove('active')}}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);m.relSus();if(_kb===id)_kb=null};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === BASS MODULE ===
function addBass(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('BASS<span>.EXE</span>','Bass','#818cf8',100+(mods.length%4)*30,380+(mods.length%4)*20,440,200,ci);
  el.id='m'+id;
  const modes={sub:{wv:'sine',ff:200,fr:0,det:0,a:.01,d:.1,s:.9,r:.15},growl:{wv:'sawtooth',ff:800,fr:8,det:15,a:.005,d:.05,s:.7,r:.1},pluck:{wv:'square',ff:2000,fr:3,det:5,a:.001,d:.08,s:.2,r:.08},acid:{wv:'sawtooth',ff:3000,fr:12,det:0,a:.001,d:.15,s:.3,r:.05}};
  const m={id,type:'bass',el,ci,ts:0,...modes.sub,vol:.7,oct:2,an:{},mode:'sub'};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.play=(note,vel=.9)=>{if(!ctx)return;if(m.an[note])m.stopN(note);
    const freq=m.nf(note,m.oct),t=ctx.currentTime,dest=m.dst();
    const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.setValueAtTime(m.ff,t);f.frequency.exponentialRampToValueAtTime(Math.max(50,m.ff*.2),t+m.d+.1);f.Q.value=m.fr;
    o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol*vel,t+m.a);g.gain.linearRampToValueAtTime(m.vol*vel*m.s,t+m.a+m.d);
    o1.start(t);o2.start(t);m.an[note]={o1,o2,g,f}};
  m.stopN=(note)=>{const n=m.an[note];if(!n)return;const t=ctx.currentTime;n.g.gain.cancelScheduledValues(t);n.g.gain.setValueAtTime(n.g.gain.value,t);n.g.gain.linearRampToValueAtTime(0,t+m.r);n.o1.stop(t+m.r+.05);n.o2.stop(t+m.r+.05);delete m.an[note]};
  m.onStep=()=>{};m.clr=()=>{};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const ctrl=document.createElement('div');ctrl.className='bass-ctrl';
  const ms=document.createElement('div');ms.className='bass-sec';ms.innerHTML='<div class="sst" style="color:#818cf8">Mode</div>';
  const msel=document.createElement('div');msel.className='sws';
  ['sub','growl','pluck','acid'].forEach(md=>{const b=document.createElement('button');b.className='swb'+(m.mode===md?' active':'');b.textContent=md.toUpperCase();
    b.addEventListener('click',()=>{m.mode=md;Object.assign(m,modes[md]);msel.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});msel.appendChild(b)});
  ms.appendChild(msel);ctrl.appendChild(ms);
  const ps=document.createElement('div');ps.className='bass-sec';ps.innerHTML='<div class="sst" style="color:#818cf8">Tune</div>';
  const kr=document.createElement('div');kr.className='skr';
  kr.append(mkK('Oct',1,3,m.oct,v=>{m.oct=Math.round(v)},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}),mkK('Flt',50,3000,m.ff,v=>{m.ff=v}),mkK('Res',0,20,m.fr,v=>{m.fr=v}));
  ps.appendChild(kr);ctrl.appendChild(ps);bd.appendChild(ctrl);
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const kb=document.createElement('div');kb.className='skb';kb.style.height='50px';
  const whites=[0,2,4,5,7,9,11,12],bp={1:1,3:2,6:4,8:5,10:6};
  whites.forEach(note=>{const k=document.createElement('div');k.className='swk';k.dataset.note=note;
    const l=document.createElement('span');l.className='kl';l.textContent=NN[note%12];k.appendChild(l);
    k.addEventListener('mousedown',e=>{e.preventDefault();initA();m.play(note);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{m.stopN(note);k.classList.remove('active')});
    k.addEventListener('mouseleave',()=>{m.stopN(note);k.classList.remove('active')});kb.appendChild(k)});
  Object.entries(bp).forEach(([note,pos])=>{const k=document.createElement('div');k.className='sbk';k.dataset.note=note;k.style.left=((pos-1)/whites.length*100+100/whites.length*0.6)+'%';
    k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();initA();m.play(+note);k.classList.add('active')});
    k.addEventListener('mouseup',()=>{m.stopN(+note);k.classList.remove('active')});
    k.addEventListener('mouseleave',()=>{m.stopN(+note);k.classList.remove('active')});kb.appendChild(k)});
  bd.appendChild(kb);
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='A-K';kbb.textContent='⌨';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const KM={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12};
  const kd=e=>{if(e.repeat||_kb!==id)return;const n=KM[e.key.toLowerCase()];if(n!==undefined){initA();m.play(n);const k=kb.querySelector(`[data-note="${n}"]`);if(k)k.classList.add('active')}};
  const ku=e=>{if(_kb!==id)return;const n=KM[e.key.toLowerCase()];if(n!==undefined){m.stopN(n);const k=kb.querySelector(`[data-note="${n}"]`);if(k)k.classList.remove('active')}};
  window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
  m.destroy=()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);Object.keys(m.an).forEach(n=>m.stopN(+n));if(_kb===id)_kb=null};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === NOTE MODULE — piano roll ===
function addNote(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('NOTE<span>.EXE</span>','Roll','#fbbf24',200+(mods.length%4)*30,60+(mods.length%4)*20,680,280,ci);
  el.id='m'+id;
  const ROWS=13,COLS=16,NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B','C'];
  const grid=Array.from({length:ROWS},()=>new Array(COLS).fill(false));
  const m={id,type:'note',el,ci,ts:COLS,oct:4,wv:'sawtooth',vol:.4,a:.005,d:.1,s:.4,r:.15,ff:3000,fr:1,det:5,cellEls:[],dragVal:null,inst:'lead'};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  const INST={
    lead:{wv:'sawtooth',det:5,a:.005,d:.1,s:.4,r:.15,ff:3000,fr:1,col:'#fbbf24'},
    pad:{wv:'sawtooth',det:12,a:.15,d:.3,s:.7,r:.4,ff:2000,fr:.5,col:'#a78bfa'},
    pluck:{wv:'triangle',det:3,a:.001,d:.06,s:.1,r:.05,ff:5000,fr:2,col:'#34d399'},
    organ:{wv:'sine',det:0,a:.005,d:.01,s:.9,r:.08,ff:8000,fr:0,col:'#fb923c'},
    bell:{wv:'sine',det:50,a:.001,d:.4,s:.05,r:.6,ff:12000,fr:0,col:'#22d3ee'},
    strings:{wv:'sawtooth',det:8,a:.2,d:.2,s:.8,r:.5,ff:1800,fr:.3,col:'#f472b6'},
    brass:{wv:'square',det:3,a:.02,d:.08,s:.6,r:.12,ff:2500,fr:3,col:'#e8364f'},
    flute:{wv:'sine',det:1,a:.05,d:.1,s:.7,r:.2,ff:4000,fr:.5,col:'#818cf8'},
    chip:{wv:'square',det:0,a:.001,d:.05,s:.3,r:.02,ff:18000,fr:0,col:'#10b981'},
    bass:{wv:'sawtooth',det:2,a:.005,d:.12,s:.5,r:.1,ff:800,fr:4,col:'#f59e0b'}
  };
  function applyInst(name){
    const p=INST[name];if(!p)return;m.inst=name;
    m.wv=p.wv;m.det=p.det;m.a=p.a;m.d=p.d;m.s=p.s;m.r=p.r;m.ff=p.ff;m.fr=p.fr;
  }
  const m_playAt=(c,note,t,dest)=>{const freq=m.nf(note,m.oct);
    const o1=c.createOscillator(),o2=c.createOscillator(),g=c.createGain(),f=c.createBiquadFilter();
    o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
    f.type='lowpass';f.frequency.value=m.ff;f.Q.value=m.fr;o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
    const dur=m.a+m.d+m.r+.05;
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol,t+m.a);g.gain.linearRampToValueAtTime(m.vol*m.s,t+m.a+m.d);g.gain.linearRampToValueAtTime(0,t+m.a+m.d+m.r);
    o1.start(t);o1.stop(t+dur);o2.start(t);o2.stop(t+dur)};
  m.playAt=(note,t)=>{if(!ctx)return;m_playAt(ctx,note,t,m.dst())};
  m.onStep=(s,t)=>{if(s>=m.ts)return;for(let r=0;r<ROWS;r++){if(grid[r][s])m.playAt(ROWS-1-r,t)}
    m.cellEls.forEach((row,ri)=>row.forEach((c,si)=>c.classList.toggle('current',si===s)))};
  m.clr=()=>m.cellEls.forEach(r=>r.forEach(c=>c.classList.remove('current')));
  m.renderEx=(s,t,oc,dest)=>{if(s>=m.ts)return;for(let r=0;r<ROWS;r++){if(grid[r][s])m_playAt(oc,ROWS-1-r,t,dest)}};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const ctrl=document.createElement('div');ctrl.className='piano-ctrl';
  // instrument selector
  const isel=document.createElement('div');isel.className='sws';isel.style.flexWrap='wrap';
  Object.keys(INST).forEach(name=>{const b=document.createElement('button');b.className='swb'+(m.inst===name?' active':'');b.textContent=name.toUpperCase();b.style.fontSize='5px';
    if(m.inst===name)b.style.background=INST[name].col;
    b.addEventListener('click',()=>{applyInst(name);isel.querySelectorAll('.swb').forEach(x=>{x.classList.remove('active');x.style.background=''});b.classList.add('active');b.style.background=INST[name].col});isel.appendChild(b)});
  ctrl.appendChild(isel);
  ctrl.append(mkK('Oct',2,6,m.oct,v=>{m.oct=Math.round(v);buildNR()},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}));
  // step count toggle
  const stog=document.createElement('div');stog.className='stog';
  [16,32].forEach(n=>{const b=document.createElement('button');b.textContent=n;b.className=n===COLS?'active':'';
    b.addEventListener('click',()=>{if(n===m.ts)return;m.ts=n;stog.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===n));
      if(n>grid[0].length){grid.forEach(r=>{while(r.length<n)r.push(false)})}buildNR()});stog.appendChild(b)});
  ctrl.appendChild(stog);
  const clrBtn=document.createElement('button');clrBtn.className='pbtn';clrBtn.textContent='CLR';clrBtn.addEventListener('click',()=>{grid.forEach(r=>r.fill(false));buildNR()});
  ctrl.appendChild(clrBtn);bd.appendChild(ctrl);
  const wrap=document.createElement('div');wrap.className='nr-wrap';wrap.style.maxHeight='190px';
  function buildNR(){
    wrap.innerHTML='';m.cellEls=[];
    const g=document.createElement('div');g.className='nr-grid';g.style.gridTemplateColumns=`28px repeat(${m.ts},1fr)`;g.style.gridTemplateRows=`repeat(${ROWS},14px)`;
    for(let r=0;r<ROWS;r++){
      const noteIdx=ROWS-1-r;
      const lbl=document.createElement('div');lbl.className='nr-label';lbl.textContent=NN[noteIdx%12]+(m.oct+Math.floor(noteIdx/12));
      if([1,3,6,8,10].includes(noteIdx%12))lbl.style.background='var(--s3)';
      lbl.style.gridRow=r+1;lbl.style.gridColumn=1;g.appendChild(lbl);
      const rowEls=[];
      for(let c=0;c<m.ts;c++){
        const cell=document.createElement('div');cell.className='nr-cell'+(c%4===0?' bar':'');
        if([1,3,6,8,10].includes(noteIdx%12))cell.style.background='rgba(255,255,255,.015)';
        cell.style.gridRow=r+1;cell.style.gridColumn=c+2;
        if(grid[r][c]){cell.classList.add('on');cell.style.background='rgba(251,191,36,.55)'}
        cell.addEventListener('mousedown',e=>{e.preventDefault();grid[r][c]=!grid[r][c];m.dragVal=grid[r][c];
          cell.classList.toggle('on');cell.style.background=grid[r][c]?'rgba(251,191,36,.55)':([1,3,6,8,10].includes(noteIdx%12)?'rgba(255,255,255,.015)':'');
          if(grid[r][c]){initA();m.playAt(noteIdx,ctx.currentTime)}});
        cell.addEventListener('mouseenter',()=>{if(m.dragVal===null)return;grid[r][c]=m.dragVal;cell.classList.toggle('on',m.dragVal);
          cell.style.background=m.dragVal?'rgba(251,191,36,.55)':([1,3,6,8,10].includes(noteIdx%12)?'rgba(255,255,255,.015)':'')});
        g.appendChild(cell);rowEls.push(cell)}
      m.cellEls.push(rowEls)}
    wrap.appendChild(g);
    window.addEventListener('mouseup',()=>{m.dragVal=null})}
  buildNR();bd.appendChild(wrap);
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === SAMPLE MODULE — Launchpad ===
function addSample(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('SAMPLE<span>.EXE</span>','Launchpad','#34d399',560+(mods.length%4)*30,320+(mods.length%4)*20,380,310,ci);
  el.id='m'+id;
  const PAD_COLORS=['#e8364f','#f59e0b','#22d3ee','#a855f7','#f97316','#06b6d4','#10b981','#ec4899','#818cf8','#34d399','#fbbf24','#fb923c','#ef4444','#14b8a6','#8b5cf6','#f43f5e'];
  const PADS=16;
  const m={id,type:'sample',el,ci,ts:0,slots:new Array(PADS).fill(null),onStep:()=>{},clr:()=>{}};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // drop zone (compact)
  const drop=document.createElement('div');drop.className='smp-drop';drop.style.cssText='padding:6px;min-height:24px;font-size:6px;margin-bottom:6px';
  drop.textContent='⬆ Drop audio files to fill pads';
  const fin=document.createElement('input');fin.type='file';fin.accept='audio/*';fin.multiple=true;fin.style.display='none';
  drop.addEventListener('click',()=>fin.click());
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over')});
  drop.addEventListener('dragleave',()=>drop.classList.remove('over'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');loadF(e.dataTransfer.files)});
  fin.addEventListener('change',()=>{if(fin.files.length)loadF(fin.files)});
  bd.appendChild(drop);bd.appendChild(fin);
  // 4x4 grid
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:repeat(4,1fr);gap:4px';
  const padEls=[];
  for(let i=0;i<PADS;i++){
    const pad=document.createElement('div');
    pad.style.cssText=`height:46px;background:var(--s2);border:2px solid var(--border);border-radius:5px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .08s;position:relative;overflow:hidden`;
    const num=document.createElement('span');num.style.cssText='font-size:8px;font-weight:800;color:rgba(255,255,255,.12);pointer-events:none';num.textContent=i+1;
    const nm=document.createElement('span');nm.style.cssText='font-size:5px;color:var(--dim);pointer-events:none;max-width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
    pad.append(num,nm);
    // play on click
    pad.addEventListener('mousedown',e=>{e.preventDefault();trigPad(i)});
    // right-click to assign file to specific pad
    pad.addEventListener('contextmenu',e=>{e.preventDefault();
      const inp=document.createElement('input');inp.type='file';inp.accept='audio/*';
      inp.addEventListener('change',()=>{if(inp.files[0])loadToPad(i,inp.files[0])});inp.click()});
    grid.appendChild(pad);padEls.push({pad,num,nm});
  }
  bd.appendChild(grid);
  function loadF(files){
    let idx=m.slots.findIndex(s=>s===null);
    Array.from(files).forEach(f=>{
      if(idx>=PADS)return;
      const si=idx;idx=m.slots.findIndex((s,j)=>j>si&&s===null);if(idx<0)idx=PADS;
      loadToPad(si,f)})}
  function loadToPad(i,file){
    const r=new FileReader();
    r.onload=async()=>{initA();const buf=await ctx.decodeAudioData(r.result);
      m.slots[i]={name:file.name.replace(/\.[^.]+$/,'').slice(0,10),buf,src:null};
      updPad(i)};
    r.readAsArrayBuffer(file)}
  function updPad(i){
    const p=padEls[i],s=m.slots[i];
    if(s){p.pad.style.borderColor=PAD_COLORS[i];p.nm.textContent=s.name;p.num.style.color=PAD_COLORS[i]}
    else{p.pad.style.borderColor='var(--border)';p.nm.textContent='';p.num.style.color='rgba(255,255,255,.12)';p.pad.style.background='var(--s2)'}}
  function trigPad(i){
    initA();const s=m.slots[i];if(!s)return;
    if(s.src){try{s.src.stop()}catch(e){}}
    s.src=ctx.createBufferSource();s.src.buffer=s.buf;s.src.connect(m.dst());s.src.start();
    const p=padEls[i].pad;p.style.background=PAD_COLORS[i];p.style.boxShadow='0 0 16px '+PAD_COLORS[i]+'60';
    p.style.transform='scale(.95)';
    s.src.onended=()=>{p.style.background='var(--s2)';p.style.boxShadow='none';p.style.transform=''};
    setTimeout(()=>{p.style.transform=''},100)}
  m.updPad=updPad;m.trigPad=trigPad;
  // keyboard: top 2 rows = 1234 qwer, bottom 2 = asdf zxcv
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='Grid keys';kbb.textContent='⌨';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const KMAP={'1':0,'2':1,'3':2,'4':3,'q':4,'w':5,'e':6,'r':7,'a':8,'s':9,'d':10,'f':11,'z':12,'x':13,'c':14,'v':15};
  const kd=e=>{if(e.repeat||_kb!==id)return;const i=KMAP[e.key.toLowerCase()];if(i!==undefined)trigPad(i)};
  window.addEventListener('keydown',kd);
  m.destroy=()=>{window.removeEventListener('keydown',kd);if(_kb===id)_kb=null;
    m.slots.forEach(s=>{if(s&&s.src){try{s.src.stop()}catch(e){}}})};
  // clear pad on middle-click or add clear all button
  const clrBtn=document.createElement('button');clrBtn.className='pbtn';clrBtn.style.cssText='margin-top:4px;font-size:6px';clrBtn.textContent='CLEAR ALL';
  clrBtn.addEventListener('click',()=>{m.slots.forEach((s,i)=>{if(s&&s.src){try{s.src.stop()}catch(e){}}m.slots[i]=null;updPad(i)})});
  bd.appendChild(clrBtn);
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === TAPE MODULE — mic looper ===
function addTape(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('TAPE<span>.EXE</span>','Looper','#fb923c',700+(mods.length%4)*30,380+(mods.length%4)*20,360,180,ci);
  el.id='m'+id;
  const m={id,type:'tape',el,ci,ts:0,onStep:()=>{},clr:()=>{},
    stream:null,mr:null,chunks:[],buf:null,src:null,rec:false,loop:false};
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const viz=document.createElement('div');viz.className='tape-viz';
  const cvs=document.createElement('canvas');cvs.id='tc'+id;viz.appendChild(cvs);bd.appendChild(viz);
  const btns=document.createElement('div');btns.className='tape-btns';
  const recBtn=document.createElement('button');recBtn.className='tape-btn rec';recBtn.innerHTML='● REC';
  const playBtn=document.createElement('button');playBtn.className='tape-btn';playBtn.innerHTML='▶ PLAY';
  const loopBtn=document.createElement('button');loopBtn.className='tape-btn';loopBtn.innerHTML='⟳ LOOP';
  const clrBtn=document.createElement('button');clrBtn.className='tape-btn';clrBtn.innerHTML='✕ CLR';
  recBtn.addEventListener('click',async()=>{
    if(m.rec){m.mr.stop();m.rec=false;recBtn.classList.remove('active');return}
    try{m.stream=await navigator.mediaDevices.getUserMedia({audio:true});
      m.mr=new MediaRecorder(m.stream);m.chunks=[];
      m.mr.ondataavailable=e=>{if(e.data.size>0)m.chunks.push(e.data)};
      m.mr.onstop=async()=>{m.stream.getTracks().forEach(t=>t.stop());
        const blob=new Blob(m.chunks,{type:'audio/webm'});const ab=await blob.arrayBuffer();
        initA();m.buf=await ctx.decodeAudioData(ab);drawW()};
      m.mr.start();m.rec=true;recBtn.classList.add('active');
    }catch(e){recBtn.textContent='⚠ NO MIC'}});
  playBtn.addEventListener('click',()=>{if(!m.buf||!ctx)return;stopSrc();
    m.src=ctx.createBufferSource();m.src.buffer=m.buf;m.src.connect(m.dst());m.src.loop=false;m.src.start()});
  loopBtn.addEventListener('click',()=>{if(!m.buf||!ctx)return;m.loop=!m.loop;
    loopBtn.style.background=m.loop?'#fb923c':'';loopBtn.style.color=m.loop?'#fff':'';
    if(m.loop){stopSrc();m.src=ctx.createBufferSource();m.src.buffer=m.buf;m.src.connect(m.dst());m.src.loop=true;m.src.start()}
    else stopSrc()});
  clrBtn.addEventListener('click',()=>{stopSrc();m.buf=null;m.loop=false;loopBtn.style.background='';loopBtn.style.color='';drawW()});
  function stopSrc(){if(m.src){try{m.src.stop()}catch(e){}}m.src=null}
  btns.append(recBtn,playBtn,loopBtn,clrBtn);bd.appendChild(btns);
  function drawW(){
    const c=document.getElementById('tc'+id);if(!c)return;const x=c.getContext('2d');
    c.width=c.parentElement.clientWidth;c.height=c.parentElement.clientHeight;
    x.clearRect(0,0,c.width,c.height);
    if(!m.buf){x.fillStyle='rgba(255,255,255,.03)';x.fillRect(0,0,c.width,c.height);
      x.fillStyle='rgba(255,255,255,.1)';x.font='8px JetBrains Mono';x.textAlign='center';x.fillText('No recording',c.width/2,c.height/2+3);return}
    const data=m.buf.getChannelData(0),step=Math.ceil(data.length/c.width);
    x.beginPath();x.strokeStyle='#fb923c';x.lineWidth=1;
    for(let i=0;i<c.width;i++){let min=1,max=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<min)min=v;if(v>max)max=v}
      const yMin=(1+min)/2*c.height,yMax=(1+max)/2*c.height;
      x.moveTo(i,yMin);x.lineTo(i,yMax)}
    x.stroke();
    x.fillStyle='rgba(251,146,60,.15)';x.fill();
    const dur=m.buf.duration.toFixed(1);
    x.fillStyle='rgba(255,255,255,.3)';x.font='7px JetBrains Mono';x.textAlign='right';x.fillText(dur+'s',c.width-4,10)}
  m.destroy=()=>{stopSrc();if(m.stream)m.stream.getTracks().forEach(t=>t.stop())};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === DRUM MODULE — full drum machine ===
function addDrum(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('DRUM<span>.EXE</span>','Machine','#f97316',20+(mods.length%4)*30,40+(mods.length%4)*20,880,380,ci);
  el.id='m'+id;
  // === SOUND LIBRARY ===
  const DS={
    kick:{'808':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(160,t);o.frequency.exponentialRampToValueAtTime(40,t+.12);g.gain.setValueAtTime(v*1.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)},'Punchy':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(50,t+.06);g.gain.setValueAtTime(v*1.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)},'Deep':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(25,t+.2);g.gain.setValueAtTime(v*1.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.55);o.start(t);o.stop(t+.55)},'Tight':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='triangle';o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(60,t+.04);g.gain.setValueAtTime(v*1.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}},
    snare:{'Crack':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.15,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=1000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);n.start(t);n.stop(t+.15);let o=c.createOscillator(),g2=c.createGain();o.connect(g2);g2.connect(d);o.type='triangle';o.frequency.setValueAtTime(200,t);g2.gain.setValueAtTime(v*.5,t);g2.gain.exponentialRampToValueAtTime(.001,t+.06);o.start(t);o.stop(t+.06)},'Tight':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.08,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=3000;f.Q.value=2;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);n.start(t);n.stop(t+.08)},'LoFi':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.12,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/a.length,.5);let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='lowpass';f.frequency.value=4000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);n.start(t);n.stop(t+.12)}},
    hh:{'Closed':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.05,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=8000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.05);n.start(t);n.stop(t+.05)},'Open':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.22,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=6000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.28,t);g.gain.exponentialRampToValueAtTime(.001,t+.22);n.start(t);n.stop(t+.22)},'Crispy':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.035,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=10000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.4,t);g.gain.exponentialRampToValueAtTime(.001,t+.035);n.start(t);n.stop(t+.035)}},
    clap:{'Tight':(t,v,c,d)=>{for(let i=0;i<3;i++){let tt=t+i*.008,b=c.createBuffer(1,c.sampleRate*.03,c.sampleRate),a=b.getChannelData(0);for(let j=0;j<a.length;j++)a[j]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=2500;f.Q.value=3;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.5,tt);g.gain.exponentialRampToValueAtTime(.001,tt+.08);n.start(tt);n.stop(tt+.08)}},'Snap':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.02,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=Math.random()*2-1;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=4000;f.Q.value=5;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.7,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);n.start(t);n.stop(t+.04)}},
    rim:{'Click':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='triangle';o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(300,t+.02);g.gain.setValueAtTime(v*.5,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);o.start(t);o.stop(t+.04)},'Wood':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(1000,t);o.frequency.exponentialRampToValueAtTime(500,t+.015);g.gain.setValueAtTime(v*.45,t);g.gain.exponentialRampToValueAtTime(.001,t+.03);o.start(t);o.stop(t+.03)}},
    perc:{'Conga':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(350,t);o.frequency.exponentialRampToValueAtTime(150,t+.08);g.gain.setValueAtTime(v*.6,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15)},'Cowbell':(t,v,c,d)=>{let o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain();o.connect(g);o2.connect(g);g.connect(d);o.type='square';o2.type='square';o.frequency.value=587;o2.frequency.value=845;g.gain.setValueAtTime(v*.25,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);o.start(t);o.stop(t+.1);o2.start(t);o2.stop(t+.1)},'Shaker':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.04,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=(Math.random()*2-1)*.7;let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=6000;f.Q.value=1;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.35,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);n.start(t);n.stop(t+.04)}},
    crash:{'Crash':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.6,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/a.length,.4);let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=4000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.6);n.start(t);n.stop(t+.6)}},
    ride:{'Ride':(t,v,c,d)=>{let b=c.createBuffer(1,c.sampleRate*.35,c.sampleRate),a=b.getChannelData(0);for(let i=0;i<a.length;i++)a[i]=(Math.random()*2-1)*Math.pow(1-i/a.length,.6);let n=c.createBufferSource();n.buffer=b;let f=c.createBiquadFilter();f.type='highpass';f.frequency.value=7000;let g=c.createGain();n.connect(f);f.connect(g);g.connect(d);g.gain.setValueAtTime(v*.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);n.start(t);n.stop(t+.35)},'Bell':(t,v,c,d)=>{let o=c.createOscillator(),o2=c.createOscillator(),g=c.createGain();o.connect(g);o2.connect(g);g.connect(d);o.type='sine';o2.type='sine';o.frequency.value=2500;o2.frequency.value=3700;g.gain.setValueAtTime(v*.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);o2.start(t);o2.stop(t+.2)}},
    tomhi:{'High':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(120,t+.12);g.gain.setValueAtTime(v*.8,t);g.gain.exponentialRampToValueAtTime(.001,t+.18);o.start(t);o.stop(t+.18)}},
    tomlo:{'Floor':(t,v,c,d)=>{let o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(d);o.type='sine';o.frequency.setValueAtTime(140,t);o.frequency.exponentialRampToValueAtTime(50,t+.2);g.gain.setValueAtTime(v*.85,t);g.gain.exponentialRampToValueAtTime(.001,t+.3);o.start(t);o.stop(t+.3)}}
  };
  // === PARTS CONFIG ===
  const PARTS=[
    {name:'KICK',cat:'kick',snd:'808',col:'#e8364f',v:.9},
    {name:'SNARE',cat:'snare',snd:'Crack',col:'#f59e0b',v:.8},
    {name:'HH',cat:'hh',snd:'Closed',col:'#22d3ee',v:.65},
    {name:'OH',cat:'hh',snd:'Open',col:'#06b6d4',v:.55},
    {name:'CLAP',cat:'clap',snd:'Tight',col:'#a855f7',v:.7},
    {name:'RIM',cat:'rim',snd:'Click',col:'#f472b6',v:.6},
    {name:'PERC',cat:'perc',snd:'Cowbell',col:'#fb923c',v:.55},
    {name:'CRASH',cat:'crash',snd:'Crash',col:'#818cf8',v:.4},
    {name:'RIDE',cat:'ride',snd:'Ride',col:'#34d399',v:.45},
    {name:'TOM H',cat:'tomhi',snd:'High',col:'#fbbf24',v:.65}
  ];
  const NP=PARTS.length;
  // === PATTERN SYSTEM: 4 patterns (A/B/C/D) ===
  const NPAT=4,mkPat=()=>({steps:16,grid:Array.from({length:NP},()=>new Array(64).fill(0))});
  // vel: 0=off, 1=ghost(.4), 2=normal(1), 3=accent(1.4)
  const pats=[mkPat(),mkPat(),mkPat(),mkPat()];
  let curPat=0,chain=[0],chainIdx=0,chainMode=false;
  const m={id,type:'drum',el,ci,ts:16,se:[],parts:PARTS.map(p=>({...p,mut:false,solo:false,prob:100,swing:0,hum:0}))};
  m.dst=()=>chs[m.ci].g||mGain;
  m.aud=(i)=>{const a=m.parts.some(p=>p.solo);return a?m.parts[i].solo&&!m.parts[i].mut:!m.parts[i].mut};
  m.snd=(p)=>DS[p.cat][p.snd];
  const VMUL=[0,.4,1,1.4];
  m.onStep=(s,t)=>{
    const pat=pats[chainMode?chain[chainIdx%chain.length]:curPat];
    const ns=pat.steps,step=s%ns;
    if(chainMode&&s>0&&step===0)chainIdx++;
    const cpat=pats[chainMode?chain[chainIdx%chain.length]:curPat];
    m.ts=cpat.steps;
    const dest=m.dst();
    m.parts.forEach((p,i)=>{
      const vel=cpat.grid[i][step];
      if(vel>0&&m.aud(i)){
        if(p.prob<100&&Math.random()*100>p.prob)return;
        let tt=t;
        if(p.hum>0)tt+=((Math.random()-.5)*p.hum*.02);
        m.snd(p)(tt,p.v*VMUL[vel],ctx,dest)}});
    m.se.forEach((row,ri)=>row.forEach((e,si)=>{
      e.classList.toggle('current',si===step);
    }))};
  m.clr=()=>{m.se.forEach(r=>r.forEach(e=>e.classList.remove('current')));chainIdx=0};
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // === UI ===
  const cfg=document.createElement('div');cfg.className='bcfg';cfg.style.gap='3px';
  // step count toggle
  const stog=document.createElement('div');stog.className='stog';
  [16,32,64].forEach(n=>{const b=document.createElement('button');b.textContent=n;b.className=n===16?'active':'';
    b.addEventListener('click',()=>{pats[curPat].steps=n;m.ts=n;stog.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===n));buildGrid()});stog.appendChild(b)});
  cfg.appendChild(stog);
  // pattern selector A/B/C/D
  const ptog=document.createElement('div');ptog.className='stog';
  const plab=['A','B','C','D'];
  plab.forEach((l,i)=>{const b=document.createElement('button');b.textContent=l;b.className=i===0?'active':'';
    b.addEventListener('click',()=>{curPat=i;m.ts=pats[i].steps;ptog.querySelectorAll('button').forEach(x=>x.classList.remove('active'));b.classList.add('active');
      stog.querySelectorAll('button').forEach(x=>x.classList.toggle('active',+x.textContent===pats[i].steps));buildGrid()});ptog.appendChild(b)});
  cfg.appendChild(ptog);
  // chain mode
  const chainBtn=document.createElement('button');chainBtn.className='pbtn';chainBtn.textContent='CHAIN';
  chainBtn.addEventListener('click',()=>{chainMode=!chainMode;chainIdx=0;chainBtn.style.background=chainMode?'#f97316':'';chainBtn.style.color=chainMode?'#fff':''});
  cfg.appendChild(chainBtn);
  // chain editor
  const chainInp=document.createElement('input');chainInp.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:2px 4px;border-radius:2px;width:60px';
  chainInp.value='A';chainInp.title='Chain: e.g. ABAB or AABA';
  chainInp.addEventListener('input',()=>{const map={A:0,B:1,C:2,D:3};chain=chainInp.value.toUpperCase().split('').filter(c=>map[c]!==undefined).map(c=>map[c]);if(!chain.length)chain=[0]});
  cfg.appendChild(chainInp);
  // euclidean generator
  const eucBtn=document.createElement('button');eucBtn.className='pbtn';eucBtn.textContent='EUCLID';
  eucBtn.addEventListener('click',()=>{const cp=pats[curPat];
    m.parts.forEach((p,i)=>{const hits=Math.floor(Math.random()*Math.min(8,cp.steps))+1;
      const pat=euclidean(hits,cp.steps);
      for(let s=0;s<cp.steps;s++)cp.grid[i][s]=pat[s]?2:0});buildGrid()});
  cfg.appendChild(eucBtn);
  const clrBtn=document.createElement('button');clrBtn.className='pbtn';clrBtn.textContent='CLR';
  clrBtn.addEventListener('click',()=>{pats[curPat].grid.forEach(r=>r.fill(0));buildGrid()});
  cfg.appendChild(clrBtn);
  bd.appendChild(cfg);
  // === GRID ===
  const gridWrap=document.createElement('div');gridWrap.style.cssText='overflow:auto;max-height:260px';
  function buildGrid(){
    gridWrap.innerHTML='';m.se=[];
    const cp=pats[curPat],ns=cp.steps;
    // step numbers
    const nums=document.createElement('div');nums.className='bnums';nums.style.paddingLeft='210px';
    for(let s=0;s<ns;s++){const n=document.createElement('div');n.className='bnum'+(s%4===0?' bb':'');n.textContent=s+1;nums.appendChild(n)}
    gridWrap.appendChild(nums);
    // rows
    m.parts.forEach((p,pi)=>{
      const row=document.createElement('div');row.className='br';
      const lb=document.createElement('div');lb.className='bl';
      const nm=document.createElement('span');nm.className='bn';nm.style.color=p.col;nm.textContent=p.name;
      const mt=document.createElement('div');mt.className='bm'+(p.mut?' muted':'');mt.textContent='M';
      mt.addEventListener('click',()=>{p.mut=!p.mut;mt.classList.toggle('muted')});
      const so=document.createElement('div');so.className='bs_btn'+(p.solo?' soloed':'');so.textContent='S';
      so.addEventListener('click',()=>{p.solo=!p.solo;so.classList.toggle('soloed')});
      const vl=document.createElement('input');vl.type='range';vl.className='bv';vl.min=0;vl.max=100;vl.value=p.v*100;
      vl.addEventListener('input',()=>{p.v=vl.value/100});
      const ssel=document.createElement('select');ssel.className='bsel';
      Object.keys(DS[p.cat]).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if(p.snd===s)o.selected=true;ssel.appendChild(o)});
      ssel.addEventListener('change',()=>{p.snd=ssel.value});
      const prob=document.createElement('input');prob.type='range';prob.className='bv';prob.min=0;prob.max=100;prob.value=p.prob;prob.title='Prob %';
      prob.addEventListener('input',()=>{p.prob=+prob.value});
      const hum=document.createElement('input');hum.type='range';hum.className='bv';hum.min=0;hum.max=100;hum.value=p.hum;hum.title='Humanize';
      hum.addEventListener('input',()=>{p.hum=+hum.value});
      lb.append(nm,mt,so,vl,ssel,prob,hum);row.appendChild(lb);
      // steps
      const sc=document.createElement('div');sc.className='bsteps';const sr=[];
      for(let s=0;s<ns;s++){
        const st=document.createElement('div');st.className='bstep'+(s%4===0?' bm4':'');
        updStepVis(st,cp.grid[pi][s],p.col);
        // left click cycles: off→normal→accent→ghost→off
        st.addEventListener('mousedown',e=>{e.preventDefault();
          if(e.button===0){const cycle=[0,2,3,1];const cur=cp.grid[pi][s];const ci2=cycle.indexOf(cur);
            cp.grid[pi][s]=cycle[(ci2+1)%4];
            updStepVis(st,cp.grid[pi][s],p.col);
            if(cp.grid[pi][s]>0&&m.aud(pi)){initA();m.snd(p)(ctx.currentTime,p.v*VMUL[cp.grid[pi][s]],ctx,m.dst())}}});
        // right click to clear
        st.addEventListener('contextmenu',e=>{e.preventDefault();cp.grid[pi][s]=0;updStepVis(st,0,p.col)});
        sc.appendChild(st);sr.push(st)}
      row.appendChild(sc);m.se.push(sr);gridWrap.appendChild(row)})}
  function updStepVis(el,vel,col){
    el.classList.toggle('on',vel>0);
    if(vel===0){el.style.background='';el.style.borderColor='';el.style.opacity=''}
    else if(vel===1){el.style.background=col;el.style.borderColor=col;el.style.opacity='.35'}// ghost
    else if(vel===2){el.style.background=col;el.style.borderColor=col;el.style.opacity='.75'}// normal
    else if(vel===3){el.style.background=col;el.style.borderColor=col;el.style.opacity='1'}// accent
  }
  function euclidean(k,n){
    const p=[];let b=Array.from({length:k},()=>[1]),r=Array.from({length:n-k},()=>[0]);
    while(r.length>1){const nb=[],nr=[];const mn=Math.min(b.length,r.length);
      for(let i=0;i<mn;i++)nb.push([...b[i],...r[i]]);
      if(b.length>mn)nr.push(...b.slice(mn));else nr.push(...r.slice(mn));
      b=nb;r=nr}
    b.concat(r).forEach(x=>p.push(...x));return p}
  buildGrid();bd.appendChild(gridWrap);
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === CHORD MODULE — progression builder ===
function addChord(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('CHORD<span>.EXE</span>','Chords','#14b8a6',300+(mods.length%4)*30,100+(mods.length%4)*20,520,240,ci);
  el.id='m'+id;
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const CHORDS={
    maj:[0,4,7],min:[0,3,7],maj7:[0,4,7,11],min7:[0,3,7,10],dom7:[0,4,7,10],
    dim:[0,3,6],aug:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],add9:[0,4,7,14]
  };
  const PROGS={
    'I-V-vi-IV':[{r:0,t:'maj'},{r:7,t:'maj'},{r:9,t:'min'},{r:5,t:'maj'}],
    'ii-V-I':[{r:2,t:'min7'},{r:7,t:'dom7'},{r:0,t:'maj7'},{r:0,t:'maj7'}],
    'I-vi-IV-V':[{r:0,t:'maj'},{r:9,t:'min'},{r:5,t:'maj'},{r:7,t:'maj'}],
    'vi-IV-I-V':[{r:9,t:'min'},{r:5,t:'maj'},{r:0,t:'maj'},{r:7,t:'maj'}],
    'i-VI-III-VII':[{r:0,t:'min'},{r:8,t:'maj'},{r:3,t:'maj'},{r:10,t:'maj'}],
    'I-IV-vi-V':[{r:0,t:'maj'},{r:5,t:'maj'},{r:9,t:'min'},{r:7,t:'maj'}],
    '12 Bar':[{r:0,t:'maj'},{r:0,t:'maj'},{r:5,t:'maj'},{r:0,t:'maj'}]
  };
  const m={id,type:'chord',el,ci,ts:16,oct:4,vol:.3,wv:'sawtooth',det:8,a:.02,d:.15,s:.5,r:.3,slots:[
    {root:0,type:'maj'},{root:7,type:'maj'},{root:9,type:'min'},{root:5,type:'maj'}
  ],stepsPerChord:4};
  m.dst=()=>chs[m.ci].g||mGain;
  m.nf=(n,o)=>440*Math.pow(2,(n-9)/12+(o-4));
  m.playChord=(slot,t)=>{if(!ctx)return;const dest=m.dst(),notes=CHORDS[slot.type];if(!notes)return;
    notes.forEach(n=>{const freq=m.nf((slot.root+n)%12,m.oct+Math.floor((slot.root+n)/12));
      const o1=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),f=ctx.createBiquadFilter();
      o1.type=m.wv;o1.frequency.value=freq;o2.type=m.wv;o2.frequency.value=freq;o2.detune.value=m.det;
      f.type='lowpass';f.frequency.value=2500;f.Q.value=.5;o1.connect(f);o2.connect(f);f.connect(g);g.connect(dest);
      const dur=m.a+m.d+m.r+.1;
      g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(m.vol/notes.length,t+m.a);
      g.gain.linearRampToValueAtTime(m.vol*m.s/notes.length,t+m.a+m.d);g.gain.linearRampToValueAtTime(0,t+m.a+m.d+m.r);
      o1.start(t);o1.stop(t+dur);o2.start(t);o2.stop(t+dur)})};
  m.onStep=(s,t)=>{const ci2=Math.floor(s/m.stepsPerChord)%m.slots.length;
    if(s%m.stepsPerChord===0)m.playChord(m.slots[ci2],t);
    slotEls.forEach((e,i)=>e.classList.toggle('active',i===ci2))};
  m.clr=()=>slotEls.forEach(e=>e.classList.remove('active'));
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  // controls
  const ctrl=document.createElement('div');ctrl.className='piano-ctrl';
  const wsel=document.createElement('div');wsel.className='sws';
  ['sawtooth','square','triangle','sine'].forEach(w=>{const b=document.createElement('button');b.className='swb'+(m.wv===w?' active':'');b.textContent=w==='sawtooth'?'SAW':w.slice(0,3).toUpperCase();
    b.addEventListener('click',()=>{m.wv=w;wsel.querySelectorAll('.swb').forEach(x=>x.classList.remove('active'));b.classList.add('active')});wsel.appendChild(b)});
  ctrl.appendChild(wsel);
  ctrl.append(mkK('Oct',2,6,m.oct,v=>{m.oct=Math.round(v)},1),mkK('Vol',0,100,m.vol*100,v=>{m.vol=v/100}));
  bd.appendChild(ctrl);
  // progression presets
  const pbar=document.createElement('div');pbar.className='bcfg';pbar.style.flexWrap='wrap';
  Object.keys(PROGS).forEach(name=>{const b=document.createElement('button');b.className='pbtn';b.textContent=name;
    b.addEventListener('click',()=>{m.slots=PROGS[name].map(p=>({...p,root:p.r,type:p.t}));renSlots()});pbar.appendChild(b)});
  bd.appendChild(pbar);
  // chord slots
  const slotsWrap=document.createElement('div');slotsWrap.style.cssText='display:flex;gap:4px;flex-wrap:wrap';
  const slotEls=[];
  function renSlots(){
    slotsWrap.innerHTML='';slotEls.length=0;
    m.slots.forEach((slot,i)=>{
      const s=document.createElement('div');
      s.style.cssText='background:var(--s2);border:2px solid var(--border);border-radius:5px;padding:6px 8px;flex:1;min-width:90px;cursor:pointer;transition:all .15s';
      const hd=document.createElement('div');hd.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:4px';
      const nm=document.createElement('span');nm.style.cssText='font-size:10px;font-weight:800;color:#fff';nm.textContent=NN[slot.root]+' '+slot.type;
      const num=document.createElement('span');num.style.cssText='font-size:6px;color:var(--dim)';num.textContent=i+1;
      hd.append(num,nm);s.appendChild(hd);
      // root selector
      const rsel=document.createElement('select');rsel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:1px;border-radius:2px;width:100%;margin-bottom:2px';
      NN.forEach((n,ni)=>{const o=document.createElement('option');o.value=ni;o.textContent=n;if(ni===slot.root)o.selected=true;rsel.appendChild(o)});
      rsel.addEventListener('change',()=>{slot.root=+rsel.value;nm.textContent=NN[slot.root]+' '+slot.type});
      s.appendChild(rsel);
      // type selector
      const tsel=document.createElement('select');tsel.style.cssText='background:var(--s3);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:7px;padding:1px;border-radius:2px;width:100%';
      Object.keys(CHORDS).forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(t===slot.type)o.selected=true;tsel.appendChild(o)});
      tsel.addEventListener('change',()=>{slot.type=tsel.value;nm.textContent=NN[slot.root]+' '+slot.type});
      s.appendChild(tsel);
      // click to preview
      s.addEventListener('click',e=>{if(e.target.tagName==='SELECT')return;initA();m.playChord(slot,ctx.currentTime)});
      slotsWrap.appendChild(s);slotEls.push(s)});
    // add/remove buttons
    const ab=document.createElement('div');ab.style.cssText='display:flex;flex-direction:column;gap:2px;justify-content:center';
    const addB=document.createElement('button');addB.className='pbtn';addB.textContent='+';addB.style.fontSize='10px';
    addB.addEventListener('click',()=>{if(m.slots.length<8){m.slots.push({root:0,type:'maj'});m.ts=m.slots.length*m.stepsPerChord;renSlots()}});
    const rmB=document.createElement('button');rmB.className='pbtn';rmB.textContent='−';rmB.style.fontSize='10px';
    rmB.addEventListener('click',()=>{if(m.slots.length>2){m.slots.pop();m.ts=m.slots.length*m.stepsPerChord;renSlots()}});
    ab.append(addB,rmB);slotsWrap.appendChild(ab);
    m.ts=m.slots.length*m.stepsPerChord}
  renSlots();bd.appendChild(slotsWrap);
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === EDIT MODULE — audio editor ===
function addEdit(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('EDIT<span>.EXE</span>','Editor','#06b6d4',400+(mods.length%4)*30,340+(mods.length%4)*20,520,320,ci);
  el.id='m'+id;
  const m={id,type:'edit',el,ci,ts:0,buf:null,edited:null,src:null,rate:1,onStep:()=>{},clr:()=>{}};
  let sL=0,sR=1;
  m.dst=()=>chs[m.ci].g||mGain;
  sel.addEventListener('change',()=>{m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);filt()});
  const drop=document.createElement('div');drop.className='smp-drop';drop.style.cssText='padding:6px;min-height:20px;font-size:6px;margin-bottom:3px';
  drop.textContent='\u2b06 Drop audio file to edit';
  const fin=document.createElement('input');fin.type='file';fin.accept='audio/*';fin.style.display='none';
  drop.addEventListener('click',()=>fin.click());
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('over')});
  drop.addEventListener('dragleave',()=>drop.classList.remove('over'));
  drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('over');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])});
  fin.addEventListener('change',()=>{if(fin.files[0])loadFile(fin.files[0])});
  bd.appendChild(drop);bd.appendChild(fin);
  const finfo=document.createElement('div');finfo.style.cssText='font-size:5px;color:var(--dim);padding:0 0 2px 2px;display:none';
  bd.appendChild(finfo);
  const vizWrap=document.createElement('div');vizWrap.style.cssText='position:relative;height:90px;background:var(--s2);border:1px solid var(--border);border-radius:3px;margin-bottom:3px;overflow:hidden;user-select:none';
  const cvs=document.createElement('canvas');cvs.style.cssText='width:100%;height:100%';
  const dimL=document.createElement('div');dimL.style.cssText='position:absolute;top:0;left:0;height:100%;background:rgba(0,0,0,.5);pointer-events:none';
  const dimR=document.createElement('div');dimR.style.cssText='position:absolute;top:0;right:0;height:100%;background:rgba(0,0,0,.5);pointer-events:none';
  const selBg=document.createElement('div');selBg.style.cssText='position:absolute;top:0;height:100%;background:rgba(6,182,212,.08);pointer-events:none';
  const hL=document.createElement('div');hL.style.cssText='position:absolute;top:0;width:8px;height:100%;cursor:ew-resize;z-index:2;display:flex;align-items:center;justify-content:center';
  hL.innerHTML='<div style="width:3px;height:24px;background:#06b6d4;border-radius:2px;box-shadow:0 0 6px #06b6d488"></div>';
  const hR=document.createElement('div');hR.style.cssText='position:absolute;top:0;width:8px;height:100%;cursor:ew-resize;z-index:2;display:flex;align-items:center;justify-content:center';
  hR.innerHTML='<div style="width:3px;height:24px;background:#06b6d4;border-radius:2px;box-shadow:0 0 6px #06b6d488"></div>';
  const cur=document.createElement('div');cur.style.cssText='position:absolute;top:0;width:2px;height:100%;background:#fff;pointer-events:none;display:none';
  const tL=document.createElement('div');tL.style.cssText='position:absolute;bottom:2px;font-size:6px;font-weight:700;color:#06b6d4;pointer-events:none';
  const tR=document.createElement('div');tR.style.cssText='position:absolute;bottom:2px;font-size:6px;font-weight:700;color:#06b6d4;pointer-events:none';
  const tDur=document.createElement('div');tDur.style.cssText='position:absolute;top:2px;right:4px;font-size:5px;color:var(--dim);pointer-events:none';
  const flsh=document.createElement('div');flsh.style.cssText='position:absolute;inset:0;background:rgba(6,182,212,.25);pointer-events:none;opacity:0;transition:opacity .15s';
  vizWrap.append(cvs,dimL,dimR,selBg,hL,hR,cur,tL,tR,tDur,flsh);bd.appendChild(vizWrap);
  function doFlash(){flsh.style.opacity='1';setTimeout(()=>{flsh.style.opacity='0'},150)}
  let dragH=null;
  hL.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();dragH='L'});
  hR.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();dragH='R'});
  vizWrap.addEventListener('mousedown',e=>{if(!m.edited||dragH)return;
    const x=(e.clientX-vizWrap.getBoundingClientRect().left)/vizWrap.clientWidth;
    if(Math.abs(x-sL)<Math.abs(x-sR)){sL=Math.max(0,Math.min(sR-.01,x));dragH='L'}
    else{sR=Math.max(sL+.01,Math.min(1,x));dragH='R'}updSel()});
  window.addEventListener('mousemove',e=>{if(!dragH||!m.edited)return;
    const x=Math.max(0,Math.min(1,(e.clientX-vizWrap.getBoundingClientRect().left)/vizWrap.clientWidth));
    if(dragH==='L')sL=Math.min(sR-.01,x);else sR=Math.max(sL+.01,x);updSel()});
  window.addEventListener('mouseup',()=>{dragH=null});
  function updSel(){hL.style.left=(sL*100-1)+'%';hR.style.left=(sR*100-1)+'%';
    dimL.style.width=(sL*100)+'%';dimR.style.width=((1-sR)*100)+'%';
    selBg.style.left=(sL*100)+'%';selBg.style.width=((sR-sL)*100)+'%';
    if(m.edited){const dur=m.edited.duration;
      tL.textContent=(sL*dur).toFixed(2)+'s';tL.style.left=(sL*100+.5)+'%';
      tR.textContent=(sR*dur).toFixed(2)+'s';tR.style.left=(sR*100-5)+'%';
      tDur.textContent='sel: '+((sR-sL)*dur).toFixed(2)+'s / '+dur.toFixed(2)+'s'}}
  let curAf=null,pSt=0,pOf=0,pDu=0;
  function startCur(off,dur){pSt=ctx.currentTime;pOf=off;pDu=dur;cur.style.display='';animCur()}
  function animCur(){const e=ctx.currentTime-pSt;if(e>=pDu/m.rate){cur.style.display='none';curAf=null;return}
    cur.style.left=(pOf+(e*m.rate)/m.edited.duration)*100+'%';curAf=requestAnimationFrame(animCur)}
  function stopCur(){if(curAf)cancelAnimationFrame(curAf);cur.style.display='none';curAf=null}
  const ctrls=document.createElement('div');ctrls.style.cssText='display:flex;gap:3px;flex-wrap:wrap;margin-bottom:3px';
  function mkB(t,fn,tip){const b=document.createElement('button');b.className='tape-btn';b.style.fontSize='6px';b.textContent=t;if(tip)b.title=tip;b.addEventListener('click',fn);return b}
  ctrls.append(
    mkB('\u25b6 PLAY',()=>{if(!m.edited||!ctx)return;stopSrc();stopCur();initA();
      m.src=ctx.createBufferSource();m.src.buffer=m.edited;m.src.playbackRate.value=m.rate;m.src.connect(m.dst());
      const off=sL*m.edited.duration,dur=(sR-sL)*m.edited.duration;
      m.src.start(0,off,dur);startCur(sL,dur);m.src.onended=()=>{stopCur()}},'Play selection'),
    mkB('\u25a0 STOP',()=>{stopSrc();stopCur()}));
  const rateD=document.createElement('span');rateD.style.cssText='font-size:6px;color:var(--dim);display:flex;align-items:center;gap:2px';
  const rS=mkB('\u2013',()=>{m.rate=Math.max(.25,m.rate-.25);rV.textContent=m.rate.toFixed(2)+'\u00d7'});
  const rF=mkB('+',()=>{m.rate=Math.min(4,m.rate+.25);rV.textContent=m.rate.toFixed(2)+'\u00d7'});
  const rV=document.createElement('span');rV.textContent='1.00\u00d7';rV.style.cssText='font-size:6px;min-width:24px;text-align:center';
  rateD.append(rS,rV,rF);ctrls.appendChild(rateD);bd.appendChild(ctrls);
  const ops=document.createElement('div');ops.style.cssText='display:flex;gap:3px;flex-wrap:wrap;margin-bottom:3px';
  ops.append(
    mkB('\u2702 KEEP',()=>{if(!m.edited)return;trim(sL,sR);doFlash()},'Keep selected region, delete the rest'),
    mkB('\ud83d\uddd1 DEL',()=>{if(!m.edited)return;delSel();doFlash()},'Delete selected region, keep the rest'),
    mkB('\u27f2 REV',()=>{if(!m.edited)return;revSel();doFlash()},'Reverse selection'),
    mkB('FADE IN',()=>{if(!m.edited)return;fadeSel(true);doFlash()},'Fade in on selection'),
    mkB('FADE OUT',()=>{if(!m.edited)return;fadeSel(false);doFlash()},'Fade out on selection'),
    mkB('\u2191PIT',()=>{if(!m.edited)return;resample(1.05);doFlash()},'Pitch up 5%'),
    mkB('\u2193PIT',()=>{if(!m.edited)return;resample(.95);doFlash()},'Pitch down 5%'),
    mkB('NORM',()=>{if(!m.edited)return;norm();doFlash()},'Normalize'),
    mkB('\u27f3 UNDO',()=>{if(!m.buf)return;m.edited=copyBuf(m.buf);sL=0;sR=1;m.rate=1;rV.textContent='1.00\u00d7';drawWave();updInfo()},'Reset to original'));
  bd.appendChild(ops);
  const exp=document.createElement('div');exp.style.cssText='display:flex;gap:3px;transition:background .2s';
  exp.append(
    mkB('\u2193 WAV',()=>{if(!m.edited)return;const wav=bufToWav(m.edited);
      const url=URL.createObjectURL(wav),a=document.createElement('a');a.href=url;a.download='edited.wav';a.click();URL.revokeObjectURL(url)}),
    mkB('\u2192 SAMPLER',()=>{if(!m.edited)return;initA();
      const smp=mods.find(x=>x.type==='sample');if(!smp)return;
      const si=smp.slots.findIndex(s=>s===null);if(si<0)return;
      smp.slots[si]={name:'edit-'+Date.now()%10000,buf:copyBuf(m.edited),src:null};
      smp.updPad(si);exp.style.background='rgba(6,182,212,.15)';setTimeout(()=>{exp.style.background=''},300)}));
  bd.appendChild(exp);
  function stopSrc(){if(m.src){try{m.src.stop()}catch(e){}}m.src=null}
  function copyBuf(b){const nb=ctx.createBuffer(b.numberOfChannels,b.length,b.sampleRate);
    for(let c=0;c<b.numberOfChannels;c++)nb.getChannelData(c).set(b.getChannelData(c));return nb}
  function smp2(r){return Math.floor(r*m.edited.length)}
  function trim(l,r){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(l),s1=smp2(r),len=s1-s0;
    if(len<10)return;const nb=ctx.createBuffer(nc,len,sr);
    for(let c=0;c<nc;c++){const od=m.edited.getChannelData(c),nd=nb.getChannelData(c);for(let i=0;i<len;i++)nd[i]=od[s0+i]}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function delSel(){const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate,s0=smp2(sL),s1=smp2(sR);
    const kl=m.edited.length-(s1-s0);if(kl<10)return;const nb=ctx.createBuffer(nc,kl,sr);
    for(let c=0;c<nc;c++){const od=m.edited.getChannelData(c),nd=nb.getChannelData(c);
      for(let i=0;i<s0;i++)nd[i]=od[i];for(let i=s1;i<m.edited.length;i++)nd[s0+(i-s1)]=od[i]}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function revSel(){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR);
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);const seg=d.slice(s0,s1);seg.reverse();d.set(seg,s0)}drawWave()}
  function fadeSel(isIn){const nc=m.edited.numberOfChannels,s0=smp2(sL),s1=smp2(sR),len=s1-s0;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=s0;i<s1;i++){const r=(i-s0)/len;d[i]*=isIn?r:1-r}}drawWave()}
  function resample(ratio){const ob=m.edited,nc=ob.numberOfChannels,sr=ob.sampleRate,nl=Math.floor(ob.length/ratio);
    const nb=ctx.createBuffer(nc,nl,sr);
    for(let c=0;c<nc;c++){const od=ob.getChannelData(c),nd=nb.getChannelData(c);
      for(let i=0;i<nl;i++){const src=i*ratio,si=Math.floor(src),frac=src-si;nd[i]=(od[si]||0)*(1-frac)+(od[si+1]||0)*frac}}
    m.edited=nb;sL=0;sR=1;drawWave();updInfo()}
  function norm(){const nc=m.edited.numberOfChannels;let peak=0;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=0;i<d.length;i++){const a=Math.abs(d[i]);if(a>peak)peak=a}}
    if(peak<.001)return;const g=.95/peak;
    for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=0;i<d.length;i++)d[i]*=g}drawWave();updInfo()}
  function updInfo(){if(!m.edited)return;const nc=m.edited.numberOfChannels,sr=m.edited.sampleRate;
    let pk=0;for(let c=0;c<nc;c++){const d=m.edited.getChannelData(c);for(let i=0;i<d.length;i++){const a=Math.abs(d[i]);if(a>pk)pk=a}}
    finfo.textContent=m.edited.duration.toFixed(2)+'s \u00b7 '+sr+'Hz \u00b7 '+nc+'ch \u00b7 peak: '+(pk>0?(20*Math.log10(pk)).toFixed(1):'-\u221e')+'dB';finfo.style.display=''}
  function loadFile(file){const r=new FileReader();r.onload=async()=>{initA();m.buf=await ctx.decodeAudioData(r.result);
    m.edited=copyBuf(m.buf);sL=0;sR=1;m.rate=1;rV.textContent='1.00\u00d7';drawWave();updInfo();
    drop.textContent='\ud83d\udcc1 '+file.name.slice(0,30)};r.readAsArrayBuffer(file)}
  function drawWave(){const c=cvs;c.width=vizWrap.clientWidth;c.height=vizWrap.clientHeight;
    const x=c.getContext('2d');x.clearRect(0,0,c.width,c.height);
    if(!m.edited){x.fillStyle='rgba(255,255,255,.03)';x.fillRect(0,0,c.width,c.height);return}
    const data=m.edited.getChannelData(0),step=Math.ceil(data.length/c.width);
    x.beginPath();x.strokeStyle='#06b6d4';x.lineWidth=1;
    for(let i=0;i<c.width;i++){let mn=1,mx=-1;
      for(let j=0;j<step;j++){const v=data[i*step+j]||0;if(v<mn)mn=v;if(v>mx)mx=v}
      x.moveTo(i,(1+mn)/2*c.height);x.lineTo(i,(1+mx)/2*c.height)}
    x.stroke();updSel()}
  new ResizeObserver(()=>{if(m.edited)drawWave()}).observe(vizWrap);
  m.destroy=()=>{stopSrc();stopCur()};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}


// === INST MODULE — orchestral/band instruments ===
// Uses WebAudioFont for real sampled instrument sounds
function addInst(ci=0){
  const id=mid++;
  const{el,bd,sel,bdg,ct}=mkW('INST<span>.EXE</span>','Instruments','#d946ef',0,0,600,340,ci);
  el.id='m'+id;
  const wafPlayer=new WebAudioFontPlayer();
  const INSTS=[
    {name:'Violin',col:'#d946ef',oct:5,file:'0400_JCLive_sf2_file',vn:'_tone_0400_JCLive_sf2_file'},
    {name:'Viola',col:'#c084fc',oct:4,file:'0410_JCLive_sf2_file',vn:'_tone_0410_JCLive_sf2_file'},
    {name:'Cello',col:'#a855f7',oct:3,file:'0420_JCLive_sf2_file',vn:'_tone_0420_JCLive_sf2_file'},
    {name:'Contrabass',col:'#7c3aed',oct:2,file:'0430_JCLive_sf2_file',vn:'_tone_0430_JCLive_sf2_file'},
    {name:'Trumpet',col:'#f59e0b',oct:5,file:'0560_JCLive_sf2_file',vn:'_tone_0560_JCLive_sf2_file'},
    {name:'Trombone',col:'#eab308',oct:3,file:'0570_JCLive_sf2_file',vn:'_tone_0570_JCLive_sf2_file'},
    {name:'Tuba',col:'#78716c',oct:2,file:'0580_JCLive_sf2_file',vn:'_tone_0580_JCLive_sf2_file'},
    {name:'Fr Horn',col:'#b45309',oct:4,file:'0600_JCLive_sf2_file',vn:'_tone_0600_JCLive_sf2_file'},
    {name:'Flute',col:'#06b6d4',oct:6,file:'0730_JCLive_sf2_file',vn:'_tone_0730_JCLive_sf2_file'},
    {name:'Clarinet',col:'#475569',oct:4,file:'0710_JCLive_sf2_file',vn:'_tone_0710_JCLive_sf2_file'},
    {name:'Oboe',col:'#7c3aed',oct:5,file:'0680_JCLive_sf2_file',vn:'_tone_0680_JCLive_sf2_file'},
    {name:'Sax',col:'#d97706',oct:4,file:'0650_JCLive_sf2_file',vn:'_tone_0650_JCLive_sf2_file'},
    {name:'Guitar',col:'#92400e',oct:4,file:'0240_JCLive_sf2_file',vn:'_tone_0240_JCLive_sf2_file'},
    {name:'Bass Gtr',col:'#451a03',oct:3,file:'0330_JCLive_sf2_file',vn:'_tone_0330_JCLive_sf2_file'},
    {name:'Harmonica',col:'#dc2626',oct:5,file:'0220_JCLive_sf2_file',vn:'_tone_0220_JCLive_sf2_file'},
    {name:'Strings',col:'#e879f9',oct:4,file:'0480_JCLive_sf2_file',vn:'_tone_0480_JCLive_sf2_file'},
    {name:'Choir',col:'#fb7185',oct:4,file:'0520_JCLive_sf2_file',vn:'_tone_0520_JCLive_sf2_file'},
    {name:'Organ',col:'#818cf8',oct:4,file:'0190_JCLive_sf2_file',vn:'_tone_0190_JCLive_sf2_file'},
    {name:'Harp',col:'#fbbf24',oct:5,file:'0460_JCLive_sf2_file',vn:'_tone_0460_JCLive_sf2_file'},
    {name:'Pizzicato',col:'#f472b6',oct:4,file:'0450_JCLive_sf2_file',vn:'_tone_0450_JCLive_sf2_file'},
    {name:'Timpani',col:'#a3a3a3',oct:3,file:'0470_JCLive_sf2_file',vn:'_tone_0470_JCLive_sf2_file'},
  ];
  // chord intervals from root
  const CHORDS={off:[0],maj:[0,4,7],min:[0,3,7],maj7:[0,4,7,11],min7:[0,3,7,10],
    dom7:[0,4,7,10],dim:[0,3,6],aug:[0,4,8],sus4:[0,5,7],pow:[0,7,12]};
  const m={id,type:'inst',el,ci,ts:0,
    iIdx:0,i2Idx:-1, // layer: -1=off
    oct:5,vol:.7,detune:0,
    sustain:false,sustainedNotes:{},
    chord:'off',bend:0,
    rvbMix:.15,dlMix:.1,dlTime:.25,
    notes:{},loaded:{}};
  m.onStep=()=>{};m.clr=()=>{};
  // === AUDIO CHAIN: inst → dry+reverb+delay → channel ===
  let rvbNode=null,dlNode=null,dlFb=null,rvbG=null,dlG=null,dryG=null;
  function initChain(){
    if(dryG)return;initA();
    const dest=chs[m.ci].g||mGain;
    dryG=ctx.createGain();dryG.gain.value=1;dryG.connect(dest);
    // reverb via convolver
    rvbNode=ctx.createConvolver();
    const rl=ctx.sampleRate*1.8,rb=ctx.createBuffer(2,rl,ctx.sampleRate);
    for(let c=0;c<2;c++){const d=rb.getChannelData(c);for(let i=0;i<rl;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/rl,2.5)}
    rvbNode.buffer=rb;rvbG=ctx.createGain();rvbG.gain.value=m.rvbMix;
    rvbNode.connect(rvbG);rvbG.connect(dest);
    // delay
    dlNode=ctx.createDelay(1);dlNode.delayTime.value=m.dlTime;
    dlFb=ctx.createGain();dlFb.gain.value=.35;
    dlG=ctx.createGain();dlG.gain.value=m.dlMix;
    dlNode.connect(dlFb);dlFb.connect(dlNode);dlNode.connect(dlG);dlG.connect(dest);
  }
  m.dst=()=>{initChain();return dryG};
  m.sendRvb=()=>{initChain();return rvbNode};
  m.sendDl=()=>{initChain();return dlNode};
  // load instrument
  function loadInst(idx,cb){
    const ins=INSTS[idx];if(!ins)return;
    if(m.loaded[ins.vn]){if(cb)cb();return}
    status.textContent='Loading '+ins.name+'...';
    const url='https://surikov.github.io/webaudiofontdata/sound/'+ins.file+'.js';
    const s=document.createElement('script');s.src=url;
    s.onload=()=>{initA();const preset=window[ins.vn];
      if(preset){wafPlayer.adjustPreset(ctx,preset);m.loaded[ins.vn]=preset;status.textContent=ins.name+' ready'}
      if(cb)cb()};
    s.onerror=()=>{status.textContent='Failed: '+ins.name};
    document.head.appendChild(s);
  }
  // play note with all features
  function playNote(note,vel){
    if(!ctx)return;initA();initChain();
    const intervals=CHORDS[m.chord]||[0];
    intervals.forEach(iv=>{
      const n=note+iv;
      if(m.notes[n])stopNoteSingle(n);
      const pitch=n+(m.oct*12)+12+(m.detune/100)+(m.bend/100);
      // primary instrument
      const ins=INSTS[m.iIdx],preset=m.loaded[ins.vn];
      if(!preset)return;
      const env=wafPlayer.queueWaveTable(ctx,dryG,preset,0,pitch,9999,m.vol*vel);
      // send to reverb+delay
      const env2=m.rvbMix>0?wafPlayer.queueWaveTable(ctx,rvbNode,preset,0,pitch,9999,m.vol*vel*m.rvbMix):null;
      const env3=m.dlMix>0?wafPlayer.queueWaveTable(ctx,dlNode,preset,0,pitch,9999,m.vol*vel*m.dlMix):null;
      // layer 2
      let env4=null;
      if(m.i2Idx>=0){const ins2=INSTS[m.i2Idx],p2=m.loaded[ins2.vn];
        if(p2)env4=wafPlayer.queueWaveTable(ctx,dryG,p2,0,pitch,9999,m.vol*vel*.7)}
      m.notes[n]={env,env2,env3,env4};
    });
  }
  function stopNoteSingle(n){
    const e=m.notes[n];if(!e)return;
    if(e.env)e.env.cancel();if(e.env2)e.env2.cancel();
    if(e.env3)e.env3.cancel();if(e.env4)e.env4.cancel();
    delete m.notes[n];
  }
  function stopNote(note){
    const intervals=CHORDS[m.chord]||[0];
    intervals.forEach(iv=>{
      const n=note+iv;
      if(m.sustain){m.sustainedNotes[n]=true;return}
      stopNoteSingle(n);
    });
  }
  function releaseSustain(){
    Object.keys(m.sustainedNotes).forEach(n=>stopNoteSingle(+n));
    m.sustainedNotes={};
  }
  sel.addEventListener('change',()=>{
    // Release all notes before switching channels
    if(m.sustain)releaseSustain();
    Object.keys(m.notes).forEach(n=>stopNoteSingle(+n));
    m.ci=+sel.value;bdg.style.background=CHR[m.ci];bdg.textContent='CH'+(m.ci+1);
    dryG=null;rvbNode=null;dlNode=null;filt()});
  // === UI: Instrument Grid ===
  const iGrid=document.createElement('div');iGrid.style.cssText='display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:3px';
  INSTS.forEach((ins,idx)=>{
    const b=document.createElement('button');
    b.style.cssText='padding:3px 1px;border-radius:3px;border:2px solid '+ins.col+'40;background:'+ins.col+'15;color:'+ins.col+';font-family:inherit;font-size:5px;font-weight:800;cursor:pointer;transition:all .1s;letter-spacing:.3px';
    b.textContent=ins.name;b.dataset.idx=idx;
    if(idx===0){b.style.background=ins.col+'40';b.style.borderColor=ins.col}
    b.addEventListener('click',()=>{
      Object.keys(m.notes).forEach(n=>stopNoteSingle(+n));
      m.iIdx=idx;m.oct=ins.oct;updIGrid();
      octD.textContent='OCT '+m.oct;updKeys();
      loadInst(idx,()=>{playNote(0,.8);setTimeout(()=>{stopNoteSingle(0)},300)});
    });
    b.addEventListener('contextmenu',e=>{e.preventDefault();
      // right-click to set as layer 2
      if(m.i2Idx===idx){m.i2Idx=-1}else{m.i2Idx=idx;loadInst(idx)}
      updIGrid();layD.textContent=m.i2Idx>=0?INSTS[m.i2Idx].name:'OFF';
    });
    iGrid.appendChild(b);
  });
  function updIGrid(){iGrid.querySelectorAll('button').forEach(x=>{
    const ii=INSTS[+x.dataset.idx],isP=+x.dataset.idx===m.iIdx,isL=+x.dataset.idx===m.i2Idx;
    x.style.background=isP?ii.col+'40':isL?ii.col+'25':ii.col+'15';
    x.style.borderColor=isP?ii.col:isL?ii.col+'80':ii.col+'40';
    x.style.boxShadow=isL?'inset 0 0 0 1px '+ii.col+'40':'none'})}
  bd.appendChild(iGrid);
  // status + layer display
  const sRow=document.createElement('div');sRow.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:3px';
  const status=document.createElement('div');status.style.cssText='font-size:5px;color:var(--dim)';
  const layW=document.createElement('div');layW.style.cssText='font-size:5px;color:var(--dim);display:flex;gap:3px;align-items:center';
  layW.innerHTML='<span style="color:#d946ef;font-weight:700">LAYER:</span>';
  const layD=document.createElement('span');layD.textContent='OFF';layD.style.fontWeight='700';
  const layTip=document.createElement('span');layTip.textContent='(right-click instrument)';layTip.style.opacity='.5';
  layW.append(layD,layTip);sRow.append(status,layW);bd.appendChild(sRow);
  // === CONTROLS ROW 1: Oct, Vol, Tune, Bend ===
  const c1=document.createElement('div');c1.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:3px;flex-wrap:wrap';
  const octM=document.createElement('button');octM.className='pbtn';octM.textContent='\u2013';
  octM.addEventListener('click',()=>{if(m.oct>1){m.oct--;octD.textContent='OCT '+m.oct;updKeys()}});
  const octD=document.createElement('span');octD.style.cssText='font-size:7px;font-weight:700;color:var(--text);min-width:28px;text-align:center';octD.textContent='OCT '+m.oct;
  const octP=document.createElement('button');octP.className='pbtn';octP.textContent='+';
  octP.addEventListener('click',()=>{if(m.oct<7){m.oct++;octD.textContent='OCT '+m.oct;updKeys()}});
  function mkSl(lab,mn,mx,val,w,cb,fmt){
    const wr=document.createElement('div');wr.style.cssText='display:flex;align-items:center;gap:2px';
    const l=document.createElement('span');l.style.cssText='font-size:5px;color:var(--dim)';l.textContent=lab;
    const s=document.createElement('input');s.type='range';s.className='bv';s.style.width=w||'40px';
    s.min=mn;s.max=mx;s.value=val;
    const v=document.createElement('span');v.style.cssText='font-size:5px;color:var(--dim);min-width:18px;text-align:center';
    v.textContent=fmt?fmt(val):val;
    s.addEventListener('input',()=>{cb(+s.value);v.textContent=fmt?fmt(+s.value):s.value});
    s.addEventListener('dblclick',()=>{s.value=val;cb(val);v.textContent=fmt?fmt(val):val});
    wr.append(l,s,v);return wr}
  c1.append(octM,octD,octP,
    mkSl('VOL',0,100,70,'36px',v=>{m.vol=v/100},v=>Math.round(v)+'%'),
    mkSl('TUNE',-100,100,0,'36px',v=>{m.detune=v},v=>v+'\u00a2'),
    mkSl('BEND',-200,200,0,'36px',v=>{m.bend=v},v=>v+'\u00a2'));
  bd.appendChild(c1);
  // === CONTROLS ROW 2: Sustain, Chord, Reverb, Delay ===
  const c2=document.createElement('div');c2.style.cssText='display:flex;gap:3px;align-items:center;margin-bottom:3px;flex-wrap:wrap';
  // sustain toggle
  const susBtn=document.createElement('button');susBtn.className='pbtn';susBtn.textContent='SUSTAIN';susBtn.style.fontSize='5px';
  susBtn.addEventListener('click',()=>{m.sustain=!m.sustain;susBtn.style.background=m.sustain?'#d946ef':'';
    susBtn.style.color=m.sustain?'#fff':'';if(!m.sustain)releaseSustain()});
  c2.appendChild(susBtn);
  // chord mode selector
  const chLab=document.createElement('span');chLab.style.cssText='font-size:5px;color:var(--dim)';chLab.textContent='CHORD';
  const chSel=document.createElement('select');chSel.className='bsel';chSel.style.width='52px';
  Object.keys(CHORDS).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k.toUpperCase();chSel.appendChild(o)});
  chSel.addEventListener('change',()=>{m.chord=chSel.value});
  c2.append(chLab,chSel);
  // reverb/delay sends
  c2.append(
    mkSl('RVB',0,100,15,'30px',v=>{m.rvbMix=v/100;if(rvbG)rvbG.gain.value=m.rvbMix},v=>Math.round(v)+'%'),
    mkSl('DLY',0,100,10,'30px',v=>{m.dlMix=v/100;if(dlG)dlG.gain.value=m.dlMix},v=>Math.round(v)+'%'),
    mkSl('TIME',50,500,250,'30px',v=>{m.dlTime=v/1000;if(dlNode)dlNode.delayTime.value=m.dlTime},v=>v+'ms'));
  bd.appendChild(c2);
  // === KEYBOARD with velocity zones ===
  const kb=document.createElement('div');kb.style.cssText='position:relative;display:flex;height:65px';
  const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const WK=[0,2,4,5,7,9,11],BK=[1,3,-1,6,8,10,-1];
  const kEls=[];
  function velFromY(e,el){
    const r=el.getBoundingClientRect(),y=(e.clientY-r.top)/r.height;
    // top=soft(.3), bottom=hard(1)
    return .3+y*.7;
  }
  function buildKb(){
    kb.innerHTML='';kEls.length=0;
    for(let oi=0;oi<2;oi++){WK.forEach(n=>{
      const note=n+oi*12;const k=document.createElement('div');
      k.style.cssText='flex:1;background:#1a1a24;border:1px solid var(--border);border-radius:0 0 3px 3px;cursor:pointer;display:flex;align-items:flex-end;justify-content:center;padding-bottom:3px;transition:background .06s;position:relative;z-index:1;overflow:hidden';
      // velocity gradient hint
      const vg=document.createElement('div');vg.style.cssText='position:absolute;inset:0;background:linear-gradient(to bottom,transparent 0%,rgba(255,255,255,.03) 100%);pointer-events:none';
      const lb=document.createElement('span');lb.style.cssText='font-size:5px;color:var(--dim);pointer-events:none;position:relative;z-index:1';lb.textContent=NN[n]+m.oct;
      k.append(vg,lb);
      k.addEventListener('mousedown',e=>{e.preventDefault();const v=velFromY(e,k);playNote(note,v);k.style.background=INSTS[m.iIdx].col+'60'});
      k.addEventListener('mouseup',()=>{stopNote(note);if(!m.sustain||!m.sustainedNotes[note])k.style.background='#1a1a24'});
      k.addEventListener('mouseleave',()=>{if(m.notes[note]&&!m.sustain){stopNote(note);k.style.background='#1a1a24'}});
      kb.appendChild(k);kEls.push({el:k,note,lb,isBlack:false})})}
    for(let oi=0;oi<2;oi++){BK.forEach((n,bi)=>{if(n<0)return;const note=n+oi*12;
      const k=document.createElement('div');const left=(oi*7+bi)*(100/14)+100/14*.55;
      k.style.cssText='position:absolute;top:0;left:'+left+'%;width:'+100/14*.6+'%;height:60%;background:#111;border:1px solid var(--border);border-radius:0 0 2px 2px;cursor:pointer;z-index:2;transition:background .06s';
      k.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();const v=velFromY(e,k);playNote(note,v);k.style.background=INSTS[m.iIdx].col+'80'});
      k.addEventListener('mouseup',()=>{stopNote(note);k.style.background='#111'});
      k.addEventListener('mouseleave',()=>{if(m.notes[note]&&!m.sustain){stopNote(note);k.style.background='#111'}});
      kb.appendChild(k);kEls.push({el:k,note,isBlack:true})})}
  }
  function updKeys(){kEls.forEach(k=>{if(k.lb)k.lb.textContent=NN[k.note%12]+m.oct})}
  buildKb();bd.appendChild(kb);
  // velocity hint label
  const vhint=document.createElement('div');vhint.style.cssText='display:flex;justify-content:space-between;font-size:4px;color:var(--dim);opacity:.5;padding:0 2px';
  vhint.innerHTML='<span>\u2191 soft</span><span>hard \u2193</span>';
  bd.appendChild(vhint);
  // === KEYBOARD FOCUS ===
  const kbb=document.createElement('button');kbb.className='wb kb';kbb.title='Keyboard';kbb.textContent='\u2328';kbb.dataset.mid=id;
  kbb.addEventListener('click',e=>{e.stopPropagation();setKb(id)});ct.prepend(kbb);
  const KMAP={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12};
  const held={};
  const kdn=e=>{if(e.repeat||_kb!==id)return;
    // spacebar = sustain pedal toggle
    if(e.key===' '){e.preventDefault();m.sustain=!m.sustain;susBtn.style.background=m.sustain?'#d946ef':'';
      susBtn.style.color=m.sustain?'#fff':'';if(!m.sustain)releaseSustain();return}
    const n=KMAP[e.key.toLowerCase()];if(n!==undefined&&!held[n]){held[n]=true;playNote(n,.85);
      const ke=kEls.find(x=>x.note===n);if(ke)ke.el.style.background=INSTS[m.iIdx].col+(ke.isBlack?'80':'60')}};
  const kup=e=>{const n=KMAP[e.key.toLowerCase()];if(n!==undefined&&held[n]){held[n]=false;stopNote(n);
    const ke=kEls.find(x=>x.note===n);if(ke&&!m.sustainedNotes[n])ke.el.style.background=ke.isBlack?'#111':'#1a1a24'}};
  window.addEventListener('keydown',kdn);window.addEventListener('keyup',kup);
  loadInst(0);
  m.destroy=()=>{window.removeEventListener('keydown',kdn);window.removeEventListener('keyup',kup);
    Object.keys(m.notes).forEach(n=>stopNoteSingle(+n));if(_kb===id)_kb=null};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === SAVE MODULE ===
function addSave(){
  const id=mid++;
  const{el,bd,ct}=mkW('SAVE<span>.EXE</span>','Save/Load','#10b981',0,0,320,200,0);
  el.id='m'+id;
  const m={id,type:'save',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{}};

  // === SERIALIZE ===
  function getState(){
    const state={v:1,ts:Date.now(),
      channels:chs.map(ch=>({bpm:ch.bpm,sw:ch.sw,on:ch.on})),
      theme:{},modules:[]};
    // capture theme/workspace style
    const r=document.documentElement.style;
    ['--bg','--surface','--s2','--s3','--border','--text','--dim','--green'].forEach(k=>{
      state.theme[k]=r.getPropertyValue(k)});
    state.theme.wsBg=document.getElementById('wsI').style.backgroundColor||'';
    state.theme.wsBgImg=document.getElementById('wsI').style.backgroundImage||'';
    // capture each module
    mods.forEach(mod=>{
      const d={type:mod.type,ci:mod.ci,
        x:parseInt(mod.el.style.left)||0,y:parseInt(mod.el.style.top)||0,
        w:mod.el.offsetWidth,h:mod.el.offsetHeight};
      switch(mod.type){
        case 'beat':
          d.ts=mod.ts;d.cm=mod.cm;
          d.ch=mod.ch.map(c=>({name:c.name,v:c.v,mut:c.mut,solo:c.solo,
            steps:[...c.steps]}));
          break;
        case 'synth':
          d.wv=mod.wv;d.det=mod.det;d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;
          d.ff=mod.ff;d.fr=mod.fr;d.vol=mod.vol;d.oct=mod.oct;
          break;
        case 'fx':
          // fx state is in sliders, capture slider values
          d.sliders=[];
          mod.el.querySelectorAll('input[type=range]').forEach(s=>{d.sliders.push(+s.value)});
          break;
        case 'piano':
          d.wv=mod.wv;d.det=mod.det;d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;
          d.ff=mod.ff;d.fr=mod.fr;d.vol=mod.vol;d.oct=mod.oct;d.sus=mod.sus;
          break;
        case 'bass':
          d.vol=mod.vol;d.oct=mod.oct;d.mode=mod.mode;
          break;
        case 'note':
          d.ts=mod.ts;d.oct=mod.oct;d.wv=mod.wv;d.vol=mod.vol;
          d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;d.ff=mod.ff;d.fr=mod.fr;d.det=mod.det;
          d.inst=mod.inst;
          // capture grid cells
          d.cells=[];
          mod.cellEls.forEach((row,ri)=>row.forEach((c,ci)=>{
            if(c.classList.contains('active'))d.cells.push([ri,ci])}));
          break;
        case 'drum':
          // drum has local pats/parts - read from DOM
          d.ts=mod.ts;
          d.parts=mod.parts.map(p=>({name:p.name,mut:p.mut,solo:p.solo,prob:p.prob,hum:p.hum}));
          break;
        case 'chord':
          d.ts=mod.ts;d.oct=mod.oct;d.vol=mod.vol;d.wv=mod.wv;d.det=mod.det;
          d.a=mod.a;d.d=mod.d;d.s=mod.s;d.r=mod.r;
          d.slots=mod.slots.map(s=>({root:s.root,type:s.type}));
          if(mod.stepsPerChord)d.stepsPerChord=mod.stepsPerChord;
          break;
        case 'inst':
          d.iIdx=mod.iIdx;d.i2Idx=mod.i2Idx;d.oct=mod.oct;d.vol=mod.vol;
          d.detune=mod.detune;d.chord=mod.chord;d.bend=mod.bend;
          d.rvbMix=mod.rvbMix;d.dlMix=mod.dlMix;d.dlTime=mod.dlTime;
          break;
        case 'edit':case 'tape':case 'sample':case 'mixer':case 'save':
          // these are stateless or have audio buffers we can't serialize
          break;
      }
      state.modules.push(d);
    });
    return state;
  }

  // === DESERIALIZE ===
  function loadState(state){
    if(!state||!state.modules)return;
    // stop everything
    chs.forEach(ch=>{ch.on=false;ch.step=0});
    // destroy all modules
    while(mods.length){const mod=mods.pop();if(mod.destroy)mod.destroy();if(mod.el&&mod.el.parentNode)mod.el.parentNode.removeChild(mod.el)}
    mid=0;
    // restore channels
    if(state.channels)state.channels.forEach((ch,i)=>{
      if(chs[i]){chs[i].bpm=ch.bpm||120;chs[i].sw=ch.sw||0}});
    // restore theme
    if(state.theme){const r=document.documentElement.style;
      Object.keys(state.theme).forEach(k=>{
        if(k==='wsBg'){document.getElementById('wsI').style.backgroundColor=state.theme[k];
          document.getElementById('workspace').style.backgroundColor=state.theme[k]}
        else if(k==='wsBgImg'){document.getElementById('wsI').style.backgroundImage=state.theme[k]}
        else r.setProperty(k,state.theme[k])});
    }
    // recreate modules
    const adders={beat:addBeat,synth:addSynth,fx:addFx,piano:addPiano,bass:addBass,
      note:addNote,sample:addSample,tape:addTape,drum:addDrum,chord:addChord,
      edit:addEdit,inst:addInst,mixer:addMixer,save:addSave};
    state.modules.forEach(d=>{
      const fn=adders[d.type];if(!fn)return;
      if(d.type==='mixer')fn();
      else if(d.type==='save')fn();
      else fn(d.ci||0);
      const mod=mods[mods.length-1];if(!mod)return;
      // restore position
      mod.el.style.left=(d.x||0)+'px';
      mod.el.style.top=(d.y||0)+'px';
      if(d.w)mod.el.style.width=d.w+'px';
      if(d.h)mod.el.style.height=d.h+'px';
      // restore module-specific state
      switch(d.type){
        case 'beat':
          if(d.ch&&mod.ch){d.ch.forEach((c,i)=>{
            if(mod.ch[i]){mod.ch[i].v=c.v;mod.ch[i].mut=c.mut;mod.ch[i].solo=c.solo;
              c.steps.forEach((s,si)=>{mod.ch[i].steps[si]=s})}});
            // rebuild grid
            if(mod.el.querySelector('.wbody'))buildBG(mod,mod.el.querySelector('.wbody'))}
          break;
        case 'synth':
          ['wv','det','a','d','s','r','ff','fr','vol','oct'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          break;
        case 'piano':
          ['wv','det','a','d','s','r','ff','fr','vol','oct','sus'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          break;
        case 'bass':
          if(d.vol!==undefined)mod.vol=d.vol;
          if(d.oct!==undefined)mod.oct=d.oct;
          if(d.mode!==undefined)mod.mode=d.mode;
          break;
        case 'note':
          ['ts','oct','wv','vol','a','d','s','r','ff','fr','det','inst'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(d.cells&&mod.cellEls){d.cells.forEach(([r,c])=>{
            if(mod.cellEls[r]&&mod.cellEls[r][c])mod.cellEls[r][c].classList.add('active')})}
          break;
        case 'chord':
          ['ts','oct','vol','wv','det','a','d','s','r'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          if(d.slots)mod.slots=d.slots.map(s=>({root:s.root,type:s.type}));
          if(d.stepsPerChord)mod.stepsPerChord=d.stepsPerChord;
          break;
        case 'inst':
          ['iIdx','i2Idx','oct','vol','detune','chord','bend','rvbMix','dlMix','dlTime'].forEach(k=>{if(d[k]!==undefined)mod[k]=d[k]});
          break;
        case 'drum':
          if(d.parts&&mod.parts){d.parts.forEach((p,i)=>{
            if(mod.parts[i]){mod.parts[i].mut=p.mut;mod.parts[i].solo=p.solo;
              mod.parts[i].prob=p.prob;mod.parts[i].hum=p.hum}})}
          break;
      }
    });
    updMx();filt();
    status.textContent='Loaded \u2714';status.style.color='#10b981';
    setTimeout(()=>{status.style.color='var(--dim)'},1500);
  }

  // === UI ===
  const status=document.createElement('div');status.style.cssText='font-size:6px;color:var(--dim);text-align:center;padding:4px;min-height:14px;font-weight:700';
  status.textContent='Ready';
  bd.appendChild(status);

  // name input
  const nameRow=document.createElement('div');nameRow.style.cssText='display:flex;gap:4px;align-items:center;margin-bottom:6px;padding:0 4px';
  const nameL=document.createElement('span');nameL.style.cssText='font-size:6px;color:var(--dim);white-space:nowrap';nameL.textContent='Project:';
  const nameIn=document.createElement('input');nameIn.type='text';nameIn.value='My Project';
  nameIn.style.cssText='flex:1;background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:3px 5px;color:var(--text);font-family:inherit;font-size:6px;outline:none';
  nameRow.append(nameL,nameIn);bd.appendChild(nameRow);

  // buttons
  const btns=document.createElement('div');btns.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:0 4px;margin-bottom:6px';
  function mkB(txt,col,fn){
    const b=document.createElement('button');
    b.style.cssText='padding:8px;border-radius:4px;border:2px solid '+col+'40;background:'+col+'18;color:'+col+';font-family:inherit;font-size:7px;font-weight:800;letter-spacing:.5px;cursor:pointer;transition:all .12s';
    b.textContent=txt;
    b.addEventListener('mouseenter',()=>{b.style.background=col+'30';b.style.borderColor=col});
    b.addEventListener('mouseleave',()=>{b.style.background=col+'18';b.style.borderColor=col+'40'});
    b.addEventListener('click',fn);return b;
  }

  // SAVE TO FILE
  btns.appendChild(mkB('\u2193 SAVE FILE','#10b981',()=>{
    const state=getState();
    state.name=nameIn.value||'project';
    const json=JSON.stringify(state,null,2);
    const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;
    a.download=(nameIn.value||'studio-project').replace(/[^a-zA-Z0-9_-]/g,'_')+'.json';
    a.click();URL.revokeObjectURL(url);
    status.textContent='Saved: '+a.download;status.style.color='#10b981';
    setTimeout(()=>{status.style.color='var(--dim)'},2000);
  }));

  // LOAD FROM FILE
  const loadIn=document.createElement('input');loadIn.type='file';loadIn.accept='.json';loadIn.style.display='none';
  btns.appendChild(mkB('\u2191 LOAD FILE','#3b82f6',()=>loadIn.click()));
  loadIn.addEventListener('change',()=>{if(!loadIn.files[0])return;
    const r=new FileReader();r.onload=()=>{
      try{const state=JSON.parse(r.result);
        if(!state.modules){status.textContent='Invalid file';status.style.color='#ef4444';return}
        if(state.name)nameIn.value=state.name;
        loadState(state);
      }catch(e){status.textContent='Parse error';status.style.color='#ef4444'}
    };r.readAsText(loadIn.files[0]);loadIn.value='';
  });
  bd.appendChild(btns);bd.appendChild(loadIn);

  // QUICK SAVE/LOAD to localStorage
  const qRow=document.createElement('div');qRow.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:0 4px;margin-bottom:6px';
  qRow.appendChild(mkB('QUICK SAVE','#f59e0b',()=>{
    try{const state=getState();state.name=nameIn.value||'project';
      localStorage.setItem('studio_quicksave',JSON.stringify(state));
      status.textContent='Quick saved \u2714';status.style.color='#f59e0b';
      qTime.textContent='Last: '+new Date().toLocaleTimeString();
      setTimeout(()=>{status.style.color='var(--dim)'},1500);
    }catch(e){status.textContent='Save failed (storage full?)';status.style.color='#ef4444'}
  }));
  qRow.appendChild(mkB('QUICK LOAD','#f59e0b',()=>{
    try{const raw=localStorage.getItem('studio_quicksave');
      if(!raw){status.textContent='No quicksave found';status.style.color='#ef4444';return}
      const state=JSON.parse(raw);if(state.name)nameIn.value=state.name;
      loadState(state);
    }catch(e){status.textContent='Load failed';status.style.color='#ef4444'}
  }));
  bd.appendChild(qRow);

  const qTime=document.createElement('div');qTime.style.cssText='font-size:5px;color:var(--dim);text-align:center;opacity:.5';
  try{const qs=localStorage.getItem('studio_quicksave');
    if(qs){const d=JSON.parse(qs);qTime.textContent='Quicksave: '+(d.name||'untitled')+' \u2022 '+new Date(d.ts).toLocaleString()}}catch(e){}
  bd.appendChild(qTime);

  // module info
  const info=document.createElement('div');info.style.cssText='font-size:5px;color:var(--dim);text-align:center;padding:4px;opacity:.5';
  function updInfo(){info.textContent=mods.length+' modules \u2022 '+['beat','synth','fx','piano','bass','note','sample','tape','drum','chord','edit','inst'].filter(t=>mods.some(m=>m.type===t)).join(', ')}
  updInfo();const _ui=setInterval(updInfo,2000);
  bd.appendChild(info);

  m.destroy=()=>{clearInterval(_ui)};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
}

// === MIXER MODULE ===
let _mxUp=[];function updMx(){_mxUp.forEach(f=>f())}
function addMixer(){
  const id=mid++;
  const{el,bd,ct}=mkW('MIXER<span>.EXE</span>','Mix','var(--green)',20+(mods.length%4)*30,20+(mods.length%4)*20,720,320,0);
  el.id='m'+id;el.querySelector('.wsel').remove();el.querySelector('.wbadge').remove();
  const m={id,type:'mixer',el,ci:-1,ts:0,onStep:()=>{},clr:()=>{}};
  const strips=document.createElement('div');strips.className='mxchs';const els=[];
  for(let ci=0;ci<4;ci++){
    const s=document.createElement('div');s.className='mxch';
    s.innerHTML=`<div class="mxhd"><div class="mxdot" style="background:${CHR[ci]}"></div><span class="mxnm">CH ${ci+1}</span></div>`;
    const tr=document.createElement('div');tr.className='mxtr';
    const pb=document.createElement('button');pb.className='mxb';pb.innerHTML='&#9654;';pb.addEventListener('click',()=>togCh(ci));
    const sb=document.createElement('button');sb.className='mxb';sb.innerHTML='&#9632;';sb.addEventListener('click',()=>stopCh(ci));
    tr.append(pb,sb);s.appendChild(tr);
    const ctrl=document.createElement('div');ctrl.style='display:flex;flex-direction:column;gap:3px';
    const bR=document.createElement('div');bR.className='mxr';bR.innerHTML='<label>BPM</label>';
    const bI=document.createElement('input');bI.type='range';bI.min=40;bI.max=220;bI.value=chs[ci].bpm;
    const bV=document.createElement('span');bV.className='mxv';bV.style.color=CHR[ci];bV.textContent=chs[ci].bpm;
    bI.addEventListener('input',()=>{chs[ci].bpm=+bI.value;bV.textContent=bI.value});bR.append(bI,bV);
    const sR=document.createElement('div');sR.className='mxr';sR.innerHTML='<label>SW</label>';
    const sI=document.createElement('input');sI.type='range';sI.min=0;sI.max=80;sI.value=0;
    const sV=document.createElement('span');sV.className='mxv';sV.style.color=CHR[ci];sV.textContent='0';
    sI.addEventListener('input',()=>{chs[ci].sw=+sI.value;sV.textContent=sI.value});sR.append(sI,sV);
    const vR=document.createElement('div');vR.className='mxr';vR.innerHTML='<label>VOL</label>';
    const vI=document.createElement('input');vI.type='range';vI.min=0;vI.max=100;vI.value=75;
    const vV=document.createElement('span');vV.className='mxv';vV.style.color=CHR[ci];vV.textContent='75';
    vI.addEventListener('input',()=>{chs[ci].vol=+vI.value;if(chs[ci].g)chs[ci].g.gain.value=vI.value/100;vV.textContent=vI.value});vR.append(vI,vV);
    ctrl.append(bR,sR,vR);s.appendChild(ctrl);
    const ms=document.createElement('div');ms.className='mxms';
    const mb=document.createElement('button');mb.className='mxmb';mb.textContent='M';
    mb.addEventListener('click',()=>{chs[ci].mut=!chs[ci].mut;mb.classList.toggle('muted');applyChGains()});
    const sb2=document.createElement('button');sb2.className='mxmb';sb2.textContent='S';
    sb2.addEventListener('click',()=>{chs[ci].solo=!chs[ci].solo;sb2.classList.toggle('soloed');applyChGains()});
    ms.append(mb,sb2);s.appendChild(ms);strips.appendChild(s);els.push({pb,bI,bV});
  }
  bd.appendChild(strips);
  const viz=document.createElement('div');viz.className='vizr';
  viz.innerHTML=`<div class="vizb"><span class="vizl">Wave</span><canvas id="wc${id}"></canvas></div><div class="vizb" style="max-width:130px"><span class="vizl">Spec</span><canvas id="sc${id}"></canvas></div>`;
  bd.appendChild(viz);
  const upFn=()=>{els.forEach((e,i)=>{e.pb.classList.toggle('playing',chs[i].on);e.pb.innerHTML=chs[i].on?'&#10074;&#10074;':'&#9654;';e.bI.value=chs[i].bpm;e.bV.textContent=chs[i].bpm})};
  _mxUp.push(upFn);
  m.destroy=()=>{const i=_mxUp.indexOf(upFn);if(i>=0)_mxUp.splice(i,1)};
  ct.querySelector('.close').addEventListener('click',()=>rmMod(id));
  wsI.appendChild(el);mods.push(m);filt();
  setTimeout(()=>{
    const wC=document.getElementById('wc'+id),sC=document.getElementById('sc'+id);if(!wC||!sC)return;
    const wX=wC.getContext('2d'),sX=sC.getContext('2d');
    const rs=()=>{wC.width=wC.parentElement.clientWidth;wC.height=wC.parentElement.clientHeight;sC.width=sC.parentElement.clientWidth;sC.height=sC.parentElement.clientHeight};
    rs();new ResizeObserver(rs).observe(wC.parentElement);
    (function draw(){if(!document.getElementById('m'+id))return;requestAnimationFrame(draw);
      const ap=chs.some(c=>c.on),wW=wC.width,wH=wC.height;wX.clearRect(0,0,wW,wH);
      if(anW&&ap){const b=new Uint8Array(anW.frequencyBinCount);anW.getByteTimeDomainData(b);wX.beginPath();wX.strokeStyle='rgba(232,54,79,.8)';wX.lineWidth=1.5;const sl=wW/b.length;let x=0;for(let i=0;i<b.length;i++){const y=(b[i]/128)*wH/2;i===0?wX.moveTo(x,y):wX.lineTo(x,y);x+=sl}wX.stroke()}
      const sW=sC.width,sH=sC.height;sX.clearRect(0,0,sW,sH);
      if(anF&&ap){const b=new Uint8Array(anF.frequencyBinCount);anF.getByteFrequencyData(b);const bw=sW/b.length;for(let i=0;i<b.length;i++){const v=b[i]/255;sX.fillStyle='hsla('+(i/b.length*40+340)+',70%,55%,'+(0.3+v*0.7)+')';sX.fillRect(i*bw,sH-v*sH,bw+.5,v*sH)}}
    })()},60);
}
function applyChGains(){const any=chs.some(c=>c.solo);chs.forEach(c=>{if(c.g){if(any)c.g.gain.value=(c.solo&&!c.mut)?c.vol/100:0;else c.g.gain.value=c.mut?0:c.vol/100}})}

// === MODULE MGMT ===
function rmMod(id){const i=mods.findIndex(m=>m.id===id);if(i<0)return;const m=mods[i];if(m.destroy)m.destroy();mods.splice(i,1);document.getElementById('m'+id)?.remove()}
document.getElementById('addBeat').addEventListener('click',()=>addBeat(aTab==='all'?0:+aTab));
document.getElementById('addSynth').addEventListener('click',()=>addSynth(aTab==='all'?0:+aTab));
document.getElementById('addPiano').addEventListener('click',()=>addPiano(aTab==='all'?0:+aTab));
document.getElementById('addBass').addEventListener('click',()=>addBass(aTab==='all'?0:+aTab));
document.getElementById('addNote').addEventListener('click',()=>addNote(aTab==='all'?0:+aTab));
document.getElementById('addSample').addEventListener('click',()=>addSample(aTab==='all'?0:+aTab));
document.getElementById('addTape').addEventListener('click',()=>addTape(aTab==='all'?0:+aTab));
document.getElementById('addDrum').addEventListener('click',()=>addDrum(aTab==='all'?0:+aTab));
document.getElementById('addChord').addEventListener('click',()=>addChord(aTab==='all'?0:+aTab));
document.getElementById('addInst').addEventListener('click',()=>addInst(aTab==='all'?0:+aTab));
document.getElementById('addSave').addEventListener('click',()=>addSave());
document.getElementById('addEdit').addEventListener('click',()=>addEdit(aTab==='all'?0:+aTab));
document.getElementById('addFx').addEventListener('click',()=>addFx(aTab==='all'?0:+aTab));
document.getElementById('addMixer').addEventListener('click',()=>addMixer());

// === GLOBAL KEYS ===
window.addEventListener('keydown',e=>{if(e.repeat)return;if(e.code==='Space'){e.preventDefault();const any=chs.some(c=>c.on);if(any)chs.forEach((c,i)=>{if(c.on)stopCh(i)});else startCh(0);return}if(e.code==='Escape'){chs.forEach((c,i)=>stopCh(i));return}});

// === RECORDER — captures master output in real-time ===
let _rec={on:false,mr:null,dest:null,chunks:[],blob:null,url:null,startT:0,timer:null};
const recBtn=document.getElementById('recBtn'),dlBtn=document.getElementById('dlBtn'),recInd=document.getElementById('recInd'),recTime=document.getElementById('recTime');

recBtn.addEventListener('click',()=>{
  if(_rec.on){stopRec();return}
  initA();if(ctx.state==='suspended')ctx.resume();
  // create MediaStream from master output
  _rec.dest=ctx.createMediaStreamDestination();
  mGain.connect(_rec.dest);
  _rec.chunks=[];_rec.blob=null;if(_rec.url){URL.revokeObjectURL(_rec.url);_rec.url=null}
  dlBtn.style.display='none';
  _rec.mr=new MediaRecorder(_rec.dest.stream,{mimeType:'audio/webm;codecs=opus'});
  _rec.mr.ondataavailable=e=>{if(e.data.size>0)_rec.chunks.push(e.data)};
  _rec.mr.onstop=async()=>{
    mGain.disconnect(_rec.dest);
    _rec.blob=new Blob(_rec.chunks,{type:'audio/webm'});
    // convert to WAV for download
    const ab=await _rec.blob.arrayBuffer();
    const audioBuf=await ctx.decodeAudioData(ab);
    const wavBlob=bufToWav(audioBuf);
    _rec.url=URL.createObjectURL(wavBlob);
    dlBtn.style.display='';
  };
  _rec.mr.start(100);_rec.on=true;_rec.startT=Date.now();
  recBtn.style.background='#ef4444';recBtn.style.color='#fff';recBtn.textContent='■ STOP';
  recInd.style.display='flex';
  _rec.timer=setInterval(()=>{const s=Math.floor((Date.now()-_rec.startT)/1000);recTime.textContent=Math.floor(s/60)+':'+String(s%60).padStart(2,'0')},200);
});

function stopRec(){
  if(!_rec.on)return;_rec.on=false;
  _rec.mr.stop();clearInterval(_rec.timer);
  recBtn.style.background='';recBtn.style.color='#ef4444';recBtn.textContent='● REC';
  recInd.style.display='none';recTime.textContent='0:00';
}

dlBtn.addEventListener('click',()=>{
  if(!_rec.url)return;
  const a=document.createElement('a');a.href=_rec.url;
  a.download='studio-'+new Date().toISOString().slice(0,19).replace(/[T:]/g,'-')+'.wav';
  a.click();
});

function bufToWav(audioBuf){
  const nc=audioBuf.numberOfChannels,sr=audioBuf.sampleRate,len=audioBuf.length;
  const ba=nc*2,dl=len*ba,tl=44+dl;
  const w=new ArrayBuffer(tl),v=new DataView(w);
  function ws(o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))}
  ws(0,'RIFF');v.setUint32(4,tl-8,true);ws(8,'WAVE');ws(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nc,true);v.setUint32(24,sr,true);v.setUint32(28,sr*ba,true);v.setUint16(32,ba,true);v.setUint16(34,16,true);ws(36,'data');v.setUint32(40,dl,true);
  const cd=[];for(let c=0;c<nc;c++)cd.push(audioBuf.getChannelData(c));let o=44;
  for(let i=0;i<len;i++)for(let c=0;c<nc;c++){let s=Math.max(-1,Math.min(1,cd[c][i]));v.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2}
  return new Blob([w],{type:'audio/wav'});
}

// === SETTINGS ===
document.getElementById('settingsBtn').addEventListener('click',()=>{
  const p=document.getElementById('settingsPanel');p.style.display=p.style.display==='none'?'block':'none'});
document.addEventListener('click',e=>{const p=document.getElementById('settingsPanel');
  if(p.style.display!=='none'&&!p.contains(e.target)&&e.target.id!=='settingsBtn')p.style.display='none'});
const THEMES=[
  {name:'VOID',bg:'#08080c',surface:'#101015',s2:'#18181f',s3:'#202028',border:'#2a2a35',text:'#e0e0e8',dim:'#555568',dot:'rgba(255,255,255,.04)'},
  {name:'NEON BLEED',bg:'#0a0008',surface:'#14000f',s2:'#22001a',s3:'#330028',border:'#ff00aa30',text:'#ff88dd',dim:'#aa3388',dot:'rgba(255,0,170,.08)'},
  {name:'ACID',bg:'#020a00',surface:'#041400',s2:'#082200',s3:'#0c3300',border:'#00ff4430',text:'#00ff44',dim:'#009922',dot:'rgba(0,255,68,.08)'},
  {name:'BRUISE',bg:'#0c0418',surface:'#160828',s2:'#220e3e',s3:'#2e1454',border:'#8833ff40',text:'#c488ff',dim:'#7744bb',dot:'rgba(136,51,255,.08)'},
  {name:'RUST',bg:'#140800',surface:'#1e0e00',s2:'#2c1600',s3:'#3a1e00',border:'#ff660030',text:'#ff9944',dim:'#aa5500',dot:'rgba(255,102,0,.07)'},
  {name:'BLOOD',bg:'#140000',surface:'#200000',s2:'#300000',s3:'#440000',border:'#ff000030',text:'#ff4444',dim:'#aa2222',dot:'rgba(255,0,0,.07)'},
  {name:'ELECTRIC',bg:'#000814',surface:'#001028',s2:'#001a40',s3:'#002458',border:'#0088ff30',text:'#44bbff',dim:'#2266aa',dot:'rgba(0,136,255,.08)'},
  {name:'TOXIC',bg:'#0a0a00',surface:'#141400',s2:'#222200',s3:'#333300',border:'#ccff0030',text:'#ccff00',dim:'#88aa00',dot:'rgba(204,255,0,.07)'},
  {name:'STATIC',bg:'#0e0e0e',surface:'#1a1a1a',s2:'#262626',s3:'#333',border:'#ffffff18',text:'#fff',dim:'#888',dot:'rgba(255,255,255,.06)'},
  {name:'HEAT',bg:'#140004',surface:'#1e0008',s2:'#2c0010',s3:'#3e001a',border:'#ff224430',text:'#ff6688',dim:'#cc2244',dot:'rgba(255,34,68,.07)'},
  {name:'CYBER',bg:'#000a0c',surface:'#00141a',s2:'#001e28',s3:'#002836',border:'#00ffcc30',text:'#00ffcc',dim:'#00aa88',dot:'rgba(0,255,204,.07)'},
  {name:'GHOST',bg:'#0c0c10',surface:'#161620',s2:'#202030',s3:'#2a2a40',border:'#8888ff20',text:'#aaaadd',dim:'#5555aa',dot:'rgba(136,136,255,.05)'},
];
const tg=document.getElementById('themeGrid');
THEMES.forEach(t=>{const b=document.createElement('button');
  b.style.cssText=`width:100%;height:26px;border-radius:4px;border:2px solid ${t.border};cursor:pointer;background:linear-gradient(135deg,${t.bg},${t.surface});position:relative;transition:all .15s`;
  const l=document.createElement('span');l.style.cssText='font-size:5px;color:'+t.text+';font-weight:700;letter-spacing:.5px';l.textContent=t.name;
  b.appendChild(l);
  b.addEventListener('click',()=>{applyTheme(t);tg.querySelectorAll('button').forEach(x=>x.style.borderColor=THEMES.find(th=>th.name===x.textContent)?.border||'var(--border)');b.style.borderColor='#fff'});
  tg.appendChild(b)});
function applyTheme(t){const r=document.documentElement.style;
  r.setProperty('--bg',t.bg);r.setProperty('--surface',t.surface);r.setProperty('--s2',t.s2);r.setProperty('--s3',t.s3);
  r.setProperty('--border',t.border);r.setProperty('--text',t.text);r.setProperty('--dim',t.dim);
  document.getElementById('wsI').style.backgroundImage=`radial-gradient(circle,${t.dot} 1px,transparent 1px)`}
// dot style
const dg=document.getElementById('dotGrid');
[{name:'Dots',v:'radial-gradient(circle,var(--dot,rgba(255,255,255,.04)) 1px,transparent 1px)'},{name:'Lines',v:'repeating-linear-gradient(90deg,var(--dot,rgba(255,255,255,.04)) 0 1px,transparent 1px 24px)'},{name:'Cross',v:'repeating-linear-gradient(90deg,var(--dot,rgba(255,255,255,.03)) 0 1px,transparent 1px 24px),repeating-linear-gradient(0deg,var(--dot,rgba(255,255,255,.03)) 0 1px,transparent 1px 24px)'},{name:'None',v:'none'}].forEach(d=>{
  const b=document.createElement('button');b.className='pbtn';b.style.fontSize='5px';b.textContent=d.name;
  b.addEventListener('click',()=>{document.getElementById('wsI').style.backgroundImage=d.v});dg.appendChild(b)});
// accent colors
const ag=document.getElementById('accentGrid');
// workspace bg color
document.getElementById('wsBgColor').addEventListener('input',e=>{
  document.getElementById('wsI').style.backgroundColor=e.target.value;
  document.getElementById('workspace').style.backgroundColor=e.target.value});
const wsBgP=document.getElementById('wsBgPresets');
['#0a0a0f','#000000','#0a1628','#0a150e','#180a0a','#10081a','#1a0a0a','#0c1418',
 '#1a1020','#0e0800','#001010','#080016','#101010','#0d0d00','#000a0d','#100008'].forEach(c=>{
  const b=document.createElement('button');
  b.style.cssText='width:100%;height:14px;border-radius:2px;border:1px solid rgba(255,255,255,.1);cursor:pointer;background:'+c;
  b.addEventListener('click',()=>{document.getElementById('wsI').style.backgroundColor=c;document.getElementById('workspace').style.backgroundColor=c;document.getElementById('wsBgColor').value=c});
  wsBgP.appendChild(b)});
['#e8364f','#f97316','#fbbf24','#10b981','#22d3ee','#3b82f6','#8b5cf6','#ec4899','#06b6d4','#f43f5e'].forEach(c=>{
  const b=document.createElement('button');b.style.cssText=`width:100%;height:18px;border-radius:3px;border:2px solid transparent;cursor:pointer;background:${c};transition:all .15s`;
  b.addEventListener('click',()=>{document.documentElement.style.setProperty('--green',c);
    ag.querySelectorAll('button').forEach(x=>x.style.borderColor='transparent');b.style.borderColor='#fff'});ag.appendChild(b)});

document.getElementById('resetStudio').addEventListener('click',()=>{
  if(!confirm('Reset studio? All modules and patterns will be cleared.'))return;
  // stop all channels
  chs.forEach((ch,i)=>{ch.on=false;ch.step=0});
  // destroy all modules
  while(mods.length){const m=mods.pop();if(m.destroy)m.destroy();if(m.el&&m.el.parentNode)m.el.parentNode.removeChild(m.el)}
  mid=0;
  // reset theme
  applyTheme(THEMES[0]);
  document.documentElement.style.setProperty('--green','#10b981');
  document.getElementById('wsI').style.backgroundImage='radial-gradient(circle,rgba(255,255,255,.04) 1px,transparent 1px)';
  // close settings
  document.getElementById('settingsPanel').style.display='none';
  // spawn defaults
  addBeat(0);addMixer();
});

// === INIT ===
addBeat(0);addMixer();

// === MOBILE SUPPORT ===
// Global touch polyfill: makes keyboard keys, buttons, and interactive elements work on touch
// Maps touchstart→mousedown, touchend→mouseup on elements with mouse handlers
function addTouchPoly(root){
  // Keyboard keys (white and black)
  root.querySelectorAll('.key,.bkey').forEach(k=>{
    k.addEventListener('touchstart',e=>{e.preventDefault();
      k.dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
    },{passive:false});
    k.addEventListener('touchend',e=>{e.preventDefault();
      k.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
    },{passive:false});
    k.addEventListener('touchcancel',e=>{
      k.dispatchEvent(new MouseEvent('mouseup',{bubbles:true}));
    });
  });
  // Range sliders — make thumb easier to grab on touch
  root.querySelectorAll('input[type="range"]').forEach(r=>{
    r.style.touchAction='none';
  });
}
// Patch existing modules
document.querySelectorAll('.win').forEach(w=>addTouchPoly(w));
// Patch future modules via MutationObserver
const wsObs=new MutationObserver(muts=>{
  muts.forEach(m=>m.addedNodes.forEach(n=>{
    if(n.nodeType===1&&n.classList&&n.classList.contains('win'))addTouchPoly(n);
  }));
});
wsObs.observe(wsI,{childList:true});

// Prevent iOS long-press context menu on interactive elements
document.addEventListener('contextmenu',e=>{
  if(e.target.closest('.pk-w,.pk-b,.key,.bkey,.bstep,.wh,.pbtn,button'))e.preventDefault();
});
// Prevent rubber-band scroll on iOS
document.body.addEventListener('touchmove',e=>{
  if(!e.target.closest('.wbody')&&!e.target.closest('.workspace'))e.preventDefault();
},{passive:false});
</script>
</body></html>
